# é™æ€å†…å®¹éƒ¨ç½²åˆ° GitHub Pages çš„å®Œæ•´å·¥ä½œæµ
name: Deploy VitePress & Notify

# è§¦å‘æ¡ä»¶ï¼šæ¨é€è‡³ main/master åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: ['master', 'main']
  workflow_dispatch:

# å…¨å±€ç¯å¢ƒå˜é‡ä¸æƒé™
env:
  TZ: Asia/Shanghai
  NODE_ENV: production
  VITE_SSR: false
  __VUE_PROD_DEVTOOLS__: false
  HUSKY: 0 # ç¦ç”¨husky

permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶ï¼šåªå…è®¸ä¸€ä¸ªéƒ¨ç½²è¿›è¡Œ
concurrency:
  group: 'pages-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  # ä½œä¸šä¸€ï¼šæ„å»ºä¸éƒ¨ç½²
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [25] # æŒ‰æ‚¨çš„è¦æ±‚ä½¿ç”¨ Node 25

    # ç¯å¢ƒä¸æƒé™
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          lfs: false

      # 2. è®¾ç½® Node.js
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          architecture: 'x64'
          check-latest: true
          registry-url: 'https://registry.npmjs.org/'

      # 3. å®‰è£…ä¾èµ–ï¼ˆå…³é”®ä¿®å¤æ­¥éª¤ï¼‰
      - name: Install dependencies
        run: |
          echo "å®‰è£…æ ¸å¿ƒä¾èµ–"
          # å…ˆå¼ºåˆ¶å®‰è£…å¯¼è‡´é—®é¢˜çš„æ ¸å¿ƒåŒ…
          # npm install oxc-minify@latest --no-audit --no-fund --legacy-peer-deps
          # echo "æ­¥éª¤2: å®‰è£…å‰©ä½™ä¾èµ–..."
          # å†å®‰è£…å…¶ä½™ä¾èµ–ï¼Œä½¿ç”¨ --legacy-peer-deps é¿å…å†²çª
          npm install --legacy-peer-deps
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        env:
          HUSKY: 0

      # 4. æ„å»ºæ–‡æ¡£ï¼ˆè§£å†³å†…å­˜æº¢å‡ºï¼‰
      - name: Build docs
        run: |
          echo "å·¥ä½œç©ºé—´: ${{ github.workspace }}"
          # å…³é”®ï¼šå¢åŠ  Node.js å†…å­˜é™åˆ¶ä»¥é˜²æ­¢å †å†…å­˜æº¢å‡º
          NODE_OPTIONS="--max-old-space-size=4096" npm run docs:build
        env:
          NODE_ENV: production
          VITE_SSR: false
          

      # 5. è®¾ç½®å’Œéƒ¨ç½²åˆ° GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: .vitepress/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # 6. è¾“å‡ºéƒ¨ç½²ä¿¡æ¯ä¾›åç»­é€šçŸ¥ä½¿ç”¨
      - name: Prepare deployment output
        if: success()
        run: |
          echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
          echo "PAGE_URL=${{ steps.deployment.outputs.page_url }}" >> $GITHUB_ENV

      - name: Prepare failure output
        if: failure()
        run: |
          echo "DEPLOY_STATUS=failure" >> $GITHUB_ENV
          echo "PAGE_URL=" >> $GITHUB_ENV

  # ä½œä¸šäºŒï¼šé€šçŸ¥ï¼ˆä¾èµ– deploy ä½œä¸šï¼‰
  notify:
    name: ğŸ“¢ Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy] # ä¾èµ– deploy ä½œä¸š
    # æ— è®ºéƒ¨ç½²æˆåŠŸæˆ–å¤±è´¥éƒ½å‘é€é€šçŸ¥
    if: always()

    steps:
      # 1. å‡†å¤‡é€šçŸ¥æ•°æ®
      - name: Prepare notification data
        id: prepare-notification
        run: |
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          COMMIT_SHA_SHORT="${{ github.sha }}" && COMMIT_SHA_SHORT=${COMMIT_SHA_SHORT:0:7}
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # å¤„ç†å¯èƒ½çš„å¤šè¡Œæäº¤ä¿¡æ¯
          SINGLE_LINE_MSG=$(echo "$COMMIT_MSG" | head -n1 | sed 's/"/\\"/g')
          
          # ç¡®å®šçŠ¶æ€å’Œè¡¨æƒ…
          case $DEPLOY_RESULT in
            success)
              EMOJI="âœ…"
              STATUS_COLOR="#36a64f"
              STATUS_TEXT="æˆåŠŸ"
              ;;
            failure)
              EMOJI="âŒ"
              STATUS_COLOR="#ff0000"
              STATUS_TEXT="å¤±è´¥"
              ;;
            cancelled)
              EMOJI="âš ï¸"
              STATUS_COLOR="#ffaa00"
              STATUS_TEXT="å·²å–æ¶ˆ"
              ;;
            *)
              EMOJI="â“"
              STATUS_COLOR="#808080"
              STATUS_TEXT="æœªçŸ¥"
              ;;
          esac
          
          # å†™å…¥è¾“å‡ºå˜é‡
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "status_color=$STATUS_COLOR" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "commit_sha_short=$COMMIT_SHA_SHORT" >> $GITHUB_OUTPUT
          echo "commit_msg=$SINGLE_LINE_MSG" >> $GITHUB_OUTPUT
          echo "deploy_result=$DEPLOY_RESULT" >> $GITHUB_OUTPUT

      # 2. ç”Ÿæˆ GitHub Actions ä½œä¸šæ‘˜è¦ï¼ˆæ€»åœ¨è¿è¡Œç•Œé¢æ˜¾ç¤ºï¼‰
      - name: Create GitHub Summary
        run: |
          echo "## ${{ steps.prepare-notification.outputs.emoji }} éƒ¨ç½²é€šçŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€**: **${{ steps.prepare-notification.outputs.status_text }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: \`${{ steps.prepare-notification.outputs.commit_sha_short }}\` - ${{ steps.prepare-notification.outputs.commit_msg }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.triggering_actor || github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµ**: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.prepare-notification.outputs.deploy_result }}" == "success" ]]; then
            echo "### ğŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
            echo "ç½‘ç«™å·²å‘å¸ƒè‡³ï¼š[**${{ needs.deploy.outputs.PAGE_URL }}**](${{ needs.deploy.outputs.PAGE_URL }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â— åç»­æ“ä½œ" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥ **deploy** ä½œä¸šçš„æ—¥å¿—ä»¥æ’æŸ¥é”™è¯¯ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      # 3. (å¯é€‰) Slack é€šçŸ¥
      - name: Send Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [
              {
                "color": "${{ steps.prepare-notification.outputs.status_color }}",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "${{ steps.prepare-notification.outputs.emoji }} VitePress éƒ¨ç½² ${{ steps.prepare-notification.outputs.status_text }}"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*ä»“åº“*\n`${{ github.repository }}`"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*åˆ†æ”¯*\n`${{ github.ref_name }}`"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*æäº¤*\n`${{ steps.prepare-notification.outputs.commit_sha_short }}`"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*çŠ¶æ€*\n${{ steps.prepare-notification.outputs.status_text }}"
                      }
                    ]
                  }
                  ${{ needs.deploy.result == 'success' && format(', {0} {1}', '{ "type": "section", "text": { "type": "mrkdwn", "text": "*ğŸŒ è®¿é—®åœ°å€*\\n<{0}|{0}>" } }', needs.deploy.outputs.PAGE_URL) || '' }}
                ]
              }
            ]
          }' $SLACK_WEBHOOK_URL

      # 4. (å¯é€‰) Discord é€šçŸ¥
      - name: Send Discord Notification
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          COLOR_NUM=$(echo "${{ steps.prepare-notification.outputs.status_color }}" | sed 's/#//g')
          COLOR_DEC=$((16#$COLOR_NUM))
          
          curl -H "Content-Type: application/json" -X POST -d '{
            "embeds": [{
              "title": "ğŸš€ VitePress éƒ¨ç½² ${{ steps.prepare-notification.outputs.status_text }}",
              "description": "**ä»“åº“**: ${{ github.repository }}\\n**åˆ†æ”¯**: `${{ github.ref_name }}`",
              "color": '$COLOR_DEC',
              "fields": [
                {
                  "name": "æäº¤",
                  "value": "`${{ steps.prepare-notification.outputs.commit_sha_short }}` - ${{ steps.prepare-notification.outputs.commit_msg }}",
                  "inline": false
                },
                {
                  "name": "çŠ¶æ€",
                  "value": "${{ steps.prepare-notification.outputs.emoji }} ${{ steps.prepare-notification.outputs.status_text }}",
                  "inline": true
                },
                {
                  "name": "è§¦å‘è€…",
                  "value": "${{ github.triggering_actor || github.actor }}",
                  "inline": true
                }
                ${{ needs.deploy.result == 'success' && format(', {0} {1}', '{ "name": "è®¿é—®åœ°å€", "value": "[ç‚¹å‡»è®¿é—®]({0})", "inline": false }', needs.deploy.outputs.PAGE_URL) || '' }}
              ],
              "footer": {
                "text": "GitHub Actions â€¢ ${{ github.workflow }}"
              },
              "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")'"
            }]
          }' $DISCORD_WEBHOOK_URL

      # 5. (å¯é€‰) é‚®ä»¶é€šçŸ¥ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
      - name: Send Email on Failure
        if: failure() && env.EMAIL_TO != ''
        run: |
          echo -e "ä¸»é¢˜ï¼š${{ steps.prepare-notification.outputs.emoji }} VitePress éƒ¨ç½²å¤±è´¥ - ${{ github.repository }}\n\néƒ¨ç½²å·¥ä½œæµå¤±è´¥ã€‚\n\nä»“åº“ï¼š${{ github.repository }}\nåˆ†æ”¯ï¼š${{ github.ref_name }}\næäº¤ï¼š${{ steps.prepare-notification.outputs.commit_sha_short }}\nè§¦å‘è€…ï¼š${{ github.actor }}\nå·¥ä½œæµé“¾æ¥ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" | mail -s "${{ steps.prepare-notification.outputs.emoji }} VitePress éƒ¨ç½²å¤±è´¥ - ${{ github.repository }}" $EMAIL_TO
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}

      # 6. æœ€ç»ˆçŠ¶æ€è¾“å‡º
      - name: Final notification status
        run: |
          echo "========================================"
          echo "é€šçŸ¥ä½œä¸šå®Œæˆ"
          echo "éƒ¨ç½²ç»“æœ: ${{ steps.prepare-notification.outputs.deploy_result }}"
          echo "æ‘˜è¦å·²ç”Ÿæˆè‡³ GitHub Actions ç•Œé¢"
          echo "========================================"
