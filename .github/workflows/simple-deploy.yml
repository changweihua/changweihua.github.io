# Simple workflow for deploying static content to GitHub Pages
name: Deploy static content to Pages

on:
  push:
    branches: ['main', 'master']
  workflow_dispatch:

# è®¾ç½®æ—¶åŒº
env:
  TZ: Asia/Shanghai
  # ç¦ç”¨ husky
  HUSKY: 0
  # ç¦ç”¨ git hooks
  GIT_LFS_SKIP_SMUDGE: 1
  # æ„å»ºç¯å¢ƒ
  NODE_ENV: production
  VITE_SSR: false
  __VUE_PROD_DEVTOOLS__: false

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: 'pages-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  # æ„å»ºå’Œéƒ¨ç½²ä½œä¸š
  build-and-deploy:
    runs-on: ubuntu-latest

    # node v25 è¿è¡Œ
    strategy:
      matrix:
        node-version: [25]

    permissions:
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # ä¿ç•™ Git ä¿¡æ¯
          fetch-depth: 0
          # ç¦ç”¨ LFSï¼Œå‡å°‘é—®é¢˜
          lfs: false

      # è®¾ç½®ä½¿ç”¨ Node.js ç‰ˆæœ¬
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          architecture: 'x64'
          check-latest: true
          # ä½¿ç”¨ç¼“å­˜åŠ é€Ÿæ„å»º
          cache: 'npm'
          registry-url: https://registry.npmjs.org/

      # é…ç½® git ç¯å¢ƒ
      - name: Configure git for CI
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # ç¦ç”¨ git hooks
          git config --global core.hooksPath /dev/null

      # å®‰è£…ä¾èµ– - ä½¿ç”¨ legacy-peer-deps å‚æ•°
      - name: Install dependencies
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§ä¾èµ–..."
          rm -rf node_modules
          
          echo "ğŸ“¦ å®‰è£…æ ¸å¿ƒä¾èµ–..."
          # å…ˆå®‰è£… vitepress å’Œ oxc-minify
          npm install vitepress oxc-minify @rolldown/node-binding-wasm --legacy-peer-deps --save-dev
          
          echo "ğŸ“¦ å®‰è£…å…¶ä»–ä¾èµ–..."
          # ä½¿ç”¨ legacy-peer-deps å‚æ•°è§£å†³ä¾èµ–å†²çª
          npm install --legacy-peer-deps --ignore-scripts --no-audit --no-fund
          
          echo "âœ… éªŒè¯å®‰è£…..."
          npm list vitepress oxc-minify --depth=0
          
        env:
          HUSKY: 0
          npm_config_ignore_scripts: true

      - name: Build docs
        run: |
          echo "ğŸ—ï¸ æ„å»ºæ–‡æ¡£..."
          echo "å·¥ä½œç›®å½•: ${{ github.workspace }}"
          npm run docs:build
          
          # éªŒè¯æ„å»ºè¾“å‡º
          echo "âœ… éªŒè¯æ„å»ºç»“æœ..."
          if [ -d ".vitepress/dist" ]; then
            echo "æ„å»ºæˆåŠŸï¼è¾“å‡ºç›®å½•: .vitepress/dist"
            echo "æ€»æ–‡ä»¶æ•°: $(find .vitepress/dist -type f | wc -l)"
          else
            echo "âŒ æ„å»ºå¤±è´¥: .vitepress/dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .vitepress/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      # è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      - name: Record deployment info
        run: |
          echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **è®¿é—®åœ°å€**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¯ **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "â° **éƒ¨ç½²æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY

  # é€šçŸ¥ä½œä¸š
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½å‘é€é€šçŸ¥
    
    steps:
      # å‡†å¤‡é€šçŸ¥å†…å®¹
      - name: Prepare notification data
        id: prepare-notification
        run: |
          DEPLOYMENT_STATUS="${{ needs.build-and-deploy.result }}"
          BRANCH="${{ github.ref_name }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MESSAGE="$(echo '${{ github.event.head_commit.message }}' | head -50)"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          DEPLOYMENT_URL="${{ needs.build-and-deploy.outputs.page_url }}"
          
          # æ ¹æ®çŠ¶æ€è®¾ç½®æ¶ˆæ¯
          if [ "$DEPLOYMENT_STATUS" = "success" ]; then
            EMOJI="âœ…"
            STATUS_TEXT="æˆåŠŸ"
            COLOR="green"
          elif [ "$DEPLOYMENT_STATUS" = "failure" ]; then
            EMOJI="âŒ"
            STATUS_TEXT="å¤±è´¥"
            COLOR="red"
          elif [ "$DEPLOYMENT_STATUS" = "cancelled" ]; then
            EMOJI="âš ï¸"
            STATUS_TEXT="å·²å–æ¶ˆ"
            COLOR="yellow"
          else
            EMOJI="â“"
            STATUS_TEXT="æœªçŸ¥"
            COLOR="gray"
          fi
          
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "status=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "workflow_url=$WORKFLOW_URL" >> $GITHUB_OUTPUT
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT

      # åœ¨ GitHub Actions ä¸­æ˜¾ç¤ºé€šçŸ¥æ‘˜è¦
      - name: Create notification summary
        run: |
          echo "# ${{ steps.prepare-notification.outputs.emoji }} éƒ¨ç½²é€šçŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## éƒ¨ç½²çŠ¶æ€: **${{ steps.prepare-notification.outputs.status }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ steps.prepare-notification.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ steps.prepare-notification.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ä¿¡æ¯**: ${{ steps.prepare-notification.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµè¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](${{ steps.prepare-notification.outputs.workflow_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
            echo "### ğŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
            echo "ç½‘ç«™å·²éƒ¨ç½²åˆ°: [${{ steps.prepare-notification.outputs.deployment_url }}](${{ steps.prepare-notification.outputs.deployment_url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â— éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥å·¥ä½œæµè¿è¡Œæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      # Slack é€šçŸ¥ç¤ºä¾‹ï¼ˆéœ€è¦é…ç½® SLACK_WEBHOOK_URL secretï¼‰
      - name: Send Slack notification (optional)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ steps.prepare-notification.outputs.emoji }} VitePress éƒ¨ç½² ${{ steps.prepare-notification.outputs.status }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*åˆ†æ”¯:*\\n${{ steps.prepare-notification.outputs.branch }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*çŠ¶æ€:*\\n${{ steps.prepare-notification.outputs.status }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*æäº¤:*\\n${{ steps.prepare-notification.outputs.commit_sha }}"
                  }
                ]
              }
            ]
          }' $SLACK_WEBHOOK_URL

      # Discord é€šçŸ¥ç¤ºä¾‹ï¼ˆéœ€è¦é…ç½® DISCORD_WEBHOOK_URL secretï¼‰
      - name: Send Discord notification (optional)
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "ğŸš€ VitePress éƒ¨ç½² ${{ steps.prepare-notification.outputs.status }}",
              "description": "GitHub Pages éƒ¨ç½²å·²å®Œæˆ",
              "color": 65280,
              "fields": [
                {
                  "name": "åˆ†æ”¯",
                  "value": "${{ steps.prepare-notification.outputs.branch }}",
                  "inline": true
                },
                {
                  "name": "çŠ¶æ€",
                  "value": "${{ steps.prepare-notification.outputs.status }}",
                  "inline": true
                },
                {
                  "name": "æäº¤",
                  "value": "${{ steps.prepare-notification.outputs.commit_sha }}",
                  "inline": false
                }
              ],
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%S.000Z')"
            }]
          }' $DISCORD_WEBHOOK_URL

      # é‚®ä»¶é€šçŸ¥ç¤ºä¾‹ï¼ˆä½¿ç”¨ GitHub Actions å†…ç½®é‚®ä»¶ï¼‰
      - name: Send email notification (optional)
        if: failure()  # åªåœ¨å¤±è´¥æ—¶å‘é€é‚®ä»¶
        run: |
          echo "éƒ¨ç½²å¤±è´¥é€šçŸ¥" | mail -s "ğŸš¨ VitePress éƒ¨ç½²å¤±è´¥ - ${{ github.repository }}" ${{ secrets.EMAIL_TO }}
        env:
          # éœ€è¦åœ¨ Secrets ä¸­é…ç½® EMAIL_SERVER, EMAIL_USER, EMAIL_PASSWORD, EMAIL_TO
          # æˆ–è€…ä½¿ç”¨ GitHub Actions çš„å†…ç½®é‚®ä»¶åŠŸèƒ½

      # æœ€ç»ˆçŠ¶æ€è¾“å‡º
      - name: Final status
        run: |
          echo "=========================================="
          echo "éƒ¨ç½²ä½œä¸šçŠ¶æ€: ${{ needs.build-and-deploy.result }}"
          echo "é€šçŸ¥ä½œä¸šå·²å®Œæˆ"
          echo "=========================================="
