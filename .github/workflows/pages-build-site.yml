name: Deploy VitePress Documentation

on:
  push:
    branches: [master2]
  workflow_dispatch:

env:
  NODE_ENV: production
  HUSKY: 0
  # å¯é€‰ï¼šå¦‚æœåœ¨ä¸­å›½å¤§é™†ï¼Œå¯ä»¥è®¾ç½® npm é•œåƒåŠ é€Ÿ
  # npm_config_registry: https://registry.npmmirror.com/

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          # æ˜ç¡®ç¦ç”¨ç¼“å­˜
          # cache: 'none'

      # 3. æ¸…ç†å¹¶å®‰è£…ä¾èµ–ï¼ˆé‡ç‚¹å¤„ç† oxc-minifyï¼‰
      - name: Install dependencies
        run: |
          echo "Cleaning up previous installations..."
          rm -rf node_modules
          
          echo "Installing dependencies..."
          # ä½¿ç”¨å®Œæ•´å®‰è£…ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½æ­£ç¡®å®‰è£…
          npm install --legacy-peer-deps --no-audit --no-fund
          
          # ç¡®ä¿ oxc-minify å·²å®‰è£…
          echo "Checking for oxc-minify..."
          if ! npm list oxc-minify 2>/dev/null | grep -q "oxc-minify"; then
            echo "oxc-minify not found, installing it..."
            npm install oxc-minify@latest --save-dev
          fi
          
          # ç¡®ä¿ rolldown ç›¸å…³åŒ…å·²å®‰è£…
          echo "Checking for @rolldown/node-binding-wasm..."
          if ! npm list @rolldown/node-binding-wasm 2>/dev/null | grep -q "@rolldown/node-binding-wasm"; then
            echo "@rolldown/node-binding-wasm not found, installing it..."
            npm install @rolldown/node-binding-wasm@latest --save-dev
          fi
          
          echo "Verifying installation..."
          npm list vitepress oxc-minify @rolldown/node-binding-wasm --depth=0
          
        env:
          HUSKY: 0  # ç¦ç”¨ husky

      # 4. æ„å»º VitePress æ–‡æ¡£
      - name: Build documentation
        run: |
          echo "Building VitePress documentation..."
          npm run docs:build
          
          # éªŒè¯æ„å»ºè¾“å‡º
          if [ -d ".vitepress/dist" ]; then
            echo "Build successful! Output directory: .vitepress/dist"
            echo "Files in dist:"
            ls -la .vitepress/dist/ | head -10
          else
            echo "ERROR: Build output not found!"
            exit 1
          fi

      # 5. é…ç½®å’Œéƒ¨ç½²åˆ° GitHub Pages
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .vitepress/dist
          # å¯é€‰ï¼šè®¾ç½®ä¿ç•™æ—¶é—´
          retention-days: 1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # 6. æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
      - name: Show deployment URL
        run: |
          echo "âœ… Deployment completed!"
          echo "ğŸŒ Your site is live at: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployment time: $(date)"





