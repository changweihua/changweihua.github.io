---
outline: false
aside: false
layout: doc
date: 2025-05
title: BFFå»ºè®¾â€”â€” Fastify
description: BFFå»ºè®¾â€”â€” Fastify
category: æ–‡æ¡£
pageClass: manual-page-class
---

# BFFå»ºè®¾â€”â€” Fastify #

> ä¸ºä»€ä¹ˆè¦ç”¨BFFï¼ˆBackend for Frontendï¼‰ï¼Ÿä»¥åŠBFFå’Œåœ¨layouté‡Œé¢å¤„ç†æ•°æ®çš„åŒºåˆ«

## æœ¬è´¨åŒºåˆ«æ€»ç»“ ##

|  æ¯”è¾ƒç»´åº¦  |  layout ä¸­å¤„ç†  |  BFF ä¸­å¤„ç†  |  æè¿°  |
|  :---  |  :----:  |  :---  |   :---  |
| ä½ç½® | å®¢æˆ·ç«¯æˆ– SSR ç»„ä»¶å†…éƒ¨ï¼ˆå¦‚ `layout.tsx`, `page.tsx`ï¼‰ | Node.js æœåŠ¡ä¸­é—´å±‚ï¼ˆå¦‚ Fastifyï¼‰ |  |
| ä½œç”¨æ—¶æœº | é¡µé¢æ¸²æŸ“å‰ï¼ˆServer/Clientï¼‰ | è¯·æ±‚å‰æˆ–è¯·æ±‚èšåˆæ—¶ |  |
| èƒ½å¤„ç†çš„å†…å®¹ | é¡µé¢æ¸²æŸ“é€»è¾‘ã€å±•ç¤ºé€»è¾‘ã€è½»é‡ fetch | æ¥å£èšåˆã€æƒé™æ ¡éªŒã€æ•°æ®é¢„å¤„ç†ã€ç¼“å­˜ã€è½¬å‘ç­‰ |  |
| é€‚åˆå¤„ç† | å•ä¸ª API è¯·æ±‚ã€UI å±‚çº§é€»è¾‘ | å¤šæ¥å£èšåˆã€å¤æ‚ token éªŒè¯ã€å¾®æœåŠ¡èšåˆ |  |
| å¯é‡ç”¨æ€§ | ä½ï¼Œä¸šåŠ¡è€¦åˆåœ¨ç»„ä»¶ä¸­ | é«˜ï¼Œå¯å¤ç”¨å¤šä¸ªé¡µé¢å’Œå‰ç«¯åº”ç”¨ |  |
| å®‰å…¨æ€§ | æ•°æ®æš´éœ²é£é™©é«˜ | å¯éšè—çœŸå® APIï¼Œå®ç°å®‰å…¨ä»£ç† |  |


## å…¸å‹åœºæ™¯å¯¹æ¯” ##

## layout.tsx ä¸­å¤„ç†çš„é€‚åˆåœºæ™¯ ##

é€‚åˆä¸­å°å‹é¡¹ç›®ï¼Œæ•°æ®ç»“æ„ç®€å•ï¼Œä¸éœ€è¦èšåˆæˆ–è½¬å‘ã€‚

```ts
// app/layout.tsx
export default async function RootLayout({ children }) {
  const user = await getUserFromSession(); // ä» cookie/session æ‹¿ç”¨æˆ·ä¿¡æ¯
  return (
    <html>
      <body>
        <Sidebar user={user} />
        {children}
      </body>
    </html>
  );
}
```

- åªè®¿é—®å•ä¸€æ¥å£
- SSR è·å–æ•°æ®ç”¨äºåˆå§‹åŒ–é¡µé¢
- ä¸æ¶‰åŠå¤šæœåŠ¡èšåˆã€å¤æ‚éªŒè¯


### ä½¿ç”¨ BFF çš„é€‚åˆåœºæ™¯ ###

é€‚åˆå¤æ‚ç³»ç»Ÿã€æ¥å£æ•°é‡å¤šã€æƒé™æ§åˆ¶å¤æ‚ã€åç«¯æœåŠ¡åˆ†æ•£ï¼ˆå¾®æœåŠ¡ï¼‰åœºæ™¯ã€‚

```ts
// Fastify è·¯ç”±èšåˆ
fastify.get('/api/home', async (req, reply) => {
  const [user, dashboardData] = await Promise.all([
    getUser(req.headers.token),
    fetchDashboardInfo(),
  ]);
  return { user, dashboardData };
});
```

- èšåˆå¤šä¸ªåç«¯æ¥å£
- åšæƒé™æ ¡éªŒã€token æ ¡éªŒ
- æœåŠ¡è½¬å‘ï¼ˆä»£ç†å…¶ä»–æœåŠ¡ï¼‰
- éšè—åç«¯çœŸå®åœ°å€
- å®ç°ç¼“å­˜ã€æ—¥å¿—ç­‰ç»Ÿä¸€ä¸­é—´ä»¶é€»è¾‘

### å¦‚æœä½ åœ¨ layout.tsx ä¸­åšè¿™äº›ï¼Œä¼šé‡åˆ°çš„é—®é¢˜ ###

- å¤šæ¥å£è°ƒç”¨åˆ†æ•£åœ¨é¡µé¢é‡Œï¼Œé€»è¾‘é‡å¤
- æ— æ³•å®ç°ç»Ÿä¸€ token æ ¡éªŒï¼ˆéœ€è¦æ¯ä¸ªç»„ä»¶å¤„ç†ï¼‰
- API æ›éœ²ï¼Œå‰ç«¯è¯·æ±‚ç›´æ¥æš´éœ²çœŸå®åç«¯åœ°å€
- æœåŠ¡é—´ä¾èµ–å¼ºï¼Œåç«¯ç»“æ„å˜åŒ–ä¼šå½±å“å‰ç«¯

åœ¨ Next.js ä¸­æ˜¯å¦æœ‰å¿…è¦åš BFFï¼ˆBackend for Frontendï¼‰è½¬å‘ï¼Œä¸»è¦å–å†³äºä½ çš„ä¸šåŠ¡å¤æ‚åº¦ã€ç³»ç»Ÿæ¶æ„ï¼Œä»¥åŠå‰åç«¯èŒè´£è¾¹ç•Œã€‚*layout æ›´é€‚åˆåšé¡µé¢åˆå§‹åŒ–ä¸ UI é€»è¾‘ï¼Œè€Œ BFF æ˜¯åç«¯æœåŠ¡çš„æŠ½è±¡ä¸èšåˆï¼Œä¸¤è€…å…³æ³¨ç‚¹ä¸åŒ*ã€‚

å®ƒä¸æ˜¯é¸¡è‚‹ï¼Œè€Œæ˜¯åœ¨*å¤æ‚åº”ç”¨åœºæ™¯ä¸‹éå¸¸å®ç”¨çš„ä¸€ç§æ¶æ„æ¨¡å¼*ã€‚

### å¸¸è§çš„ Node.js Web æ¡†æ¶ç®€å•å¯¹æ¯”ä¸€ä¸‹ï¼Œå…·ä½“ä¸é˜è¿° ###

```txt
Node.js ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç   â”œâ”€â”€ Express  ï¼ˆä¼ ç»Ÿè€ç‰Œï¼Œç®€å•å¿«é€Ÿï¼‰
  â”œâ”€â”€ Fastify  ï¼ˆæé€Ÿé«˜æ€§èƒ½ï¼Œæ¥å£é¡¹ç›®ç¥å™¨ï¼‰
  â”œâ”€â”€ Koa      ï¼ˆæç®€æ ¸å¿ƒï¼Œè‡ªç”±åº¦é«˜ï¼‰
  â””â”€â”€ NestJS   ï¼ˆå¤§å‹å·¥ç¨‹æ ‡å‡†ï¼Œä¼ä¸šçº§é¡¹ç›®ï¼‰
```

## æˆ‘ä»¬æœ¬æ¬¡ä½¿ç”¨Fastify ##

### ä»€ä¹ˆæ—¶å€™æ¨èä½¿ç”¨ Fastify æ­é… Next.jsï¼Ÿ ###

|  åœºæ™¯  |  æ˜¯å¦æ¨èä½¿ç”¨ Fastify  |
|  :---  |  :---  |
| éœ€è¦è‡ªå®šä¹‰åç«¯æ¥å£ï¼ˆé Next API è·¯ç”±ï¼‰ | âœ… æ¨è |
| éœ€è¦ç»Ÿä¸€ä¸­é—´ä»¶å¤„ç†é€»è¾‘ï¼ˆå¦‚ token æ ¡éªŒã€æ—¥å¿—ï¼‰ | âœ… æ¨è |
| å¾®æœåŠ¡æ¶æ„ï¼šéœ€è¦åšæœåŠ¡èšåˆ / è½¬å‘ | âœ… æ¨è |
| å¯¹æ€§èƒ½è¦æ±‚æé«˜ | âœ… æ¨èï¼ˆFastify æ€§èƒ½é«˜ï¼‰ |
| æƒ³è¦å°† Next.js èå…¥å·²æœ‰ Node.js/Fastify é¡¹ç›® | âœ… æ¨è |
| åªåšå‰ç«¯é¡µé¢å±•ç¤º | âŒ ä¸æ¨èï¼ˆé¸¡è‚‹ï¼‰ |


### ä½¿ç”¨ Fastify + Next.js çš„ä¼˜ç‚¹ ###

|  ä¼˜ç‚¹  |  è¯´æ˜  |
|  :---  |  :---  |
|  ğŸ’¨ æ€§èƒ½å¥½  |  Fastify æ˜¯ç›®å‰æœ€å¿«çš„ Node.js æ¡†æ¶ä¹‹ä¸€ï¼Œå“åº”æ›´å¿«  |
|  ğŸ§© çµæ´»æ‹“å±•  |  å¯ä»¥è½»æ¾æŒ‚è½½ç¬¬ä¸‰æ–¹æ’ä»¶ï¼ˆå¦‚è®¤è¯ã€æ—¥å¿—ã€é™æµï¼‰  |
|  ğŸ”Œ æ”¯æŒå¾®æœåŠ¡  |  å¯ä»¥ä½œä¸º API ç½‘å…³ä½¿ç”¨ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°å…¶ä»–æœåŠ¡  |
|  ğŸ§  æ›´å¥½çš„æ§åˆ¶  |  å¯ä»¥æ§åˆ¶è¯·æ±‚ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚è¯·æ±‚å‰æ ¡éªŒã€åŸ‹ç‚¹ç­‰  |
|  ğŸ§° å’Œä¼ ç»Ÿåç«¯æ›´å…¼å®¹  |  æ›´åƒçœŸå®åç«¯æ¡†æ¶ï¼Œä¾¿äºå’Œå…¶ä»–æœåŠ¡å¯¹æ¥  |


### ä½¿ç”¨ Fastify çš„ç¼ºç‚¹ ###

|  ç¼ºç‚¹  |  è¯´æ˜  |
|  :---  |  :---  |
|  ğŸ§± å¢åŠ å¤æ‚åº¦  |  ä½ å¾—å†™è‡ªå®šä¹‰æœåŠ¡è„šæœ¬`server.js`ï¼Œéƒ¨ç½²æ–¹å¼ä¹Ÿå˜äº†  |
|  ğŸ API è·¯ç”±ä¸èƒ½å…±ç”¨  |  Fastify å’Œ Next çš„ API è·¯ç”±æ˜¯åˆ†å¼€çš„ï¼ˆé‡å¤å†™ APIï¼‰  |
|  âš ï¸ éœ€è¦ç®¡ç†åŸå§‹ req/res  |  Fastify æ˜¯å°è£…çš„ï¼ŒNext.js éœ€è¦åŸç”Ÿ req.rawï¼Œå®¹æ˜“å‡ºé”™  |
|  ğŸ› ï¸ ç¼–å†™è°ƒè¯•æ›´å¤æ‚  |  ä¸å¦‚ç›´æ¥ next dev å¯åŠ¨æ¥å¾—ç®€å•ç›´æ¥  |


> ğŸ§  æ€»ç»“ä¸€å¥è¯ï¼šå¦‚æœä½ åªåšé¡µé¢æ¸²æŸ“ï¼Œä¸æ¶‰åŠå¤æ‚åç«¯é€»è¾‘ï¼ŒFastify æ˜¯é¸¡è‚‹ï¼›ä½†å¦‚æœä½ éœ€è¦è‡ªå®šä¹‰ APIã€é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡ã€æ€§èƒ½ä¼˜åŒ–æˆ–æ„å»º BFF å±‚ï¼Œé‚£ Fastify æ˜¯å¾ˆå¥½çš„æ­æ¡£ã€‚


## NextJSä¸­ä½¿ç”¨ Fastify ##

NextJSæœ‰ä¸¤ä¸ªæ¨¡å¼Pages Router å’Œ App Routerï¼Œä¸ç®¡æ˜¯ Pages Router è¿˜æ˜¯ App Routerï¼ŒNext.js éƒ½éœ€è¦ä¸€ä¸ª Node æœåŠ¡æ¥è¿è¡Œï¼ŒFastifyå¯ä»¥åŒ…è£¹å®ƒï¼Œä½†ä¸èƒ½ç›´æ¥æ‹¿ Fastifyå®Œå…¨æ›¿ä»£ Next.js è‡ªå¸¦ Serverã€‚æ‰€ä»¥ï¼š

- ä¸èƒ½**ç›´æ¥åªè·‘ Fastify**ã€‚
- è¦ä¹ˆç”¨**Fastify åŒ…è£¹ Next.js**ï¼Œåšæˆä¸€ä¸ªç»Ÿä¸€çš„ Node åº”ç”¨ã€‚
- è¦ä¹ˆ**Fastify è·‘è‡ªå·±çš„ APIï¼ŒNext.js è·‘è‡ªå·±çš„é¡µé¢æœåŠ¡**ï¼ˆä¸¤å¥—æœåŠ¡ï¼‰ã€‚

æˆ‘ä»¬æœ¬æ¬¡åšçš„æ˜¯ç”¨**Fastify åŒ…è£¹ Next.js**ï¼Œä¸€å¼ æµç¨‹å›¾è§£é‡Šä¸€ä¸‹ï¼Œ

```txt
[æµè§ˆå™¨è®¿é—®]
       â†“
[Fastify Server]
       â†“
[Next.js å¤„ç†é¡µé¢æˆ–API]
```

### æ“ä½œæ­¥éª¤ ###

#### å…ˆå®‰è£…ä¾èµ– ###

```bash
npm install fastify
```

#### æ–°å»ºä¸€ä¸ª `server.js` æ–‡ä»¶ï¼ˆæ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼‰ ####

```js
// server.js
const Fastify = require('fastify');
const Next = require('next');

const port = parseInt(process.env.PORT, 10) || 3000;
const dev = process.env.NODE_ENV !== 'production';
const app = Next({ dev });
const handle = app.getRequestHandler();

const fastify = Fastify({
  logger: true,
  maxParamLength: 5000
});

async function start() {
  await app.prepare();

  // å¤„ç† Next.js é¡µé¢è¯·æ±‚
  fastify.all('/*', async (request, reply) => {
    await handle(request.raw, reply.raw);
    reply.sent = true;
  });

  try {
    await fastify.listen({ port });
    console.log(`> Ready on http://localhost:${port}`);
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
}

start();
```

> æ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ `request.raw` å’Œ `reply.raw`ï¼Œå› ä¸º Next.js åŸæœ¬åŸºäº Node.js `req` å’Œ `res`ã€‚

#### ä¿®æ”¹ `package.json` çš„ `start` è„šæœ¬ ####

æŠŠå¯åŠ¨å‘½ä»¤æ”¹æˆç”¨ `node server.js`ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ `next start`ï¼š

```json
"scripts": {
  "dev": "next dev",
  "build": "next build",
  "start": "NODE_ENV=production node server.js"
}
```

å¼€å‘ç¯å¢ƒä½ å¯ä»¥ç›´æ¥ `next dev`ï¼Œç”Ÿäº§ç¯å¢ƒå°±èµ° Fastify æ¥ç®¡ã€‚

#### é¡¹ç›®ç›®å½•ç»“æ„ç¤ºä¾‹ï¼ˆå‡è®¾ä½ ç”¨ App Routerï¼‰ ####

```txt
/app
  /page.tsx
  /api/xxx/route.ts
/public
/server.js
/package.json
/next.config.js
...
```
