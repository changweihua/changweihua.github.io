---
layout: doc
# å¼€å¯æ¨è
recommended: true
mermaids: 1
pageClass: gallery-page-class
---

## å¾®å‰ç«¯ç®€ä»‹ ##

å¾®å‰ç«¯æ˜¯å¾®æœåŠ¡æ¦‚å¿µåœ¨å‰ç«¯çš„åº”ç”¨ã€‚åœ¨å¾®å‰ç«¯æ¶æ„ä¸‹ï¼Œä¸€ä¸ªå¤§å‹å•ä¸€çš„å‰ç«¯åº”ç”¨è¢«æ‹†åˆ†æˆå¤šä¸ªå°å‹ã€ç‹¬ç«‹çš„å­åº”ç”¨ï¼Œè¿™äº›å­åº”ç”¨å¯ä»¥**ç‹¬ç«‹å¼€å‘**ã€**ç‹¬ç«‹éƒ¨ç½²**ã€**ç‹¬ç«‹è¿è¡Œ**ï¼Œä»è€Œå¸¦æ¥æ›´åŠ çµæ´»é«˜æ•ˆçš„é¡¹ç›®å¼€å‘å’Œç®¡ç†ï¼Œä½†åœ¨ç”¨æˆ·çœ‹æ¥ä»ç„¶æ˜¯å†…èšçš„å•ä¸ªäº§å“ã€‚

> An architectural style where independently deliverable frontend applications are composed into a greater whole.

ä½œä¸ºç°ä»£å‰ç«¯å¼€å‘çš„è¶‹åŠ¿ï¼Œè®¸å¤šä¼ä¸šçš„æŠ€æœ¯æ ˆèå…¥äº†å¾®å‰ç«¯ï¼Œæœ‰äº›æ˜¯é€‰æ‹©æˆç†Ÿçš„æ¡†æ¶å¦‚ Qiankunã€Micro-App æˆ– Single-SPAï¼Œæœ‰äº›æ˜¯è‡ªç ”è§£å†³æ–¹æ¡ˆã€‚

> å¾®å‰ç«¯æœ€ç®€å•çš„å®ç°å½¢å¼æ˜¯åŸºäºIframeã€‚

### å…³äºå¾®å‰ç«¯æ¦‚å¿µçš„è¯¯åŒº ###

- å¾®å‰ç«¯ä¸æ˜¯ä¸€é—¨å…·ä½“çš„æŠ€æœ¯ï¼Œè€Œæ˜¯æ•´åˆäº†æŠ€æœ¯ã€ç­–ç•¥å’Œæ–¹æ³•ï¼Œå¯èƒ½ä¼šä»¥è„šæ‰‹æ¶ã€é…å¥—å·¥å…·å’Œè§„èŒƒçº¦æŸç­‰ç­‰æˆä½“ç³»çš„å½¢å¼ç»¼åˆå‘ˆç°ï¼Œæ˜¯ä¸€ç§å®è§‚ä¸Šçš„æ¶æ„ã€‚è¿™ç§æ¶æ„ç›®å‰æœ‰å¤šç§æ–¹æ¡ˆï¼Œå„æœ‰åˆ©å¼Šï¼Œä½†åªè¦é€‚ç”¨ä¸šåŠ¡åœºæ™¯çš„å°±æ˜¯å¥½æ–¹æ¡ˆã€‚
- å¾®å‰ç«¯æœ¬èº«å¹¶æ²¡æœ‰æŠ€æœ¯æ ˆçš„çº¦æŸï¼ˆæŠ€æœ¯æ ˆæ— å…³ä¸æ˜¯å¾®å‰ç«¯çš„å›ºç„¶è¦æ±‚ï¼‰ã€‚æ¯ä¸€å¥—å¾®å‰ç«¯æ–¹æ¡ˆçš„è®¾è®¡ï¼Œéƒ½æ˜¯åŸºäºå®é™…éœ€æ±‚å‡ºå‘ã€‚å¦‚æœæ˜¯å¤šå›¢é˜Ÿç»Ÿä¸€ä½¿ç”¨äº† React æŠ€æœ¯æ ˆï¼Œå¯èƒ½å¯¹å¾®å‰ç«¯æ–¹æ¡ˆçš„è·¨æŠ€æœ¯æ ˆä½¿ç”¨å¹¶æ²¡æœ‰è¦æ±‚ï¼›å¦‚æœæ˜¯å¤šå›¢é˜ŸåŒæ—¶ä½¿ç”¨äº† React å’Œ Vue æŠ€æœ¯æ ˆï¼Œå¯èƒ½å°±å¯¹å¾®å‰ç«¯çš„è·¨æŠ€æœ¯æ ˆè¦æ±‚æ¯”è¾ƒé«˜ã€‚
- å¾®å‰ç«¯è¦æ±‚å„ä¸ªåº”ç”¨èƒ½ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²ï¼Œä½†å¹¶ä¸è¦æ±‚å„ä¸ªåº”ç”¨èƒ½ç‹¬ç«‹è¿è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¾®å‰ç«¯çš„ç²’åº¦ä¸ä¸€å®šæ˜¯åº”ç”¨çº§çš„ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯é¡µé¢çº§ï¼Œç”šè‡³ç»„ä»¶çº§ã€‚

### å¾®å‰ç«¯çš„å‘å±• ###

å®ç°å¾®å‰ç«¯çš„ä¸»æµæ–¹æ¡ˆå°±å·²ç»å¤šè¾¾ 20 å¤šç§ï¼Œå®ç°çš„æ–¹å¼ä¹Ÿæ˜¯äº”èŠ±å…«é—¨ï¼Œè‡³äºåº”ç”¨å¾®å‰ç«¯æŠ€æœ¯çš„äº§å“ä¹‹å¤šï¼Œé‚£å°±æ›´æ•°ä¸æ¸…äº†ã€‚
å°±è¿™ä¸ªæˆæœæ¥çœ‹ï¼Œå½“æ—¶çš„æƒ³æ³•å¯ä»¥è¯´æ˜¯éå¸¸å…·æœ‰å‰ç»æ€§ğŸ®ğŸ®ã€‚
å¦‚æœå†å¾€å‰è¿½æº¯ï¼Œâ€œå¾®å‰ç«¯â€å…¶å®æ˜¯å—åˆ°äº† 2014 å¹´æ­£å¼æå‡ºçš„â€œå¾®æœåŠ¡ï¼ˆMicroservicesï¼‰â€æ¦‚å¿µçš„å¯å‘ã€‚

> å¾®æœåŠ¡æ˜¯æŒ‡ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼Œä»¥ä¸“æ³¨äºå•ä¸€è´£ä»»ä¸åŠŸèƒ½çš„å°å‹åŠŸèƒ½åŒºå— (Small Building Blocks) ä¸ºåŸºç¡€ï¼Œåˆ©ç”¨æ¨¡å—åŒ–çš„æ–¹å¼ç»„åˆå‡ºå¤æ‚çš„å¤§å‹åº”ç”¨ç¨‹åºï¼Œå„åŠŸèƒ½åŒºå—ä½¿ç”¨ä¸è¯­è¨€æ— å…³ (Language-Independent/Language agnosticï¼‰çš„ API é›†ç›¸äº’é€šä¿¡ã€‚

- åœ¨æŠ€æœ¯ä¸Šï¼š
  - â€œå¾®å‰ç«¯â€å’Œâ€œå¾®æœåŠ¡â€éœ€è¦è§£å†³çš„é—®é¢˜æ˜¯å…±é€šçš„ï¼ˆä½ çœ‹ï¼Œè¿å®šä¹‰éƒ½æ˜¯è¿™ä¹ˆç›¸åƒ...ï¼‰ï¼Œç®€å•è¯´èµ·æ¥å°±æ˜¯ï¼šåº”ç”¨éšç€é¡¹ç›®è¿­ä»£è¶Šæ¥è¶Šåºå¤§ï¼Œè€¦åˆåº¦å‡é«˜ï¼Œä»¥è‡´ç¼ºä¹çµæ´»æ€§ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚
- åœ¨å›¢é˜Ÿåä½œä¸Šï¼š
  - åº·å¨å®šå¾‹æŒ‡å‡ºï¼Œè®¾è®¡ç³»ç»Ÿçš„æ¶æ„å—åˆ¶äºäº§ç”Ÿè¿™äº›è®¾è®¡çš„ç»„ç»‡çš„æ²Ÿé€šç»“æ„ã€‚å®ƒæŒ‡å‡ºäº†ç»„ç»‡æ¶æ„è¶Šåºå¤§ï¼Œå…¶ç³»ç»Ÿé—´æ²Ÿé€šæˆæœ¬è¶Šé«˜çš„é—®é¢˜ã€‚
  - è§£å†³è¿™ä¸€é—®é¢˜çš„æœ‰æ•ˆæ‰‹æ®µå°±æ˜¯ï¼Œå°†å¤§çš„ç³»ç»Ÿæ‹†åˆ†æˆä¸€ä¸ªä¸ªå¾®å°çš„ï¼Œå¯ä»¥ç‹¬ç«‹è‡ªæ²»çš„å­ç³»ç»Ÿã€‚ä¸€æ—¦ç³»ç»Ÿçš„ä¾èµ–é™åˆ¶åœ¨äº†å†…éƒ¨ï¼ŒåŠŸèƒ½ä¸Šæ›´åŠ å†…èšï¼Œå¯¹å¤–éƒ¨çš„ä¾èµ–å˜å°‘ï¼Œé‚£ä¹ˆå°±èƒ½æ˜¾è‘—çš„å‡å°‘è·¨ç³»ç»Ÿä¹‹é—´çš„æ²Ÿé€šæˆæœ¬äº†ã€‚
  - ç®€å•æ¥è¯´ï¼Œåº·å¨å®šå¾‹çš„æŒ‡å¯¼æ€æƒ³å°±æ˜¯ï¼šæ—¢ç„¶æ²Ÿé€šæ˜¯å¤§é—®é¢˜ï¼Œé‚£ä¹ˆå°±ä¸è¦æ²Ÿé€šå°±å¥½äº†ã€‚æ‰€ä»¥ï¼Œå¾®å‰ç«¯(å¾®æœåŠ¡æ¶æ„)ä¹Ÿå…³æ³¨å¦‚ä½•è§£å†³ç»„ç»‡å’Œå›¢é˜Ÿé—´åä½œå¸¦æ¥çš„å·¥ç¨‹é—®é¢˜ï¼Œè€Œä¸æ˜¯å•çº¯çš„æŸä¸ªæŠ€æœ¯é—®é¢˜ã€‚
- åœ¨ä¸šåŠ¡ä¸Šï¼š
  - é€‰æ‹©å‰ç«¯å¾®æœåŠ¡åŒ–çš„åŸå› å´åˆšå¥½ä¸â€œè§£è€¦â€ã€â€œæ‹†åˆ†â€ç›¸åâ€”â€”äººä»¬æ›´æƒ³è¦çš„ç»“æœæ˜¯èšåˆï¼Œå°¤å…¶æ˜¯é‚£äº› To B çš„åº”ç”¨ã€‚æ¯”å¦‚å¤§å®¶ç†Ÿæ‚‰çš„å„ç±»äº‘æœåŠ¡ç½‘ç«™ã€ä»¥åŠå¤§éƒ¨åˆ†çš„ä¸­å°åº”ç”¨ã€‚
  - åœ¨â€œèšåˆâ€è¿™ä¸€ç›®æ ‡ä¸Šï¼Œé¢ä¸´çš„å¦ä¸€ä¸ªé‡å¤§å›°éš¾æ¥è‡ªé—ç•™ç³»ç»Ÿã€‚åœ¨æ—¢ä¸é‡å†™åŸæœ‰ç³»ç»Ÿçš„åŸºç¡€ä¹‹ä¸‹ï¼Œåˆå¯ä»¥æŠ½å‡ºäººåŠ›æ¥å¼€å‘æ–°çš„ä¸šåŠ¡ï¼Œå¯¹äºä¸šåŠ¡å’ŒæŠ€æœ¯äººå‘˜æ¥è¯´ï¼Œ æ˜¯ä¸€ä¸ªç›¸å½“å¸å¼•åŠ›çš„ç‰¹æ€§ã€‚è¿™ä¹Ÿæ˜¯å¾®å‰ç«¯å¤§å—æ¬¢è¿çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚

```markup

# å¾®å‰ç«¯è¦è§£å†³çš„é—®é¢˜

## æŠ€æœ¯

- åº”ç”¨éšç€é¡¹ç›®è¿­ä»£è¶Šæ¥è¶Šåºå¤§ï¼Œè€¦åˆåº¦å‡é«˜ï¼Œä»¥è‡´ç¼ºä¹çµæ´»æ€§ï¼Œéš¾ä»¥ç»´æŠ¤

## å›¢é˜Ÿåä½œ

- ç»„ç»‡æ¶æ„è¶Šåºå¤§ï¼Œå…¶ç³»ç»Ÿé—´æ²Ÿé€šæˆæœ¬è¶Šé«˜

## ä¸šåŠ¡

- ç”¨æˆ·é’çç»„åˆï¼Œä¸€ä½“åŒ–çš„å‰ç«¯åº”ç”¨ & å…¼å®¹é—ç•™ç³»ç»Ÿ

```

### å¾®å‰ç«¯çš„ç‰¹ç‚¹ ###

- **æŠ€æœ¯æ ˆæ— å…³** ä¸»æ¡†æ¶ä¸é™åˆ¶æ¥å…¥åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œå­åº”ç”¨å¯è‡ªä¸»é€‰æ‹©æŠ€æœ¯æ ˆ
- **ç‹¬ç«‹å¼€å‘/éƒ¨ç½²** å­åº”ç”¨ä»“åº“ç‹¬ç«‹ï¼Œå•ç‹¬éƒ¨ç½²ï¼Œäº’ä¸ä¾èµ–
- **å¢é‡å‡çº§** å½“ä¸€ä¸ªåº”ç”¨åºå¤§ä¹‹åï¼ŒæŠ€æœ¯å‡çº§æˆ–é‡æ„ç›¸å½“éº»çƒ¦ï¼Œè€Œå¾®åº”ç”¨å…·å¤‡æ¸è¿›å¼å‡çº§çš„ç‰¹æ€§
- **ç‹¬ç«‹è¿è¡Œ** å­åº”ç”¨ä¹‹é—´è¿è¡Œæ—¶äº’ä¸ä¾èµ–ï¼Œæœ‰ç‹¬ç«‹çš„çŠ¶æ€ç®¡ç†
- **æå‡æ•ˆç‡** å¾®åº”ç”¨å¯ä»¥å¾ˆå¥½æ‹†åˆ†é¡¹ç›®ï¼Œæå‡åä½œæ•ˆç‡
- **å¯ç»´æŠ¤æ€§** å¾®å‰ç«¯å¯ä»¥æ›´å®¹æ˜“åœ°è¿›è¡Œç»´æŠ¤å’Œæµ‹è¯•ï¼Œå› ä¸ºå®ƒä»¬å…·æœ‰æ¸…æ™°çš„ç•Œé™å’Œç‹¬ç«‹çš„ä»£ç åº“


### å¾®å‰ç«¯çš„åŠ£åŠ¿ ###

- **å¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦** éœ€è¦å¯¹ç³»ç»Ÿè¿›è¡Œæ‹†åˆ†ï¼Œå°†å•ä½“åº”ç”¨æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„å¾®å‰ç«¯åº”ç”¨ã€‚è¿™ç§æ‹†åˆ†å¯èƒ½å¯¼è‡´ç³»ç»Ÿæ•´ä½“å˜å¾—æ›´åŠ å¤æ‚ï¼Œå› ä¸ºéœ€è¦å¤„ç†è·¨åº”ç”¨ä¹‹é—´çš„é€šä¿¡å’Œé›†æˆé—®é¢˜
- **éœ€è¦ä¾èµ–é¢å¤–çš„å·¥å…·å’ŒæŠ€æœ¯** ä¾‹å¦‚æ¨¡å—åŠ è½½å™¨ã€åº”ç”¨å®¹å™¨ç­‰ï¼Œè¿™äº›å·¥å…·å’ŒæŠ€æœ¯éœ€è¦é¢å¤–çš„å­¦ä¹ å’Œç»´æŠ¤æˆæœ¬ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½é—®é¢˜
- **å®‰å…¨æ€§é—®é¢˜** ç”±äºå¾®å‰ç«¯åº”ç”¨æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒä»¬ä¹‹é—´å¯èƒ½å­˜åœ¨å®‰å…¨éšæ‚£ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªå¾®å‰ç«¯åº”ç”¨å­˜åœ¨æ¼æ´ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šåˆ©ç”¨è¿™ä¸ªæ¼æ´æ¥æ”»å‡»æ•´ä¸ªç³»ç»Ÿ
- **å…¼å®¹æ€§é—®é¢˜** ç”±äºå¾®å‰ç«¯åº”ç”¨æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒä»¬ä¹‹é—´å¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚ä¾‹å¦‚ï¼ŒæŸä¸ªå¾®å‰ç«¯åº”ç”¨å¯èƒ½ä½¿ç”¨äº†ä¸€äº›ä¸å…¼å®¹çš„ä¾èµ–åº“ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå‡ºç°é—®é¢˜
- **å¼€å‘å›¢é˜Ÿéœ€è¦æœ‰ä¸€å®šçš„æŠ€æœ¯æ°´å¹³** å®ç°å¾®å‰ç«¯éœ€è¦å¼€å‘å›¢é˜Ÿæœ‰ä¸€å®šçš„æŠ€æœ¯æ°´å¹³ï¼ŒåŒ…æ‹¬å¯¹æ¨¡å—åŒ–ã€ä»£ç å¤ç”¨ã€åº”ç”¨é›†æˆç­‰æ–¹é¢æœ‰æ·±å…¥çš„äº†è§£ã€‚å¦‚æœå›¢é˜Ÿç¼ºä¹è¿™æ–¹é¢çš„æŠ€èƒ½ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¾®å‰ç«¯å®ç°å‡ºç°é—®é¢˜


### ä¸€ä¸ªå®Œå–„çš„å¾®å‰ç«¯æ¡†æ¶ ###

- å­åº”ç”¨çš„æ¿€æ´»å’Œå¸è½½èƒ½åŠ›-
  - é¡µé¢ä»ä¸»åº”ç”¨åˆ‡æ¢åˆ°å­åº”ç”¨ï¼Œå­åº”ç”¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ªå­åº”ç”¨ï¼Œæ¡†æ¶éœ€è¦æ­£ç¡®åŠ è½½èµ„æºã€æ¸²æŸ“é¡µé¢ã€åˆ‡æ¢æµç•…
- å­åº”ç”¨ç‹¬ç«‹è¿è¡Œèƒ½åŠ›
  - éœ€è¦è€ƒè™‘åˆ°å­åº”ç”¨è¿è¡Œåä¸æ±¡æŸ“ä¸»åº”ç”¨çš„css/js/window/locationç­‰å¯¹è±¡
- åº”ç”¨é€šä¿¡èƒ½åŠ›
  - éœ€è¦è®¾è®¡ä¸»åº”ç”¨å’Œå­åº”ç”¨é€šä¿¡ï¼Œå­åº”ç”¨äº’ç›¸é€šä¿¡çš„èƒ½åŠ›
- è·¯ç”±åˆ‡æ¢èƒ½åŠ›
  - æ¥å…¥å­åº”ç”¨åï¼Œéœ€è¦ä¸å½±å“æµè§ˆå™¨æ­£å¸¸çš„å‰è¿›ã€åé€€ã€URLå±•ç¤º

## éš”ç¦» ##

ç”±äºä½¿ç”¨çš„æ˜¯iframeæ ‡ç­¾ï¼Œä¸¤ä¸ªå­åº”ç”¨å¤©ç„¶åœ°å­˜åœ¨CSSå’ŒJSéš”ç¦»ï¼Œä¸ä¼šæœ‰æ ·å¼å’Œè¿è¡Œæ—¶çš„å†²çªã€‚

## å¾®å‰ç«¯ why iframe not div? ##

ä¸ºä»€ä¹ˆå¾®å‰ç«¯ä½¿ç”¨iframeåšéš”ç¦»ï¼Œè€Œä¸æ˜¯æ™®é€šdivã€‚

ä¸»è¦æ˜¯å› ä¸ºiframeåœ¨æµè§ˆå™¨ä¸­å…·æœ‰å¤©ç„¶çš„éš”ç¦»ç¯å¢ƒï¼Œä¸»è¦è¡¨ç°åœ¨ï¼š

- JavaScript éš”ç¦»ï¼šiframe å†…çš„ JavaScript è¿è¡Œåœ¨ç‹¬ç«‹çš„å…¨å±€ä¸Šä¸‹æ–‡ä¸­ã€‚è¿™æ„å‘³ç€ï¼Œiframe å†…çš„ JavaScript å˜é‡å’Œå‡½æ•°ä¸ä¼šå½±å“åˆ°ä¸»é¡µé¢ï¼Œåä¹‹äº¦ç„¶ã€‚è¿™ç§ç‰¹æ€§å¯¹äºç¡®ä¿åº”ç”¨é—´ä¸ä¼šç›¸äº’å¹²æ‰°æ˜¯éå¸¸é‡è¦çš„ã€‚
- æ ·å¼éš”ç¦»ï¼šiframe å†…çš„æ ·å¼ä¸ä¼šå½±å“åˆ°å¤–éƒ¨é¡µé¢ã€‚æ¯ä¸ª iframe æœ‰è‡ªå·±çš„æ–‡æ¡£æµï¼Œæ‰€ä»¥é‡Œé¢çš„ CSS åªä¼šä½œç”¨äº iframeå†…éƒ¨ï¼Œä¸ä¼šæ³„éœ²åˆ°å¤–éƒ¨ï¼Œè¿™ä¿è¯äº†æ ·å¼çš„ç‹¬ç«‹æ€§å’Œä¸€è‡´æ€§ã€‚
- DOM éš”ç¦»ï¼šæ¯ä¸ª iframe éƒ½æœ‰è‡ªå·±çš„ DOM æ ‘ï¼Œä¸ä¸»é¡µé¢çš„ DOM æ ‘å®Œå…¨éš”ç¦»ã€‚è¿™æ„å‘³ç€ï¼Œiframe å†…çš„ DOM æ“ä½œä¸ä¼šå½±å“åˆ°å¤–éƒ¨é¡µé¢ï¼Œå‡å°‘äº†åº”ç”¨é—´çš„ç›´æ¥ DOM å†²çªã€‚

è¿™äº›éš”ç¦»ç‰¹æ€§å¯¹äºæ™®é€šçš„divæ ‡ç­¾æ˜¯æ²¡æœ‰çš„ã€‚

## å…±äº«(é€šä¿¡) ##

è™½ç„¶iframeèƒ½å®ç°ç®€å•çš„å¾®å‰ç«¯æ¶æ„ï¼Œä½†æ˜¯é€šè¿‡ä»£ç ä¸­è®¾è®¡çš„å…¨å±€äº‹ä»¶æ€»çº¿ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºåŸºäºiframeçš„å¾®å‰ç«¯éœ€è¦å•ç‹¬è®¾è®¡è·¨åŸŸé€šä¿¡æ–¹å¼ã€‚

æœ¬æ–¹æ¡ˆä¸»è¦æ˜¯é€šè¿‡PostMessageæ–¹æ³•å®ç°çš„ã€‚PostMessage æ˜¯ä¸€ç§å®‰å…¨åœ°å®ç°ä¸åŒæµè§ˆå™¨çª—å£ï¼ˆåŒ…æ‹¬å¼¹å‡ºçª—å£å’Œiframeï¼‰é—´é€šä¿¡çš„æ–¹å¼ã€‚å…è®¸ä¸åŒæºï¼ˆoriginï¼‰çš„çª—å£è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œä»è€Œå…‹æœäº†åŒæºç­–ç•¥çš„é™åˆ¶ã€‚é€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œå¦‚é¡µé¢ä¸å¼¹å‡ºçª—å£ã€é¡µé¢ä¸åµŒå…¥çš„iframeã€ç”šè‡³æ˜¯ä¸åŒçš„web workersä¹‹é—´çš„é€šä¿¡ã€‚

æ­¤å¤„å¼•å…¥è‡ªå·±ç¼–å†™çš„ `maui-jsbridge`[^maui-jsbridge] npmåŒ…, `H5å¾®åº”ç”¨å¹³å°`[^H5å¾®åº”ç”¨å¹³å°], `Maui Hybird æ¶æ„`[^MauiHybird], åŸºæœ¬ç¬¦åˆåŠŸèƒ½é¢„æœŸ ã€‚

### ä¸»åº”ç”¨ ###


**å¹¿æ’­æ¶ˆæ¯**

```ts
import { FrameCommands, MauiJsBridge } from 'maui-jsbridge'

const close = () => {
    resetFrame()
    MauiJsBridge.broadcastMessage({
        command: FrameCommands.CLOSING,
        data: {
            title: 'å¹¿æ’­æ¶ˆæ¯'
        }
    }, '*')
    delay(function () {
        router.replace({
            path: '/'
        });
    }, 500)
};
```

**æ¶ˆæ¯è½¬å‘**

```ts
const sendReceivedMessageToAllIframes = (event) => {
  document
    .querySelectorAll('iframe')
    .forEach((iframe) => iframe.contentWindow.postMessage(event.data, '*'));
};
```

**æ¥æ”¶æ¶ˆæ¯**

```ts
import { onMounted, onBeforeUnmount } from 'vue'
import { FrameCommands, IFrameMessage, MauiJsBridge } from 'maui-jsbridge'

onMounted(async () => {
  MauiJsBridge.init(window, handleMessage)
})

let allowedDomains = [window.origin, window.location.origin]

if (appStore.appPermissions) {
  allowedDomains = allowedDomains.concat(appStore.appPermissions.flatMap(_ => _.applications.map(__ => __.homePage)))
}

const handleMessage: (event: MessageEvent<IFrameMessage>) => void = (event) => {
  if (!allowedDomains.includes(event.origin)) {
     console.warn('ä¸ç¡®å®šæ¥æº:', event.origin);
     return
  }

  // å¤„ç†æ¥è‡ªå¯ä¿¡æºå’Œç‰¹å®šçš„ç±»å‹çš„æ¶ˆæ¯
  console.log('å¯ä¿¡æ¥æºæ•°æ®:', event.data);

  if (!event.data) {
    return
  }

  // æ ¹æ®ä¸Šé¢åˆ¶å®šçš„ç»“æ„æ¥è§£æiframeå†…éƒ¨å‘å›æ¥çš„æ•°æ®
  const { command, data } = event.data;
  console.log(data);
  switch (command) {
    case FrameCommands.ROUTE_BACK:
      console.log('Tokenå¤±æ•ˆ,éœ€è¿”å›ç™»å½•é¡µ')
      appStore.setAccessToken('')
      router.replace(defaultLoginPath)
      break;
    default:
      break;
  }
};

onBeforeUnmount(() => {
  MauiJsBridge.dispose()
});
```

### å­åº”ç”¨ ###

**åˆå§‹åŒ–**

```ts
appReady(import.meta.env.VUE_APP_OWNER_HOST).then(() => {
    router
        .isReady()
        .then(() => {
            app.mount('#app')
        })
        .catch((err: any) => {
            console.error(err)
        })
})
```

```ts
import { useAppStore } from '@/stores'
import { getUserInfo } from './api'
import { showFailToast } from 'vant'
import { IFrameMessage } from 'maui-jsbridge'

type AppReadyMessage = {
    iFrameReady: boolean
    appCode: string
    accessToken: string
}

const appReady = function (hostOrgin = 'http://localhost:3000') {
    console.log('check app ready')
    const { getAccessToken } = useAppStore()

    return new Promise(async (resolve, reject) => {
        function waitAppReady(e: MessageEvent<IFrameMessage>) {
            console.log(`${hostOrgin}, ${e.origin.toString()}`)
            if (`${e.origin}` !== hostOrgin) {
                console.log('ä¸èƒ½è®¿é—®')
                return
            }


            if (e && e.data && e.data.data) {
                console.log('waitAppReady', e.data)

                const { accessToken, appCode, iFrameReady } = e.data.data as AppReadyMessage

                if (!iFrameReady) {
                    return
                }

                const { setAccessToken, setAppCode } = useAppStore()

                console.log('æ”¶åˆ°æ¶ˆæ¯')
                setAccessToken(accessToken);
                setAppCode(appCode);
                window.removeEventListener('message', waitAppReady)

                resolve(true)
            }

            // getUserInfo({
            //     accessToken, appCode
            // }).then(res => {
            //     if (res.errCode === -1) {
            //         showFailToast(res['errorMessage'])
            //         return
            //     }
            //     console.log('res', res)

            //     const { setAccessToken, setAppCode } = useAppStore()

            //     console.log('æ”¶åˆ°æ¶ˆæ¯')
            //     setAccessToken(accessToken);
            //     setAppCode(appCode);
            //     window.removeEventListener('message', waitAppReady)

            //     resolve(true)
            // })
        }

        if (getAccessToken() === '') {
            console.log('app ready pending')

            window.addEventListener('message', waitAppReady)
        } else {
            console.log('app ready')
            resolve(true)
        }
    })
}

export default appReady
```


**å‘é€æ¶ˆæ¯**

```ts
import { MauiJsBridge } from 'maui-jsbridge'

MauiJsBridge.attach(window.parent)

MauiJsBridge.postMessage()
```

**æ¥æ”¶æ¶ˆæ¯**

```ts
import { onMounted, onBeforeUnmount } from 'vue'
import { FrameCommands, IFrameMessage, MauiJsBridge } from 'maui-jsbridge'

const appStore = useAppStore()
const { setAccessToken } = appStore

onMounted(async () => {
  MauiJsBridge.init(window, handleMessage);
});

const handleMessage = (event: MessageEvent<IFrameMessage>) => {
  if (event.origin !== import.meta.env.VUE_APP_OWNER_HOST) {
    console.warn('ä¸ç¡®å®šæ¥æº:', event.origin);
    return
  }

  // å¤„ç†æ¥è‡ªå¯ä¿¡æºå’Œç‰¹å®šçš„ç±»å‹çš„æ¶ˆæ¯
  console.log('å¯ä¿¡æ¥æºæ•°æ®:', event.data);

  const { command, data } = event.data;
  console.log('handleMessage', command, data)
  switch (command) {
    case FrameCommands.CLOSING:
      setAccessToken('')
      MauiJsBridge.detach()
      break;
    default:
      break;
  }
};

onBeforeUnmount(() => {
  MauiJsBridge.detach()
  setAccessToken('')
});
```

## æ€»ç»“ ##

ä¸€ä¸ª iframe å…·å¤‡å››å±‚èƒ½åŠ›ï¼šæ–‡æ¡£çš„åŠ è½½èƒ½åŠ›ã€HTML çš„æ¸²æŸ“èƒ½åŠ›ã€ç‹¬ç«‹æ‰§è¡Œ JavaScript çš„èƒ½åŠ›ã€éš”ç¦»æ ·å¼çš„èƒ½åŠ›ã€‚

è¿™äº›èƒ½åŠ›ï¼Œå…¶å®ä¹Ÿæ˜¯å¾®å‰ç«¯é¡¹ç›®è®¾è®¡çš„æ ¸å¿ƒè¦æ±‚ã€‚é€šè¿‡å­¦ä¹ æœ¬é¡¹ç›®ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¥½åœ°åˆæ­¥å­¦ä¹ å¾®å‰ç«¯ï¼Œä¸ºåæ¥æ·±å…¥å­¦ä¹ Single-SPAã€qiankunç­‰æ¡†æ¶æä¾›ç†è®ºåŸºç¡€ã€‚

## æ ‡å‡†æ¡ˆä¾‹ ##

### æ— é”¡ç¡•æ”¾æœºåœºæ–°ç”Ÿäº§ç»Ÿè®¡ç³»ç»Ÿ ###

<div class="grid grid-cols-3 gap-4">

![alt text](/images/cmono-å¾®ä¿¡å›¾ç‰‡_20240816150009.png){data-zoomable}

![alt text](/images/cmono-å¾®ä¿¡å›¾ç‰‡_20240816150020.png){data-zoomable}

![alt text](/images/cmono-å¾®ä¿¡å›¾ç‰‡_20240816150027.png){data-zoomable}

</div>


[^maui-jsbridge]: *[maui-jsbridge](https://www.npmjs.com/package/maui-jsbridge)*

[^H5å¾®åº”ç”¨å¹³å°]: *[H5å¾®åº”ç”¨å¹³å°](/zh-CN/gallery/maui.md)*

[^MauiHybird]: *[MauiHybirdæ¶æ„](/zh-CN/gallery/web_app.md)*
