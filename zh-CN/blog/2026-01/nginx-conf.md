---
lastUpdated: true
commentabled: true
recommended: true
title: nginx é…ç½®
description: nginx é…ç½®
date: 2026-01-22 11:00:00
pageClass: blog-page-class
cover: /covers/nginx.svg
---

> ä»ä¸€ä»½ server åˆ°çœ‹æ‡‚æ•´å¥—è·¯ç”±è§„åˆ™

## å¼•è¨€ï¼šä»ã€Œæ”¹ä¸€è¡Œé…ç½®ã€åˆ°ã€Œçº¿ä¸Šæ•´ç«™ 502ã€ ##

æœ‰ä¸€æ¬¡ï¼Œä¸€ä¸ªåŒäº‹è¯´è¦ã€Œé¡ºæ‰‹æ”¹ä¸‹ nginx é…ç½®ã€ï¼Œç»™æŸä¸ªæ¥å£åŠ ä¸€æ¡ç®€å•çš„è½¬å‘è§„åˆ™ã€‚

å‡ åˆ†é’Ÿåï¼Œæµ‹è¯•ç¯å¢ƒä¸€ç‰‡ 502ï¼Œç™»å½•é¡µé¢ä¹Ÿæ‰“ä¸å¼€äº†ï¼Œå¤§å®¶ç¬¬ä¸€ååº”æ˜¯ï¼šæ˜¯ä¸æ˜¯åç«¯æŒ‚äº†ã€æ˜¯ä¸æ˜¯ Redis å´©äº†ã€‚

æœ€åæ’æŸ¥ä¸‹æ¥ï¼Œé—®é¢˜æ—¢ä¸æ˜¯ç½‘ç»œï¼Œä¹Ÿä¸æ˜¯ä»£ç ï¼Œè€Œæ˜¯ï¼š

- åœ¨ `server` é‡Œå¤šåŠ äº†ä¸€æ¡ `location`ï¼›
- å°‘çœ‹äº†å‡ è¡Œå·²æœ‰è§„åˆ™ï¼›
- è®©ä¸€ä¸ªä¼˜å…ˆçº§æ›´é«˜çš„ `location` æŠŠå…¨ç«™è¯·æ±‚éƒ½ã€Œæˆªèƒ¡ã€äº†ã€‚

*nginx é…ç½®æœ€å¤§çš„å‘ï¼Œä¸æ˜¯ä½ ä¸ä¼šå†™ï¼Œè€Œæ˜¯ä½ ä»¥ä¸ºä½ å†™çš„æ˜¯è¿™æ¡è·¯ï¼Œå…¶å®å®ƒèµ°çš„æ˜¯å¦ä¸€æ¡ã€‚*

æˆ‘ä»¬å°±ä¸ä»ã€ŒæŒ‡ä»¤å¤§å­—å…¸ã€å¼€å§‹ï¼Œè€Œæ˜¯ä»ä¸€ä»½æœ€å¸¸è§çš„ `server` é…ç½®å…¥æ‰‹ï¼ŒæŠŠ `nginx` çš„åŸºæœ¬å¿ƒæ™ºæ¨¡å‹å’Œè·¯ç”±ä¼˜å…ˆçº§è®²æ¸…æ¥šã€‚

## ä¸€ã€å…ˆæŠŠå¤§å›¾çœ‹æ¸…ï¼šhttp / server / location åˆ°åº•åœ¨å¹²å˜›ï¼Ÿ ##

ç»å¤§éƒ¨åˆ†äººç¬¬ä¸€æ¬¡çœ‹åˆ° nginx é…ç½®ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ç»“æ„ï¼š

```nginx
http {
    include       mime.types;
    default_type  application/octet-stream;

    server {
        listen       80;
        server_name  localhost;
        charset      utf-8;

        location / {
            root   html;
            index  index.html index.htm;
        }

        location /test {
            proxy_pass https://wangmiaozero.cn;
        }
    }
}
```

å¦‚æœåªè®°è¿™ä¸€å¥å°±å¤Ÿç”¨äº†ï¼š

> http æ˜¯ã€Œæ€»é…ç½®ã€ï¼Œserver æ˜¯ã€Œè™šæ‹Ÿä¸»æœºã€ï¼Œlocation æ˜¯ã€Œè¿™ä¸€å°ä¸»æœºä¸Šçš„è·¯ç”±è§„åˆ™ã€ã€‚

### httpï¼šå…¨å±€è§„åˆ™ä¸å…¬å…±åŸºç¡€è®¾æ–½ ###

`http { ... }` é‡Œé€šå¸¸æ”¾çš„æ˜¯ã€Œæ‰€æœ‰ HTTP æœåŠ¡éƒ½èƒ½ç”¨åˆ°çš„ä¸œè¥¿ã€ï¼š

- `include mime.types`ï¼šå¼•å…¥æ–‡ä»¶ç±»å‹æ˜ å°„ï¼›
- `default_type`ï¼šé»˜è®¤å“åº”ç±»å‹ï¼›
- å„ç§å…¨å±€çš„ç¼“å­˜ã€æ—¥å¿—ã€è¿æ¥æ•°ã€è¶…æ—¶é…ç½®ç­‰ã€‚

ä½ å¯ä»¥æŠŠ `http` æƒ³è±¡æˆã€Œä¸€ä¸ªæœºæˆ¿ã€ï¼š

- æœºæˆ¿é‡Œä¼šæœ‰ä¸€å †æœºå™¨ï¼ˆ`server`ï¼‰ï¼›
- æœºæˆ¿çº§åˆ«ä¼šæœ‰ç»Ÿä¸€çš„è§„çŸ©ï¼ˆ`http` é‡Œçš„é…ç½®ï¼‰ï¼›
- å•ä¸ªæœºå™¨ä¹Ÿå¯ä»¥åœ¨è‡ªå·±æˆ¿é—´é‡ŒåŠ ç‚¹ç‰¹æ®Šè®¾ç½®ï¼ˆ`server` çº§åˆ«è¦†ç›–ï¼‰ã€‚

### serverï¼šä¸€å°é€»è¾‘ä¸Šçš„ã€Œè™šæ‹Ÿä¸»æœºã€ ###

`server { ... }` å°±æ˜¯ä¸€å°è™šæ‹Ÿä¸»æœºï¼Œå®ƒé€šè¿‡ï¼š

- `listen`ï¼šç›‘å¬ç«¯å£ï¼›
- `server_name`ï¼šåŒ¹é…åŸŸåï¼›

æ¥å†³å®šã€Œè¿™ä¸ªè¯·æ±‚æ˜¯ä¸æ˜¯è¯¥æˆ‘æ¥ã€ã€‚

ä¸€ä¸ª `nginx.conf` é‡Œå¯ä»¥æœ‰å¾ˆå¤šä¸ª serverï¼š

- `server_name www.xxx.com`ï¼šç½‘ç«™ Aï¼›
- `server_name api.xxx.com`ï¼šç½‘ç«™ Bï¼›
- `server_name *.internal.xxx.com`ï¼šå†…éƒ¨ç®¡ç†ç³»ç»Ÿç­‰ã€‚

ç”¨æˆ·çš„ HTTP è¯·æ±‚ï¼Œå…ˆæ˜¯è¢«æŸä¸€ä¸ª `server` æ¥ä½ï¼Œæ‰ä¼šå¾€ `location` é‡Œé¢èµ°ã€‚

###  locationï¼šè¿™ä¸€å°ä¸»æœºä¸Šçš„ã€Œè·¯ç”±ä¸åˆ†å‘è§„åˆ™ã€ ###

æœ‰äº† `server` ä¹‹åï¼Œå‰©ä¸‹çš„é—®é¢˜å°±æ˜¯ï¼š

> æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚è·¯å¾„ `/foo/bar`ï¼Œåˆ°åº•äº¤ç»™è°å¤„ç†ï¼Ÿ

è¿™å°±æ˜¯ `location` çš„å·¥ä½œäº†ã€‚

å¸¸è§çš„æŒ‡ä»¤å¤§è‡´é•¿è¿™æ ·ï¼š

- `root`ï¼šé™æ€èµ„æºæ ¹ç›®å½•ï¼›
- `index`ï¼šé»˜è®¤é¦–é¡µæ–‡ä»¶ï¼›
- `proxy_pass`ï¼šæŠŠè¯·æ±‚è½¬å‘åˆ°åç«¯ï¼›
- `rewrite`ï¼šåœ¨å½“å‰åŸŸåä¸‹æ”¹å†™è·¯å¾„ã€‚

æ—¥å¸¸å¼€å‘ä¸­ï¼Œ**å¤§éƒ¨åˆ†ã€Œç„å­¦é—®é¢˜ã€éƒ½å‡ºåœ¨ location ä¸Š**â€”â€”è¦ä¹ˆæ²¡å‘½ä¸­é¢„æœŸçš„è§„åˆ™ï¼Œè¦ä¹ˆè¢«æ›´é«˜ä¼˜å…ˆçº§çš„è§„åˆ™æˆªèƒ¡ã€‚

## äºŒã€location çš„ 7 ç§å†™æ³•ï¼Œå…¶å®åªæ˜¯åœ¨ç©**è°å…ˆè¯´äº†ç®—** ##

ç½‘ä¸Šç»å¸¸ä¼šçœ‹åˆ°è¿™æ ·çš„æ€»ç»“ï¼š

**`=` ç²¾ç¡®åŒ¹é…ã€`^~` å‰ç¼€ã€`~` æ­£åˆ™ã€`/` é€šåƒ**ï¼Œè®°å®Œä¸€éä¸‹æ¬¡åˆå¿˜äº†ã€‚

æˆ‘ä»¬æ¢ä¸ªæ›´å·¥ç¨‹ä¸€ç‚¹çš„è§†è§’ï¼š`location` ç©çš„æ˜¯ã€Œä¼˜å…ˆçº§ + æ˜¯å¦ç»§ç»­åŒ¹é…ã€è¿™ä¸¤ä¸ªç»´åº¦ã€‚

### å…ˆçœ‹ 7 ç§å†™æ³• ###

æŒ‰ç…§å®˜æ–¹è¯­ä¹‰ + å®æˆ˜è¡Œä¸ºï¼Œlocation ç²—ç•¥å¯ä»¥åˆ†æˆ 7 ç±»ï¼Œä»é«˜åˆ°ä½æ˜¯ï¼š

- `=` ç²¾ç¡®åŒ¹é…
- å®Œæ•´è·¯å¾„åŒ¹é…ï¼ˆå¦‚ `location /test/aaa/bbb.html`ï¼‰
- `^~ /test`ï¼šä»¥ `/test` å¼€å¤´ï¼Œå‘½ä¸­åä¸å†å¾€åæ‰¾
- `~ pattern`ï¼šåŒºåˆ†å¤§å°å†™çš„æ­£åˆ™ï¼Œå‘½ä¸­åä¸å†å¾€åæ‰¾
- `~* pattern`ï¼šä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™ï¼Œå‘½ä¸­åä¸å†å¾€åæ‰¾
- `/test`ï¼šæ™®é€šå‰ç¼€åŒ¹é…ï¼Œå‘½ä¸­åè¿˜ä¼šç»§ç»­å¾€åæ‰¾æ›´é•¿çš„å‰ç¼€
- `/`ï¼šå…œåº•è§„åˆ™ï¼Œä»€ä¹ˆéƒ½åŒ¹é…ï¼Œä¼˜å…ˆçº§æœ€ä½

ä½ å¯ä»¥è®°æˆä¸¤ä¸ªç®€å•çš„é—®é¢˜ï¼š

- å½“å‰è§„åˆ™ä¼˜å…ˆçº§é«˜ä¸é«˜ï¼Ÿ
- å‘½ä¸­ä¹‹åè¿˜è¦ä¸è¦ç»§ç»­å¾€åæ‰¾ï¼Ÿ

### ä¸¤æ¡å¤§åŸåˆ™ + ä¸¤æ¡ç»†åˆ™ ###

å¦‚æœä½ åªæƒ³èƒŒå°‘é‡è§„åˆ™ï¼ŒæŠŠè¿™ 4 æ¡åˆ»è¿›è„‘å­å°±å¤Ÿäº†ï¼š

**æ•´ä½“ä¼˜å…ˆçº§**ï¼š

ç²¾ç¡®åŒ¹é…(`=`) > å®Œæ•´è·¯å¾„ > `^~` > æ­£åˆ™(`~` / `~*`) > æ™®é€šå‰ç¼€(`/xxx`) > `/`

**æ˜¯å¦ç»§ç»­åŒ¹é…**ï¼š

é™¤äº†æ™®é€šå‰ç¼€ `/xxx` ä¼šç»§ç»­å¾€åæ‰¾ï¼Œå…¶å®ƒç±»å‹ï¼ˆ`=` `/` `^~` `/` `~` `/` `~*`ï¼‰ä¸€æ—¦å‘½ä¸­å°±åœæ­¢ã€‚

**åŒç±»å‹ä¹‹é—´**ï¼š

- å¤šä¸ªæ­£åˆ™ä¹‹é—´ `/` å¤šä¸ª `^~` ä¹‹é—´ï¼šå‘½ä¸­ç¬¬ä¸€ä¸ªå°±åœï¼Œé¡ºåºå¾ˆé‡è¦ï¼›
- å¤šä¸ªæ™®é€šå‰ç¼€ï¼ˆéƒ½æ˜¯ `/xxx` å¼€å¤´ï¼‰ï¼šæœ€é•¿åŒ¹é…ä¼˜å…ˆï¼Œè·Ÿå…ˆåé¡ºåºæ— å…³ã€‚

**`/` æ°¸è¿œæ˜¯å…œåº•**ï¼š

ä¸ç®¡å‰é¢å†™äº†å¤šå°‘è§„åˆ™ï¼Œ/ éƒ½æ˜¯æœ€åä¸€æ¡æ•‘å‘½ç¨»è‰ã€‚

> å¦‚æœè§‰å¾—è®°ä¸ä½ï¼Œå¯ä»¥æŠŠ location ç†è§£æˆï¼šã€Œå…ˆæŒ‘æœ€æœ‰èµ„æ ¼è¯´è¯çš„äººï¼Œç„¶åçœ‹ä»–æœ‰æ²¡æœ‰æŠŠè¯è¯´æ­»ã€ã€‚

## ä¸‰ã€é€šè¿‡ 5 ä¸ªå°å®éªŒï¼ŒæŠŠä¼˜å…ˆçº§æ‰“è¿›è‚Œè‚‰è®°å¿† ##

ç†è§£è§„åˆ™æ˜¯ä¸€å›äº‹ï¼Œèƒ½ä¸èƒ½åœ¨è„‘å­é‡Œã€Œç®—å‡ºç»“æœã€æ˜¯å¦ä¸€å›äº‹ã€‚

ä¸‹é¢çš„ä¾‹å­å…¨éƒ¨å¯ä»¥ç›´æ¥ä¸¢è¿› nginx é‡Œæµ‹è¯•ã€‚

### ç¤ºä¾‹ä¸€ï¼šç²¾ç¡®åŒ¹é…æ°¸è¿œä¼˜å…ˆäºæ™®é€š `/path` ###

```nginx
location /hello.json {
    default_type  text/html;
    return 200 '111';
}

location = /hello.json {
    default_type  text/html;
    return 200 '222';
}
```

è®¿é—® `/hello.json`ï¼Œè¿”å›çš„æ˜¯ `222`ã€‚

- åŸå› ï¼š`=` ç²¾ç¡®åŒ¹é…ä¼˜å…ˆçº§æœ€é«˜ï¼Œå…ˆå‘½ä¸­å°±ç›´æ¥åœï¼›
- æ™®é€š `/hello.json` è™½ç„¶çœ‹èµ·æ¥ä¸€æ ·ï¼Œä½†åœ¨è§„åˆ™é‡Œå±äºã€Œå‰ç¼€åŒ¹é…ã€ã€‚

### ç¤ºä¾‹äºŒï¼š`^~` æ¯”æ­£åˆ™æ›´ã€Œå¼ºåŠ¿ã€ ###

```nginx
# è™½ç„¶ 222 åœ¨åé¢ï¼Œä½†æ˜¯ç”±äº ^~ ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªç”Ÿæ•ˆ
location ~ /test/aaa {
    return 200 '111';
}

location ^~ /test/aaa {
    return 200 '222';
}
```

è®¿é—® `/test/aaa/bbb.json`ï¼Œè¿”å›çš„æ˜¯ `222`ã€‚

**è§£é‡Š**ï¼š

- `^~ /test/aaa` å±äºã€Œå‰ç¼€ä½†ä¸å†ç»§ç»­æ‰¾ã€è¿™ä¸€ç±»ï¼Œä¼˜å…ˆçº§é«˜äºæ­£åˆ™ï¼›
- å³ä¾¿å®ƒåœ¨åé¢å‡ºç°ï¼Œä¾ç„¶ä¼šå…ˆæ‹¿åˆ°è¯è¯­æƒã€‚

### ç¤ºä¾‹ä¸‰ï¼šå¤šä¸ªæ­£åˆ™ï¼Œå…ˆå†™çš„å…ˆèµ¢ ###

```nginx
# å¤šä¸ªæ­£åˆ™ä¹‹é—´ï¼Œç¬¬ä¸€ä¸ªåŒ¹é…ç”Ÿæ•ˆï¼Œä¸é¡ºåºæœ‰å…³
# è™½ç„¶è¶Šå¾€ååŒ¹é…è¶Šç²¾ç¡®ï¼Œä½†åªè¦æ˜¯æ­£åˆ™ï¼ŒåŒ¹é…åˆ°ç¬¬ä¸€ä¸ªå°±åœæ­¢
location ~ / {
    return 200 '111';
}

location ~ /test/aaa {
    return 200 '222';
}

location ~ /test/aaa/.*\.(gif|jpg|jpeg)$ {
    return 200 '333';
}
```

è®¿é—® `/test/aaa/bbb.json`ï¼Œå‘½ä¸­çš„å…¶å®æ˜¯ç¬¬ä¸€æ¡æ­£åˆ™ï¼ˆè¿”å› `111`ï¼‰ï¼Œå› ä¸ºï¼š

- `/` è¿™ä¸ªæ­£åˆ™ä¹Ÿèƒ½åŒ¹é…ä¸€åˆ‡è·¯å¾„ï¼›
- æ­£åˆ™ä¹‹é—´éµå¾ªã€Œå…ˆå†™å…ˆèµ¢ã€ï¼ŒåŒ¹é…åˆ°ç¬¬ä¸€ä¸ªå°±ä¸å†å¾€åçœ‹ã€‚

### ç¤ºä¾‹å››ï¼šåŒè·¯å¾„å‰ç¼€ä¸‹ï¼Œæ­£åˆ™ > æ™®é€šå‰ç¼€ ###

```nginx
# ä¸ç®¡äºŒè€…å¦‚ä½•äº¤æ¢é¡ºåºï¼Œå§‹ç»ˆéƒ½æ˜¯ç¬¬äºŒä¸ªç”Ÿæ•ˆ
location /test/aaa {
    return 200 '111';
}

location ~ /test/aaa {
    return 200 '222';
}
```

è®¿é—® `/test/aaa/bbb.json`ï¼Œè¿”å› `222`ï¼š

- `~ /test/aaa` æ˜¯æ­£åˆ™ï¼Œä¼˜å…ˆçº§æ¯”æ™®é€šå‰ç¼€ `/test/aaa` æ›´é«˜ï¼›
- å…ˆæ¯”ã€Œç§ç±»ä¼˜å…ˆçº§ã€ï¼Œå†è°ˆé¡ºåºã€‚

### ç¤ºä¾‹äº”ï¼šéƒ½æ˜¯å‰ç¼€åŒ¹é…æ—¶ï¼Œçœ‹è°æ›´é•¿ ###

```nginx
# éƒ½æ˜¯ / å¼€å¤´æ—¶ï¼Œæœ€é•¿åŒ¹é…ç”Ÿæ•ˆï¼Œå’Œå…ˆåé¡ºåºæ— å…³
location /test/ {
    return 200 '111';
}

location /test/aaa/ccc {
    return 200 '222';
}

location /test/aaa/ {
    return 200 '333';
}

location / {
    return 200 '444';
}
```

è®¿é—® `/test/aaa/bbb/ccc.json`ï¼š

- `/test/` èƒ½åŒ¹é…ï¼›
- `/test/aaa/` ä¹Ÿèƒ½åŒ¹é…ï¼›
- `/test/aaa/ccc` ä¹Ÿèƒ½åŒ¹é…ï¼›

æœ€ç»ˆé€‰çš„æ˜¯å­—ç¬¦ä¸²æœ€é•¿çš„é‚£æ¡ï¼š`/test/aaa/ccc` â†’ è¿”å› `222`ã€‚

## å››ã€rewrite å’Œ proxy_passï¼šé‡å†™ vs è½¬å‘ï¼Œä¸è¦ææ·· ##

æ—¥å¸¸é…ç½®é‡Œï¼Œå¤§å®¶æœ€å®¹æ˜“æŠŠ `rewrite` å’Œ `proxy_pass` æ··æˆä¸€å›¢ï¼šã€Œåæ­£éƒ½æ˜¯æ”¹ URLï¼Œå¯¹å§ï¼Ÿã€â€”â€”å…¶å®å·®åˆ«æŒºå¤§ã€‚

### rewriteï¼šåªåœ¨å½“å‰åŸŸåé‡Œæ”¹è·¯ç”± ###

`rewrite` çš„å…¸å‹ç”¨é€”æ˜¯ï¼š

- åœ¨åŒä¸€ä¸ªåŸŸåä¸‹ï¼ŒæŠŠ `/old/path` æ”¹å†™æˆ `/new/path`ï¼›
- å†³å®šæ˜¯å†…éƒ¨è·³è½¬ï¼ˆ`last`ï¼‰è¿˜æ˜¯è¿”å› 301/302ï¼ˆ`redirect` / `permanent`ï¼‰ã€‚

å®ƒåšçš„åªæ˜¯è·¯å¾„å±‚é¢çš„æ”¹å†™ï¼Œä¸ä¼šå¸®ä½ æ¢æœåŠ¡å™¨ã€æ¢ç«¯å£ï¼š

```nginx
location /old {
    rewrite ^/old/(.*)$ /new/$1 last;
}
```

### proxy_passï¼šæŠŠè¯·æ±‚ã€Œäº¤ç»™åˆ«äººå¤„ç†ã€ ###

`proxy_pass` åˆ™æ˜¯åå‘ä»£ç†ï¼š

- å¯ä»¥æŠŠè¯·æ±‚ä¸¢ç»™ä»»æ„åœ°å€ï¼š`http://127.0.0.1:8080`ã€`https://api.xxx.com`ï¼›
- å¯ä»¥åœ¨è¿™ä¸€å±‚åŠ å„ç§ headerã€è¶…æ—¶ã€ç¼“å†²é…ç½®ç­‰ã€‚

```nginx
location /api {
    proxy_set_header X-Real-IP        $remote_addr;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header Host             $http_host;
    proxy_connect_timeout 10;
    proxy_pass http://127.0.0.1:6666;
}
```

ä¸€å¥è¯åŒºåˆ†ï¼š

- `rewrite`ï¼šè·¯ç”±æ”¹å†™ï¼Œåªåœ¨å½“å‰ä¸»æœºå†…ã€Œæ¢ä¸€æ¡è·¯èµ°ã€ï¼›
- `proxy_pass`ï¼šåå‘ä»£ç†ï¼ŒæŠŠæ•´æ¡è¯·æ±‚ã€Œäº¤ç»™å¦ä¸€å°æœåŠ¡ã€ã€‚

## äº”ã€nginx é…ç½®çš„ã€Œå¯é¢„æœŸæ€§ã€ï¼šä»è®°è¯­æ³•åˆ°è®°è¡Œä¸º ##

å¾ˆå¤šäººè§‰å¾— nginx é…ç½®ç„å­¦ï¼Œæœ¬è´¨ä¸Šæ˜¯å› ä¸ºï¼š

- åªè®°ä½äº†ã€Œæ€ä¹ˆå†™ã€ï¼Œæ²¡è®°ä½ã€Œä¼šå‘ç”Ÿä»€ä¹ˆã€ï¼›
- åªåœ¨å•æ¡è§„åˆ™ä¸Šåšå®éªŒï¼Œå¾ˆå°‘åœ¨å¤šä¸ª `location` ç»„åˆä¸‹åšéªŒè¯ã€‚

å¦‚æœä½ æŠŠè¿™ä¸€ç¯‡çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹å‹ç¼©æˆä¸€å¼ çº¸ï¼Œå¤§æ¦‚å°±æ˜¯ï¼š

- `http` / `server` / `location` çš„åˆ†å±‚èŒè´£ï¼›
- 7 ç§ `location` å†™æ³•çš„`ä¼˜å…ˆçº§ + æ˜¯å¦ç»§ç»­åŒ¹é…`ï¼›
- 5 ä¸ªä¾‹å­é‡Œã€Œè°å…ˆè¯´è¯ã€è°æœ€åæ‹æ¿ã€çš„è¡Œä¸ºæ¨¡å¼ï¼›
- `rewrite` åªæ”¹è·¯å¾„ï¼Œ`proxy_pass` æ‰æ˜¯çœŸæ­£è½¬å‘ã€‚

> nginx æœ€å®¹æ˜“çŠ¯é”™çš„åœ°æ–¹ï¼Œä¸åœ¨äºä½ ä¸ä¼šå†™æŒ‡ä»¤ï¼Œè€Œåœ¨äºä½ æ²¡èƒ½åœ¨è„‘å­é‡ŒæŠŠã€ŒçœŸæ­£çš„åŒ¹é…è¿‡ç¨‹ã€æƒ³ä¸€éã€‚

> HTTPSã€è½¬å‘ã€è·¨åŸŸä¸æ³›åŸŸåçš„å®æˆ˜å¥—è·¯

## å¼•è¨€ï¼šå½“åŸŸåã€è¯ä¹¦å’Œè½¬å‘è§„åˆ™ã€Œæ…åœ¨ä¸€èµ·ã€ ##

æœ‰ä¸ªåŒäº‹æ¥äº†ä¸ªçœ‹ä¼¼ç®€å•çš„éœ€æ±‚ï¼š

- æŠŠ `http://www.test.com` è½¬åˆ°å†…éƒ¨æœåŠ¡ `127.0.0.1:6666`ï¼›
- é¡ºå¸¦ä¸Šä¸ª HTTPSï¼Œç»™å‰ç«¯ API ç”¨ï¼›
- å†åŠ ä¸€ä¸‹ CORSï¼Œæ–¹ä¾¿æœ¬åœ°è°ƒè¯•ã€‚

ç»“æœä¸€é¡¿æ“ä½œä¹‹åï¼š

- HTTP å¯ä»¥è®¿é—®ï¼Œä½†è¢«æµè§ˆå™¨æ ‡çº¢ã€Œä¸å®‰å…¨ã€ï¼›
- HTTPS èƒ½è¿ä¸Šï¼Œä½†æ¥å£ 502ï¼Œæ—¥å¿—é‡Œå…¨æ˜¯ã€Œno resolver definedã€ä¹‹ç±»çš„æç¤ºï¼›
- è·¨åŸŸå¤´éšç¼˜è¿”å›ï¼Œæœ‰æ—¶å€™ OPTIONS ç›´æ¥ 403ã€‚

åŸŸåã€è¯ä¹¦ã€è½¬å‘ã€è·¨åŸŸï¼Œè¿™äº›çœ‹èµ·æ¥é›¶æ•£çš„éœ€æ±‚ï¼Œæœ€åéƒ½ä¼šèšåœ¨ nginx è¿™ä¸€å±‚ã€‚

è¿™ä¸€ç¯‡ï¼Œæˆ‘ä»¬æ²¿ç€ä¸€ä¸ªã€Œå…¥å£æµé‡ã€çš„è§†è§’ï¼ŒæŠŠ HTTPSã€åå‘ä»£ç†ã€CORSã€æ°¸ä¹…è·³è½¬ã€æ³›äºŒçº§åŸŸåè¿™äº›é«˜é¢‘åœºæ™¯ä¸²æˆä¸€æ¡çº¿ï¼šè®©ä½ å¯¹ã€Œnginx ä½œä¸ºæµé‡å…¥å£ã€æœ‰ä¸€ä¸ªå®Œæ•´ã€å¯è½åœ°çš„å®æˆ˜å¥—è·¯ã€‚

## ä¸€ã€HTTPSï¼šè®© TLS ä»…ä»…æ˜¯ã€Œå¤šå†™å‡ è¡Œé…ç½®ã€ ##

HTTPS æœ¬èº«çš„åè®®ç»†èŠ‚å¯ä»¥å¾ˆå¤æ‚ï¼Œä½†åœ¨ `nginx` é‡Œï¼Œæœ€åŸºç¡€çš„å¯ç”¨æ–¹å¼å…¶å®å°±å‡ è¡Œï¼š

```nginx
server {
    listen       443 ssl;
    server_name  example.com;

    ssl_certificate      cert.crt;
    ssl_certificate_key  cert.key;
    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_ciphers          HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        root   html;
        index  index.html index.htm;
    }
}
```

å‡ ä¸ªè¦ç‚¹ï¼š

- `listen 443 ssl`ï¼šæ²¡æœ‰ `ssl` å…³é”®å­—ï¼Œnginx ä¸ä¼šä»¥ TLS æ¨¡å¼ç›‘å¬ï¼›
- `ssl_certificate` / `ssl_certificate_key`ï¼šå…¬é’¥è¯ä¹¦ + ç§é’¥ï¼›
- å…¶ä½™å¦‚ `session_cache`ã€`ciphers` æ˜¯å…¸å‹çš„ã€ŒæŒ‰å®‰å…¨åŸºçº¿æŠ„ã€é…ç½®ã€‚

> å·¥ç¨‹å®è·µé‡Œï¼ŒHTTPS çœŸæ­£çš„éš¾ç‚¹å¾€å¾€ä¸æ˜¯ã€Œå†™å“ªå‡ è¡Œã€ï¼Œè€Œæ˜¯è¯ä¹¦ç”³è¯·ã€æ›´æ–°è‡ªåŠ¨åŒ–ï¼Œä»¥åŠå¦‚ä½•æŠŠ HTTP æµé‡ä½æˆæœ¬åœ°å¼•åˆ° HTTPS ä¸Šã€‚

## äºŒã€åå‘ä»£ç†ï¼šæŠŠå‰ç«¯æµé‡ç¨³ç¨³é€åˆ°åç«¯ ##

æœ€å¸¸è§çš„ nginx ç”¨æ³•ï¼Œä¾æ—§æ˜¯åå‘ä»£ç†ï¼šæŠŠã€Œå¯¹å¤–çš„åŸŸåã€æ˜ å°„åˆ°ã€Œå†…éƒ¨çš„æœåŠ¡ã€ä¸Šã€‚

### æ ‡å‡†åå‘ä»£ç†æ¨¡æ¿ ###

ä¾‹å¦‚ï¼ŒæŠŠ `http://www.test.com` è½¬å‘åˆ°æœ¬åœ° `127.0.0.1:6666`ï¼š

```nginx
server {
    listen       80;
    server_name  www.test.com;

    location / {
        # é€ä¼ çœŸå®å®¢æˆ·ç«¯ IP
        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host            $http_host;

        # ä»£ç†è¿æ¥è¶…æ—¶è®¾ç½®ä¸º 10 ç§’ï¼Œé»˜è®¤ 60 ç§’å¤ªé•¿
        proxy_connect_timeout 10;

        proxy_pass http://127.0.0.1:6666;
    }
}
```

å‡ ä¸ªå®è·µå»ºè®®ï¼š

- ä¸è¦ç”¨ localhostï¼Œå¯¹äºæŸäº›é…ç½®ï¼ˆå°¤å…¶ç»“åˆå˜é‡ï¼‰ä¼šè¸©åˆ°è§£æå‘ï¼ŒIP æ›´ç¨³å¦¥ï¼›
- ä¸€å®šè¦è®¾ç½® proxy_connect_timeoutï¼Œå¦åˆ™åç«¯æœåŠ¡åŠæ­»ä¸æ´»æ—¶ï¼Œå‰ç«¯ä¼šç­‰åˆ°æ€€ç–‘äººç”Ÿï¼›
- æŠŠ Host é€ä¼ ç»™åç«¯ï¼Œå¾ˆå¤šåº”ç”¨ä¼šæ ¹æ® Host åšè·¯ç”±æˆ–å¤šç§Ÿæˆ·åˆ¤æ–­ã€‚

### å†åŠ ä¸€å±‚ï¼šå…¥å£ + BFF + åç«¯ ###

åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œnginx ä¸€èˆ¬åªæ˜¯ã€Œæœ€å¤–é¢é‚£å±‚ã€ï¼š

- nginx æŠŠæµé‡æ‰“åˆ° BFFï¼ˆNode.js / Nest / Honoï¼‰ï¼›
- BFF å†å»è°ƒå†…éƒ¨æœåŠ¡ï¼ˆGo / Java / å¾®æœåŠ¡é›†ç¾¤ï¼‰ã€‚

nginx é‡Œè¿™å±‚çš„ç›®æ ‡åªæœ‰ä¸¤ä¸ªå­—ï¼š**å¹²å‡€**ã€‚

- ä¸åšä¸šåŠ¡é€»è¾‘ï¼Œåªåšåè®®å±‚çš„äº‹æƒ…ï¼šTLSã€é™æµã€åŸºæœ¬é‰´æƒã€CORSã€æµé‡åˆ†æµï¼›
- å…¶ä½™å¤æ‚é€»è¾‘äº¤ç»™ BFF / ç½‘å…³å±‚å¤„ç†ã€‚

## ä¸‰ã€CORSï¼šæŠŠè·¨åŸŸæ”¾åœ¨å…¥å£ç»Ÿä¸€å¤„ç† ##

å‰ç«¯æœ€å¸¸è§çš„ä¸€å¥æŠ±æ€¨ï¼šã€Œæ˜æ˜åç«¯å·²ç»åœ¨æ¥å£é‡ŒåŠ äº† CORSï¼Œæ€ä¹ˆæµè§ˆå™¨è¿˜æ˜¯è¯´è·¨åŸŸï¼Ÿã€

å¦‚æœä½ çš„ nginx åœ¨æœ€å¤–å±‚æŒ¡ç€ï¼Œè€Œåç«¯åªç»™åº”ç”¨æœåŠ¡åŠ äº† CORSï¼Œå¾ˆå¯èƒ½å‡ºç°ï¼š

- é¢„æ£€ï¼ˆOPTIONSï¼‰è¢« nginx æ‹¦ä¸‹äº†ï¼Œæ ¹æœ¬æ²¡åˆ°åç«¯ï¼›
- æˆ–è€… nginx è‡ªå·±è¿”å›äº† 4xx/5xxï¼Œå´æ²¡å¸¦ä»»ä½• CORS å¤´ã€‚

æœ€ç®€å•çš„è§£å†³æ–¹å¼ï¼Œå°±æ˜¯ç›´æ¥åœ¨ nginx å…¥å£å±‚åŠ  CORS å¤´ï¼š

```nginx
server {
    listen       80;
    server_name  www.test.com;

    location / {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, No-Cache, X-Requested-With, If-Modified-Since, Pragma, Last-Modified, Cache-Control, Expires, Content-Type, X-E4M-With' always;
        add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS' always;

        # å¦‚æœéœ€è¦å¤„ç† OPTIONS é¢„æ£€ï¼Œå¯ä»¥å•ç‹¬æ‹¦ä¸€æ¡
        if ($request_method = OPTIONS) {
            return 204;
        }

        proxy_pass http://127.0.0.1:6666;
    }
}
```

è¦ç‚¹ï¼š

- `always` å¯ä»¥ç¡®ä¿å³ä¾¿è¿”å› 4xx/5xx ä¹Ÿå¸¦ä¸Š CORS å¤´ï¼›
- å°½å¯èƒ½åœ¨**å…¥å£å±‚ç»Ÿä¸€å¤„ç† CORS**ï¼Œè€Œä¸æ˜¯æ¯ä¸ªåç«¯æœåŠ¡éƒ½å†™ä¸€éã€‚

> CORS è¿™ç§ã€Œåè®®å±‚ã€çš„ä¸œè¥¿ï¼Œæ”¾åœ¨å…¥å£ç»Ÿä¸€åšï¼Œæ¯”æ’’åœ¨å„ä¸ªä¸šåŠ¡ä»£ç é‡Œè¦å¯é å¾—å¤šã€‚

## å››ã€æ°¸ä¹…è·³è½¬ï¼šæŠŠã€Œå†å²åŸŸåã€ä¼˜é›…æ”¶æŸèµ·æ¥ ##

å†å²åŸŸåã€å¸¦ä¸å¸¦ `www`ã€ä» HTTP åˆ° HTTPSï¼Œè¿™äº›éœ€æ±‚æœ¬è´¨ä¸Šéƒ½æ˜¯ã€Œè·³è½¬ã€é—®é¢˜ã€‚

### ä»å¸¦ www è·³åˆ°ä¸å¸¦ï¼šwww â†’ é www ###

ä¾‹å¦‚ï¼Œå°† `http://www.wangmiaozero.cn` æ°¸ä¹…è·³è½¬åˆ° `http://wangmiaozero.cn`ï¼Œå¹¶ä¸¢å¼ƒè·¯å¾„ï¼š

```nginx
server {
    listen       80;
    server_name  www.wangmiaozero.cn;

    location / {
        rewrite ^(.*) http://wangmiaozero.cn permanent;
    }
}
```

è¿™é‡Œçš„ `permanent = 301`ï¼Œæµè§ˆå™¨ä¼šé•¿æœŸè®°ä½ã€‚

### ä» HTTP + www è·³åˆ° HTTPS + é www ###

å¦‚æœå¸Œæœ›ï¼š

- `http://www.wangmiaozero.cn/foo` â†’ æ°¸ä¹…è·³è½¬åˆ° `https://wangmiaozero.cn/foo` ï¼ˆä¿ç•™è·¯å¾„ï¼‰ï¼š

```nginx
server {
    listen       80;
    server_name  www.wangmiaozero.cn;

    location / {
        rewrite ^(.*) https://wangmiaozero.cn$document_uri permanent;
    }
}
```

æ³¨æ„ï¼š

- `$document_uri` æ˜¯ã€Œä¸å«æŸ¥è¯¢å‚æ•°ã€çš„è·¯å¾„ï¼›
- å¦‚æœéœ€è¦è¿ `query` ä¸€èµ·ä¿ç•™ï¼Œå¯ä»¥ç”¨ `$request_uri`ã€‚

> æ¨èåšæ³•æ˜¯ï¼šæ‰€æœ‰ HTTP æµé‡ç»Ÿä¸€è·³åˆ° HTTPS + å½’ä¸€åçš„ä¸»åŸŸåï¼Œç”¨æˆ·è®¿é—®è·¯å¾„å°½é‡ä¿æŒä¸å˜ã€‚

## äº”ã€æ³›äºŒçº§åŸŸåï¼šä¸€å¥—é…ç½®æå®šã€ŒN ä¸ªå­ç«™ç‚¹ã€ ##

å½“ä½ æœ‰ä¸€å †ç±»ä¼¼ï¼š

- `tenant-a.example.com`
- `tenant-b.example.com`
- `foo.internal.example.com`

çš„éœ€æ±‚æ—¶ï¼Œå°±è½®åˆ°ã€Œæ³›äºŒçº§åŸŸåã€ç™»åœºäº†ã€‚

### åŸºäºè½¬å‘çš„æ³›äºŒçº§åŸŸåï¼šä¸åŒå­åŸŸå â†’ ä¸åŒåç«¯è·¯å¾„ ###

ç›®æ ‡ï¼š`http://*.wangmiaozero.cn/` ç»Ÿä¸€è½¬å‘åˆ° `http://127.0.0.1:8080/*/`ã€‚

ç¤ºä¾‹é…ç½®ï¼š

```nginx
http {
    include       mime.types;
    default_type  application/octet-stream;

    # é‡è¦ï¼šå½“ proxy_pass é‡Œç”¨å˜é‡æ„é€ åœ°å€æ—¶ï¼Œå¿…é¡»é…ç½® resolver
    resolver 8.8.8.8;

    sendfile        on;
    keepalive_timeout  65;

    # æŸäº›ç‰¹æ®ŠåŸŸåå•ç‹¬å†™åœ¨å‰é¢
    server {
        listen       80;
        server_name  www.wangmiaozero.cn www.test.com test.com;

        location / {
            rewrite ^(.*) http://wangmiaozero.cn permanent;
        }
    }

    server {
        listen       80;
        server_name  demo.wangmiaozero.cn;

        location / {
            root   D:/Workspace/github/demo;
            index  index.html index.jsp;
        }
    }

    # æ³›äºŒçº§åŸŸåï¼šåŒ¹é… *.wangmiaozero.cn
    server {
        listen       80;
        server_name  ~^(.+)?\.wangmiaozero\.cn$;

        location / {
            # æ³¨æ„è¿™é‡Œè¦ç”¨ 127.0.0.1ï¼Œä¸è¦ç”¨ localhost
            proxy_pass http://127.0.0.1:8080/$1$request_uri;
        }
    }
}
```

è¯´æ˜ï¼š

- `server_name ~^(.+)?\.wangmiaozero\.cn$` ç”¨æ­£åˆ™æŠŠå­åŸŸåæ‹¿å‡ºæ¥ï¼›
- `$1` å°±æ˜¯å­åŸŸåï¼Œå¯ä»¥ç›´æ¥æ‹¼åœ¨è½¬å‘è·¯å¾„é‡Œï¼›
- å‰é¢å¯ä»¥åŠ è‹¥å¹²ã€Œç‰¹æ®Šå­åŸŸåã€çš„ `server`ï¼Œnginx ä¼šå…ˆå‘½ä¸­é‚£äº›æ›´å…·ä½“çš„é…ç½®ã€‚

### åŸºäºç›®å½•çš„æ³›äºŒçº§åŸŸåï¼šä¸åŒå­åŸŸå â†’ ä¸åŒé™æ€ç›®å½• ###

å¦‚æœä½ æƒ³æŠŠ `a.wangmiaozero.cn` æ˜ å°„åˆ° `D:/Workspace/github/test/a`ï¼Œ`b.wangmiaozero.cn` æ˜ å°„åˆ° `.../test/b`ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```nginx
server {
    listen       80;
    server_name  ~^(.+)?\.wangmiaozero\.cn;

    location / {
        root   D:/Workspace/github/test/$1;
        index  index.html index.jsp;
    }
}
```

è¿™å¥—é…ç½®å¯¹ã€Œå¤šç§Ÿæˆ·é™æ€ç«™ç‚¹ã€ç‰¹åˆ«å‹å¥½ï¼š

- æ¯ä¸ªå­åŸŸåä¸€ä¸ªç›®å½•ï¼›
- ä¸Šçº¿åªéœ€è¦æŠŠå¯¹åº”ç›®å½•æŒ‚ä¸Šå»ã€‚

### no resolver defined to resolve localhostï¼šåˆ«å†è¸©ä¸€æ¬¡çš„å‘ ###

å½“ä½ åœ¨ `proxy_pass` é‡Œç”¨å˜é‡æ‹¼æ¥åœ°å€æ—¶ï¼Œä¾‹å¦‚ï¼š

```nginx
proxy_pass http://$http_host$request_uri;
```

å¦‚æœæ²¡æœ‰é…ç½® resolverï¼Œnginx ä¼šæŠ¥ï¼š

```text
no resolver defined to resolve localhost
```

è¿™å°±æ˜¯å‰é¢é…ç½®é‡Œé‚£å¥ï¼š

```nginx
resolver 8.8.8.8;
```

å­˜åœ¨çš„æ„ä¹‰ï¼š*å½“ nginx éœ€è¦åœ¨è¿è¡Œæ—¶è§£æä¸€ä¸ªåŸŸåï¼ˆé€šè¿‡å˜é‡æ„é€ æ—¶ï¼‰ï¼Œå¿…é¡»æœ‰ DNS å¯ä»¥ç”¨*ã€‚

## å…­ã€`server_names_hash_bucket_size`ï¼šåŸŸåå¤šäº†ï¼Œè¡¨è¦åŠ å¤§ ##

å½“ä½ åœ¨ä¸€ä¸ª `http {}` é‡Œå†™äº†å¤§é‡ `server_name` æ—¶ï¼Œæœ‰å¯èƒ½åœ¨ reload æ—¶çœ‹åˆ°è¿™æ ·çš„é”™è¯¯ï¼š

```text
could not build the server_names_hash, you should increase server_names_hash_bucket_size: 64
```

å¤§æ„å°±æ˜¯ï¼šã€Œå­˜åŸŸåçš„ hash æ¡¶ä¸å¤Ÿå¤§äº†ï¼Œè¯·ä½ è°ƒå¤§ç‚¹ã€ã€‚

è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ `http {}` é‡ŒåŠ ä¸€è¡Œï¼š

```nginx
http {
    include       mime.types;
    default_type  application/octet-stream;

    # åŸŸåè¿‡å¤šæ—¶éœ€è¦é…ç½®è¿™ä¸ªå‚æ•°ï¼Œä¸€èˆ¬æ˜¯ 2 çš„æŒ‡æ•°ï¼Œæ¯”å¦‚ 512
    server_names_hash_bucket_size 512;
}
```

> å·¥ç¨‹è§†è§’ä¸‹ï¼Œè¿™ç±»ã€Œhash bucketã€æŠ¥é”™çš„æœ¬è´¨ï¼Œå°±æ˜¯ nginx åœ¨å¸®ä½ æš—æˆ³æˆ³ç®¡ç†ä¸€å¼ ã€ŒåŸŸåè·¯ç”±è¡¨ã€ï¼Œå½“è¿™å¼ è¡¨å¤ªæŒ¤æ—¶ï¼Œä½ éœ€è¦å¤šç»™å®ƒä¸€ç‚¹ç©ºé—´ã€‚

## ä¸ƒã€è·¯å¾„è¿½åŠ è§„åˆ™ï¼š`root / proxy_pass` åˆ°åº•æ€ä¹ˆæ‹¼ URLï¼Ÿ ##

è·¯å¾„æ‹¼æ¥è§„åˆ™ï¼Œæ˜¯å¦ä¸€ä¸ªé«˜é¢‘ã€Œå‡­æ„Ÿè§‰å†™ã€ç„¶åç¿»è½¦çš„åœ°æ–¹ã€‚

çœ‹ä¸€æ®µå…¸å‹é…ç½®ï¼š

```nginx
server {
    listen       80;
    server_name  www.test.com;

    location / {
        root  E:/Workspace/test/htdocs/;
        index index.html;
    }

    location /test_root {
        # è®¿é—® www.test.com/test_root/aaa/index.html
        # å®é™…è®¿é—®çš„æ˜¯ htdocs/test_root/aaa/index.html
        root  E:/Workspace/test/htdocs/;
        index index.html;
    }

    location /test_proxy1 {
        # è®¿é—® www.test.com/test_proxy1/aaa/index.html
        # å®é™…è®¿é—® www.proxy.com/test_proxy1/aaa/index.html
        proxy_pass http://www.proxy.com;
        proxy_buffering off;
    }

    location /test_proxy2 {
        # è®¿é—® www.test.com/test_proxy2/aaa/index.html
        # å®é™…è®¿é—® www.proxy.com//aaa/index.html
        proxy_pass http://www.proxy.com/;
        proxy_buffering off;
    }

    location /test_proxy3 {
        # è®¿é—® www.test.com/test_proxy3/aaa/index.html
        # å®é™…è®¿é—® www.proxy.com/bbb/aaa/index.html
        proxy_pass http://www.proxy.com/bbb;
        proxy_buffering off;
    }
}
```

å¯ä»¥æ€»ç»“å‡ºå‡ ä¸ªå®ç”¨ç»“è®ºï¼š

- `root` + `location`ï¼š

  - `location /foo` + `root /var/www` â†’ å®é™…è·¯å¾„æ˜¯ `/var/www/foo/`...ï¼›
  - ä¸ç®¡ `foo` åé¢å†™ä¸å†™ `/`ï¼Œ`location` é‡Œçš„é‚£æ®µéƒ½ä¼šè¢«æ‹¼åˆ°çœŸå®è·¯å¾„ä¸Šã€‚

- `proxy_pass`ï¼š

  - ä»¥ä¸å¸¦ `/` ç»“å°¾çš„å½¢å¼ï¼ˆå¦‚ `http://www.proxy.com`ï¼‰ï¼šä¼šä¿ç•™åŸå§‹è·¯å¾„å‰ç¼€ï¼›
  - ä»¥ `/` æˆ–å­è·¯å¾„ç»“å°¾ï¼ˆå¦‚ `http://www.proxy.com/`ã€`http://www.proxy.com/bbb`ï¼‰ï¼šä¼šæ›¿æ¢æ‰ `location` çš„é‚£ä¸€æ®µå‰ç¼€ã€‚

> ç®€å•è®°å¿†ï¼šroot æ˜¯ã€Œå‰ç¼€ + åŸè·¯å¾„ã€ï¼Œproxy_pass åˆ™å–å†³äºä½ æœ€åå†™æ²¡å†™ /ã€‚

## å…«ã€nginx åšä»£ç†æœåŠ¡å™¨ï¼šèƒ½ç”¨ï¼Œä½†åˆ«å¤ªä¾èµ– ##

ç†è®ºä¸Šï¼Œä½ ç”šè‡³å¯ä»¥ç”¨ nginx æ­ä¸€ä¸ªé€šç”¨ HTTP ä»£ç†ï¼š

```nginx
# ä»£ç†æœåŠ¡å™¨
server {
    listen   6587;
    resolver 8.8.8.8;

    location / {
        proxy_pass http://$http_host$request_uri;
        #allow 127.0.0.1;
        #deny all;
    }
}
```

ç„¶åæŠŠæµè§ˆå™¨çš„ä»£ç†è®¾ç½®æˆ `192.168.1.111:6587`ï¼ˆå‡è®¾ nginx åœ¨è¿™å°æœºå™¨ï¼‰ã€‚

è¿™ç©æ„å„¿èƒ½è·‘ï¼Œä½†é—®é¢˜ä¹Ÿå¾ˆå¤šï¼š

- ä¸æ”¯æŒ HTTPS é€æ˜è½¬å‘ï¼›
- å¯¹æŸäº›åè®® / å¤´éƒ¨æ”¯æŒä¸å®Œå–„ï¼›
- ç¨³å®šæ€§å’Œè§‚æµ‹èƒ½åŠ›éƒ½æ¯”ä¸“ä¸šä»£ç†å·®å¤ªå¤šã€‚

å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ï¼Œæ›´æ¨èç”¨ï¼š

- ä¸“é—¨çš„ HTTP/HTTPS ä»£ç†ï¼ˆmitmproxyã€Squidã€Charles ç­‰ï¼‰ï¼›
- æˆ–è€…åœ¨ç½‘å…³ / sidecar å±‚åšç»Ÿä¸€ä»£ç†é€»è¾‘ã€‚

> æŠŠ nginx å½“ä¸‡èƒ½ä»£ç†å·¥å…·ï¼Œåªæ˜¯ã€Œèƒ½ç”¨ã€ï¼ŒæŠŠå®ƒå½“æˆæ¸…æ™°çš„æµé‡å…¥å£ï¼Œæ‰æ˜¯ã€Œå¥½ç”¨ã€çš„æ­£ç¡®æ‰“å¼€æ–¹å¼ã€‚

## ä¹ã€æ€»ç»“ï¼šè®© nginx çœŸæ­£æˆä¸ºã€Œæµé‡å…¥å£çš„å·¥ç¨‹è®¾æ–½ã€ ##

- HTTPS å±‚é¢ï¼Œnginx çš„ç›®æ ‡æ˜¯ï¼š*è®©è¯ä¹¦æ¥å…¥å’Œ HTTPâ†’HTTPS è·³è½¬å˜æˆæ ‡å‡†å¥—è·¯*ï¼›
- åå‘ä»£ç†å±‚é¢ï¼Œå®ƒæ˜¯æœ€å¤–é¢é‚£å±‚ã€Œå¹²å‡€çš„æµé‡è·¯ç”±ã€ï¼Œåªåšåè®®ç›¸å…³çš„äº‹æƒ…ï¼›
è·¨åŸŸå±‚é¢ï¼Œåœ¨å…¥å£ç»Ÿä¸€åŠ  CORSï¼Œæ¯”åœ¨æ¯ä¸ªåç«¯æœåŠ¡é‡Œæ•£ç€å†™è¦å¯é ï¼›
- åŸŸåä¸æ³›åŸŸåå±‚é¢ï¼Œé€šè¿‡æ­£åˆ™ `server_name` + `resolver` + `hash bucket`ï¼Œå¯ä»¥ä¼˜é›…åœ°ç®¡ç†ä¸€å †å†å²åŸŸåä¸å­åŸŸåï¼›
- è·¯å¾„ä¸è½¬å‘å±‚é¢ï¼Œææ¸…æ¥š `root` ä¸ `proxy_pass` çš„æ‹¼æ¥è§„åˆ™ï¼Œå°±èƒ½å°‘æ‰ä¸€å¤§åŠã€Œæ€ä¹ˆè½¬å‘åˆ°å¥‡æ€ªè·¯å¾„ã€çš„ Bugã€‚

> å…¨å±€å˜é‡ã€è°ƒè¯•æ€è·¯ä¸å¯è§‚æµ‹æ€§

## å¼•è¨€ï¼šå½“ä½ åªå‰©ä¸‹ä¸€è¡Œ `access.log` å¯ä»¥çœ‹ ##

çº¿ä¸Šå‡ºé—®é¢˜çš„æ—¶å€™ï¼Œnginx å¾€å¾€æ˜¯ç¦»ç”¨æˆ·æœ€è¿‘ã€ç¦»åº”ç”¨æœ€è¿œçš„ä¸€å±‚ã€‚

å¦‚æœè¿™æ—¶å€™ï¼š

- åº”ç”¨æ—¥å¿—è¿˜æ²¡å†™åˆ°ï¼›
- APM æ²¡æœ‰è¦†ç›–åˆ°å…¥å£å±‚ï¼›
- ç›‘æ§å›¾ä¸Šåªçœ‹åˆ°ä¸€æ¡å¹³èººçš„ 5xx æ›²çº¿ï¼›

ä½ æœ€åèƒ½æŠ“å¾—ä½çš„ï¼Œå¯èƒ½å°±åªæœ‰*nginx çš„è®¿é—®æ—¥å¿—å’Œé‚£ä¸€å † $ å¼€å¤´çš„å†…ç½®å˜é‡*ã€‚

å¾ˆå¤šäººçŸ¥é“ `$remote_addr`ã€`$request_uri` è¿™äº›å˜é‡çš„å­˜åœ¨ï¼Œ

ä½†å¾ˆå°‘ç³»ç»Ÿæ€§åœ°ç”¨å®ƒä»¬æ¥ï¼š

- å¿«é€Ÿå®šä½ã€Œæ˜¯è°ã€å‘èµ·çš„è¯·æ±‚ï¼›
- çœ‹æ¸…æ¥šã€Œè¯·æ±‚åˆ°åº•é•¿ä»€ä¹ˆæ ·ã€ï¼›
- åœ¨æ—¥å¿—é‡Œè¿˜åŸã€Œè¯·æ±‚åœ¨å„ç§åä»£ / è·³è½¬ä¸­ç»å†äº†ä»€ä¹ˆã€ã€‚

è¿™ä¸€ç¯‡ï¼Œæˆ‘ä»¬ä¸å†è®²æ›´å¤šé…ç½®æŠ€å·§ï¼Œè€Œæ˜¯èšç„¦ä¸‰ä»¶äº‹ï¼š

- nginx çš„æ ¸å¿ƒå†…ç½®å˜é‡åˆ°åº•æœ‰å“ªäº›å€¼å¾—è®°ï¼›
- å¦‚ä½•ç”¨è¿™äº›å˜é‡æŠŠã€Œè¯·æ±‚ä¸Šä¸‹æ–‡ã€å†™è¿›æ—¥å¿—ï¼›
- åœ¨çœŸå®æ’éšœåœºæ™¯é‡Œï¼Œå¦‚ä½•é è¿™äº›å˜é‡å¿«é€Ÿåˆ¤æ–­é—®é¢˜å‡ºåœ¨å…¥å£ã€ç½‘å…³è¿˜æ˜¯åº”ç”¨ã€‚

## ä¸€ã€nginx å†…ç½®å˜é‡ï¼šæŠŠã€Œè¯·æ±‚å…ƒä¿¡æ¯ã€å˜æˆå¯ç”¨æ•°æ® ##

nginx å†…ç½®äº†å¤§é‡ $ å¼€å¤´çš„å˜é‡ï¼Œå¤§å¤šæ˜¯ä» HTTP å¤´ã€è¿æ¥ä¿¡æ¯æˆ–å†…éƒ¨çŠ¶æ€é‡ŒæŠ½å‡ºæ¥çš„ã€‚

ä½ å¯ä»¥ç®€å•ç†è§£æˆï¼šã€Œä¸€ä¸ªè¯·æ±‚ä»å¤–é¢åˆ°é‡Œé¢ï¼Œæ²¿é€”æ‰€æœ‰å…³é”®èŠ‚ç‚¹çš„å¿«ç…§ã€ã€‚

### å®æˆ˜ä¸­æœ€å¸¸ç”¨ã€å€¼å¾—èƒŒä¸‹æ¥çš„é‚£ä¸€æ‰¹ ###

ä»¥ä¸‹è¿™äº›åŸºæœ¬å±äºã€Œæ—¥å¸¸è°ƒè¯•å¿…å¤‡ã€çº§åˆ«ï¼ˆå‡å·²åœ¨å®è·µä¸­éªŒè¯ï¼‰ï¼š

- `$remote_addr`ï¼šå®¢æˆ·ç«¯ IP åœ°å€ï¼›
- `$remote_port`ï¼šå®¢æˆ·ç«¯æºç«¯å£ï¼›
- `$http_host`ï¼šè¯·æ±‚å¤´é‡Œçš„ Hostï¼ˆç­‰ä»·äº `request.getHeader('Host')`ï¼‰ï¼›
- `$http_origin`ï¼šOrigin è¯·æ±‚å¤´ï¼Œè·¨åŸŸã€å‰ç«¯æ¥æºæ’æŸ¥æ—¶éå¸¸æœ‰ç”¨ï¼›
- `$http_referer`ï¼šReferer è¯·æ±‚å¤´ï¼Œå¯ä»¥çœ‹è¯·æ±‚ä»å“ªä¸ªé¡µé¢å‘å‡ºï¼›
- `$request_uri`ï¼šåŸå§‹è¯·æ±‚ URIï¼ŒåŒ…å« queryï¼Œä½†ä¸å«ä¸»æœºåï¼Œä¾‹å¦‚ `/foo/bar?a=1&b=2`ï¼›
- `$uri / $document_uri`ï¼šå½“å‰å†…éƒ¨å¤„ç†ç”¨çš„ URIï¼Œä¸å« queryï¼›
- `$args / $query_string`ï¼šURL æŸ¥è¯¢å‚æ•°ï¼›
- `$server_name`ï¼šå‘½ä¸­çš„ server_nameï¼›
- `$server_addr` / `$server_port`ï¼šå½“å‰å¤„ç†è¯·æ±‚çš„ nginx åœ°å€å’Œç«¯å£ï¼›
- `$scheme`ï¼šhttp æˆ– httpsã€‚

**å‡ ä¸ªå®¹æ˜“æ··æ·†çš„ç‚¹**ï¼š

- `$request_uri` vs `$uri`ï¼š
  - `$request_uri` = ç”¨æˆ·åŸæ ·è¯·æ±‚è·¯å¾„ + æŸ¥è¯¢å‚æ•°ï¼ˆé™¤éè¢« `rewrite ... redirect/permanent` æ”¹å†™ï¼‰ï¼›
  - `$uri` / `$document_uri` = å½“å‰è¯·æ±‚åœ¨ `nginx` å†…éƒ¨çš„ URIï¼Œå¯èƒ½è¢«å†…éƒ¨ `rewrite` æ”¹è¿‡ã€‚

- `$http_origin` vs `$http_referer`ï¼š
  - `$http_origin`ï¼šè°ƒç”¨æ–¹çš„åŸŸåï¼ˆå¦‚ `https://www.example.com`ï¼‰ï¼Œæ›´é€‚åˆåš CORS åˆ¤æ–­ï¼›
  - `$http_referer`ï¼šä¸å« `hash` çš„å®Œæ•´ URLï¼ˆå¦‚ `https://www.example.com/page?a=1`ï¼‰ï¼Œé€‚åˆåšè¡Œä¸ºåˆ†æã€‚

> ä¸€ä¸ªç®€å•çš„ç»éªŒæ˜¯ï¼šå¦‚æœä½ åœ¨æŸä¸ªå˜é‡åå‰åŠ ä¸Š `$http_`ï¼Œå¤§æ¦‚ç‡å°±æ˜¯åœ¨æ‹¿å¯¹åº”çš„è¯·æ±‚å¤´ï¼Œæ¯”å¦‚ `$http_user_agent`ã€`$http_cookie` ç­‰ã€‚

### æ¥è‡ªç½‘ç»œä½†ä¹Ÿå€¼å¾—é¡ºæ‰‹ä¸€è®°çš„ä¸€æ‰¹ ###

ä»¥ä¸‹æ˜¯å¸¸è§æ–‡æ¡£é‡Œæåˆ°ã€ä½†å®¹æ˜“è¢«å¿½ç•¥çš„ä¸€äº›å˜é‡ï¼ˆä¸ä¸€ä¸€å®šè¦èƒŒï¼ŒçŸ¥é“æœ‰å°±è¡Œï¼‰ï¼š

- `$content_length`ï¼šè¯·æ±‚å¤´ä¸­çš„ `Content-Length`ï¼›
- `$content_type`ï¼šè¯·æ±‚å¤´ä¸­çš„ `Content-Type`ï¼›
- `$http_user_agent`ï¼š`User-Agent`ï¼›
- `$http_cookie`ï¼šCookieï¼›
- `$limit_rate`ï¼šå¯ä»¥ç”¨æ¥é™åˆ¶æŸä¸ªè¿æ¥çš„ä¼ è¾“é€Ÿç‡ï¼›
- `$request_method`ï¼šè¯·æ±‚æ–¹æ³•ï¼ˆGET / POST / PUT / DELETE ...ï¼‰ï¼›
- `$request_filename`ï¼šç”± `root`/`alias` + URI æ‹¼å‡ºæ¥çš„å®é™…æ–‡ä»¶è·¯å¾„ï¼›
- `$server_protocol`ï¼š`HTTP/1.0` æˆ– `HTTP/1.1` ç­‰ã€‚

è¿™äº›å˜é‡çš„ä»·å€¼ï¼Œåœ¨äºä½ å¯ä»¥æŒ‰éœ€æ‹‰å–å®ƒä»¬ï¼Œæ‹¼æˆä¸€æ¡è¶³å¤Ÿä¿¡æ¯å¯†åº¦çš„æ—¥å¿—ã€‚

## äºŒã€è®© access.log çœŸæ­£ã€Œè¯´äººè¯ã€ï¼šå®šåˆ¶æ—¥å¿—æ ¼å¼ ##

é»˜è®¤çš„ access.log æ ¼å¼é€šå¸¸é•¿è¿™æ ·ï¼š

```nginx
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for"';

access_log logs/access.log main;
```

å¯¹æ’éšœæ¥è¯´ï¼Œå¾ˆå¤šæ—¶å€™ä½ éœ€è¦çš„æ˜¯ï¼š

- è°ƒç”¨æ¥æºï¼ˆ`Origin` / `Referer`ï¼‰ï¼›
- è¯·æ±‚æœ€ç»ˆå‘½ä¸­çš„ URIï¼›
- è¢«è½¬å‘åˆ°å“ªå°åç«¯ï¼›
- æŸäº›ä¸šåŠ¡ Headerï¼ˆå¦‚ traceIdã€userIdï¼‰ã€‚

ä½ å®Œå…¨å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªæ›´ã€Œå·¥ç¨‹åŒ–ã€çš„æ—¥å¿—æ ¼å¼ï¼Œä¾‹å¦‚ï¼š

```nginx
log_format  traceable_main
    '$remote_addr:$remote_port '
    '[$time_local] '
    '"$request" '
    'status=$status '
    'bytes=$body_bytes_sent '
    'host="$host" '
    'origin="$http_origin" '
    'referer="$http_referer" '
    'ua="$http_user_agent" '
    'req_uri="$request_uri" '
    'uri="$uri" '
    'upstream_addr="$upstream_addr" '
    'trace_id="$http_x_trace_id"';

access_log  logs/access.log traceable_main;
```

è¿™æ ·ä¸€æ¡æ—¥å¿—å°±èƒ½å›ç­”å¾ˆå¤šé—®é¢˜ï¼š

- ç”¨æˆ·æ¥è‡ªå“ªä¸ª IPã€å“ªä¸ª Originï¼›
- å®é™…å‘½ä¸­äº†å“ªä¸ª `uri`ï¼ˆè¢« rewrite è¿‡æ²¡æœ‰ï¼‰ï¼›
- è¯·æ±‚è¢«æ‰“åˆ°äº†å“ªä¸ªåç«¯å®ä¾‹ï¼ˆ`$upstream_addr`ï¼‰ï¼›
- traceId æ˜¯ä»€ä¹ˆï¼Œæ–¹ä¾¿è·Ÿåº”ç”¨æ—¥å¿—ä¸²èµ·æ¥ã€‚

> å’Œå…¶åœ¨ç›‘æ§å¹³å°ä¸Šä¸€è„¸æ‡µé€¼ï¼Œä¸å¦‚å¤šç»™ access.log åŠ å‡ ä¸ªå˜é‡ï¼Œè®©æ¯ä¸€æ¡æ—¥å¿—éƒ½å˜æˆã€Œå¸¦ä¸Šä¸‹æ–‡çš„è¯è¨€ã€ã€‚

## ä¸‰ã€æ’éšœå®æˆ˜ï¼šå˜é‡ + æ—¥å¿—ï¼Œå¿«é€Ÿç¼©å°é—®é¢˜èŒƒå›´ ##

è¯´å‡ ä¸ªéå¸¸æ—¥å¸¸çš„æ’éšœé—®é¢˜ï¼Œçœ‹çœ‹å˜é‡å¦‚ä½•å¸®ä½ ã€Œå®šç‚¹æ‰“å‡»ã€ã€‚

### åœºæ™¯ä¸€ï¼šç”¨æˆ·è¯´ã€Œå¶å‘ 502ã€ï¼Œä½†åç«¯å‹æ ¹æ²¡çœ‹åˆ°è¯·æ±‚ ###

ç°è±¡ï¼š

- å®¢æˆ·ç«¯æ—¥å¿—çœ‹åˆ° 502ï¼›
- åç«¯åº”ç”¨å’Œç½‘å…³æ²¡æœ‰å¯¹åº” traceï¼›
- åªæœ‰ nginx å±‚æœ‰ 502ã€‚

å¯ä»¥åœ¨ access.log é‡Œé‡ç‚¹çœ‹ï¼š

- `$upstream_addr`ï¼šæœ‰æ²¡æœ‰çœŸæ­£è½¬å‘åˆ°åç«¯ï¼Ÿ
- `$upstream_status`ï¼šåç«¯è¿”å›çš„çŠ¶æ€ç ï¼ˆå¦‚æœæœ‰ï¼‰ï¼›
- `$request_time` / `$upstream_response_time`ï¼šè¯·æ±‚åœ¨å“ªä¸€æ®µè€—æ—¶ã€‚

ç¤ºä¾‹æ—¥å¿—æ ¼å¼è°ƒæ•´ï¼š

```nginx
log_format with_upstream
    '$remote_addr - [$time_local] '
    '"$request" status=$status '
    'req_time=$request_time '
    'upstream="$upstream_addr" '
    'upstream_status="$upstream_status" '
    'upstream_time="$upstream_response_time"';
```

å¦‚æœä½ çœ‹åˆ°ï¼š

- `status=502`ï¼›
- `upstream=""`ï¼ˆç©ºï¼‰ï¼›
- æˆ–è€… `upstream` æŒ‡å‘æŸäº›ç‰¹å®š IP/ç«¯å£ï¼Œ`upstream_status` æ˜¯ 502/504ï¼›

å°±å¯ä»¥å¾ˆå¿«åˆ¤æ–­ï¼š

- è¦ä¹ˆæ˜¯ `upstream` é…ç½®ä¸å¯¹ / æœåŠ¡ä¸é€šï¼›
- è¦ä¹ˆæ˜¯æŸä¸ªåç«¯å®ä¾‹æŒ‚äº†ã€‚

### åœºæ™¯äºŒï¼šè·¨åŸŸé—®é¢˜ï¼Œå‰ç«¯è¯´ã€Œæˆ‘æ²¡è·¨åŸŸã€ï¼Œåç«¯è¯´ã€Œæˆ‘æ²¡çœ‹åˆ°è¯·æ±‚ã€ ###

è¿™æ—¶å€™ `$http_origin` å’Œ `$http_referer` å°±å¾ˆæœ‰ç”¨ã€‚

ä½ å¯ä»¥è¿™æ ·å…ˆåŠ ä¸€æ¡ä¸´æ—¶æ—¥å¿—ï¼š

```nginx
log_format cors_debug
    '$remote_addr [$time_local] '
    'method=$request_method '
    'host="$host" '
    'origin="$http_origin" '
    'referer="$http_referer" '
    'uri="$request_uri" '
    'status=$status';

access_log logs/cors_debug.log cors_debug;
```

ç„¶åä¸“é—¨æŠ“ä¸€æ®µæ—¶é—´è®¿é—®ï¼š

- çœ‹çœ‹ `$http_origin` åˆ°åº•æ˜¯ä»€ä¹ˆï¼ˆå¾ˆå¤šæ—¶å€™æ˜¯å†™é”™äº† schema / å­åŸŸåï¼‰ï¼›
- OPTIONS è¯·æ±‚åˆ°åº•æœ‰æ²¡æœ‰æ‰“åˆ°è¿™å° nginx / è¿™ä¸ª `location` ä¸Šï¼›
- æ˜¯ nginx ç›´æ¥å›äº† 4xxï¼Œè¿˜æ˜¯ upstream æ‹’ç»çš„ã€‚

### åœºæ™¯ä¸‰ï¼šæ€€ç–‘æŸä¸ªç”¨æˆ·è„šæœ¬ / çˆ¬è™«æŠŠä½ æ‰“æŒ‚äº† ###

è¿™æ—¶å€™ç»„åˆçš„å˜é‡å¯èƒ½æ˜¯ï¼š

- `$remote_addr` + `$remote_port`ï¼›
- `$http_user_agent`ï¼›
- `$http_referer`ï¼›
- `$request_uri`ã€‚

ä½ å¯ä»¥ï¼š

- å…ˆç”¨ `grep` æŠŠæŸä¸ªå¯ç–‘ IP æˆ– UA çš„è®¿é—®æ‹‰å‡ºæ¥ï¼›
- è§‚å¯Ÿå®ƒçš„è¡Œä¸ºæ¨¡å¼ï¼ˆURIã€é¢‘ç‡ã€æ˜¯å¦éå†æ‰€æœ‰è·¯å¾„ï¼‰ï¼›
- å†è€ƒè™‘åœ¨ nginx ä¸Šåšé™æµæˆ–å°ç¦ã€‚

> è¿™é‡Œçš„å…³é”®å§‹ç»ˆæ˜¯ï¼šåœ¨è¯·æ±‚åˆšåˆšè¿›å…¥ç³»ç»Ÿçš„æ—¶å€™ï¼Œå°±æ•è·è¶³å¤Ÿå¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

## å››ã€ç”¨å˜é‡åšä¸€ç‚¹ã€Œè½»é‡é€»è¾‘ã€ï¼šæŒ‰æ¥æºåšå·®å¼‚åŒ–å¤„ç† ##

è™½ç„¶ä¸æ¨èåœ¨ nginx é‡Œå†™å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œä½†åŸºäºå˜é‡åšä¸€ç‚¹è½»é‡åˆ†æµè¿˜æ˜¯å¾ˆå¸¸è§çš„ã€‚

### æŒ‰åŸŸå / Origin åšç®€å•ç™½åå• ###

ä¾‹å¦‚åªå…è®¸æŸäº›åŸŸçš„å‰ç«¯è°ƒç”¨æŸä¸ªæ¥å£ï¼š

```nginx
location /api/internal {
    if ($http_origin !~* ^https?://(www\.trusted\.com|admin\.trusted\.com)$) {
        return 403;
    }

    proxy_pass http://127.0.0.1:9000;
}
```

è¿™é‡Œçš„å…³é”®å°±æ˜¯ `$http_origin` å’Œæ­£åˆ™çš„ä¸€èµ·ä½¿ç”¨ã€‚

### æŒ‰ UA åšç®€å•ç°åº¦ / é™çº§ ###

åœ¨çœŸÂ·ç´§æ€¥æƒ…å†µï¼ˆèƒŒé”…ç°åœºï¼‰ä¸‹ï¼Œä¹Ÿæœ‰äººä¼šç”¨ nginx åšä¸€ç‚¹ UA çº§åˆ«çš„é™çº§ï¼š

```nginx
location /feature-heavy {
    if ($http_user_agent ~* 'MSIE|Trident') {
        # è€æµè§ˆå™¨ç›´æ¥ç»™é™çº§é¡µ
        return 200 'æ‚¨çš„æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½ï¼Œå»ºè®®ä½¿ç”¨ç°ä»£æµè§ˆå™¨è®¿é—®æœ¬åŠŸèƒ½';
    }

    proxy_pass http://127.0.0.1:9001;
}
```

è¿™ç±»é€»è¾‘ä¸å»ºè®®é•¿æœŸå­˜åœ¨ï¼Œä½†åœ¨ã€Œä¸€å°æ—¶å†…å¿…é¡»æ­¢è¡€ã€çš„åœºæ™¯ä¸‹ï¼Œå˜é‡ + ç®€å•åˆ¤æ–­ä¼šéå¸¸å¥½ç”¨ã€‚

## äº”ã€ä»å˜é‡åˆ°å¯è§‚æµ‹æ€§ï¼šè®© nginx ä¸å†æ˜¯ã€Œé»‘ç›’ã€ ##

å¦‚æœæ”¾åœ¨ä¸€èµ·çœ‹ï¼Œä¼šå‘ç°ä¸€ä¸ªæ¼”è¿›è·¯å¾„ï¼š

- ã€Œè·¯ç”±è§„åˆ™ã€ï¼šè¯·æ±‚åˆ°åº•ä¼šå‘½ä¸­å“ªæ¡ locationï¼›
- ã€Œæµé‡å…¥å£ã€ï¼šåŸŸåã€TLSã€è½¬å‘ã€è·¨åŸŸã€æ³›åŸŸåè¿™äº›å…¥å£å±‚èŒè´£ï¼›
- ã€Œå¯è§‚æµ‹æ€§ã€ï¼šæ€ä¹ˆçŸ¥é“è¿™ä¸€å±‚åˆ°åº•å¹²äº†ä»€ä¹ˆã€‚

å†…ç½®å˜é‡æ˜¯ nginx ç»™ä½ çš„ã€Œè§‚å¯Ÿçª—å£ã€ï¼š

- ä½ å¯ä»¥ç”¨å®ƒä»¬å®šåˆ¶ access.logï¼Œè®©æ¯æ¡æ—¥å¿—éƒ½å¸¦ä¸Šå…³é”®ä¸Šä¸‹æ–‡ï¼›
- å¯ä»¥åœ¨å…³é”®è·¯å¾„ä¸Šè¾“å‡ºå¿…è¦çš„ debug ä¿¡æ¯ï¼Œå¿«é€Ÿç¼©å°é—®é¢˜èŒƒå›´ï¼›
- å¯ä»¥ç”¨ç®€å•çš„æ¡ä»¶åˆ¤æ–­ï¼Œå¯¹ä¸åŒæ¥æºã€ä¸åŒ UA åšè½»é‡çš„è·¯ç”±å·®å¼‚åŒ–ã€‚

> çœŸæ­£æˆç†Ÿçš„ nginx ä½¿ç”¨æ–¹å¼ï¼Œä¸æ˜¯ã€ŒèƒŒä¸€å †æŒ‡ä»¤ã€ï¼Œè€Œæ˜¯è®©å®ƒå˜æˆï¼šæ—¢èƒ½ç¨³ç¨³æ‰›ä½æµé‡ï¼Œåˆèƒ½åœ¨å‡ºé—®é¢˜æ—¶ï¼Œç»™ä½ è¶³å¤Ÿå¤šçš„çº¿ç´¢ã€‚

## å°¾å£°ï¼šä»ä¼šé… nginxï¼Œåˆ°æ•¢æŠŠ nginx å½“ã€Œå·¥ç¨‹è®¾æ–½ã€ ##

å›é¡¾ï¼š

- ä½ åº”è¯¥å·²ç»èƒ½æ¯”è¾ƒè‡ªä¿¡åœ°å›ç­”ï¼šæŸä¸ªè·¯å¾„æœ€ç»ˆä¼šå‘½ä¸­å“ªæ¡ locationï¼Œä¼šä¸ä¼šè¢«æ­£åˆ™æˆªèƒ¡ï¼›
- ä½ å¤§æ¦‚ä¹Ÿèƒ½è®¾è®¡ä¸€å¥—æ¯”è¾ƒå¹²å‡€çš„å…¥å£å±‚ï¼šåŸŸåå½’ä¸€ã€HTTPSã€åå‘ä»£ç†ã€CORSã€æ³›åŸŸåï¼›
- æœ€åï¼Œä½ æœ‰èƒ½åŠ›ä¸º nginx åŠ ä¸Šä¸€å±‚å¯è§‚æµ‹æ€§ï¼šå˜é‡ã€æ—¥å¿—ã€ç®€å•çš„è°ƒè¯•é€»è¾‘ã€‚


ä¼šå†™ nginx é…ç½®ï¼Œåªæ˜¯æŠŠç³»ç»Ÿã€Œæ­èµ·æ¥ã€ï¼›æ•¢æŠŠ nginx å½“æˆå·¥ç¨‹è®¾æ–½æ¥è®¾è®¡ï¼Œæ‰ç®—æ˜¯çœŸæ­£æŠŠå®ƒã€Œç”¨èµ·æ¥ã€ã€‚

å½“ä½ ä¸‹æ¬¡çœ‹åˆ°ä¸€è¡Œ `$http_origin` æˆ– `$request_uri` æ—¶ï¼Œä¹Ÿè®¸ä¼šæ„è¯†åˆ°ï¼šå®ƒä¸æ˜¯ä¸€ä¸ªéšæ‰‹æŠ„æ¥çš„å˜é‡ï¼Œè€Œæ˜¯ä½ å’Œå¤æ‚ç³»ç»Ÿå¯¹è¯çš„ä¸€åªæ¢é’ˆã€‚

## åŒä¸€URL æ ¹æ®è®¾å¤‡åŠ è½½ä¸åŒé¡µé¢ ##

### å‰è¨€ ###

å› ä¸ºå†å²çš„åŸå› ï¼Œå…¬å¸å†…éƒ¨æœ‰ä¸€ä¸ªç³»ç»Ÿé’ˆå¯¹æ‰‹æœºç«¯å’Œç”µè„‘ç«¯åˆ†åˆ«åšäº†ä¸€å¥—å‰ç«¯çš„ `spa` é¡µé¢ï¼Œä½†æ˜¯ä¸šåŠ¡æ–¹è¿˜æ˜¯å¸Œæœ›é€šè¿‡ä¸åŒè®¾å¤‡è®¿é—®åŒä¸€ä¸ªåœ°å€çš„æ—¶å€™ï¼Œæ‰‹æœºç«¯åŠ è½½æ‰‹æœºç«¯çš„é¡µé¢ï¼Œç”µè„‘ç«¯å°±å»åŠ è½½ç”µè„‘ç«¯çš„é¡µé¢ã€‚

è¯¥å¦‚ä½•å®ç°è¿™è¯¥æ­»çš„éœ€æ±‚å‘¢ï¼Ÿ

### æ–¹æ¡ˆ ###

#### é—®é¢˜æ‹†è§£ ####

**é—®**ï¼šå®šå¿ƒæƒ³ä¸€ä¸‹ï¼Œè¦å®ç°è¿™ä¸ªéœ€æ±‚æˆ‘ä»¬éœ€è¦è§£å†³çš„æœ€æ ¹æœ¬çš„é—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

**ç­”**ï¼šæ ¹æœ¬è¦è§£å†³çš„é—®é¢˜æ˜¯åŒºåˆ†ä¸åŒçš„è®¾å¤‡ï¼Œå¯¹ç›¸åŒçš„URLåœ°å€ï¼Œè¿”å›å¯¹åº”è®¾å¤‡çš„å…¥å£htmlæ–‡ä»¶ã€‚

**é—®**ï¼šé‚£è¯¥å¦‚ä½•åŒºåˆ†ä¸åŒè®¾å¤‡å‘¢?

**ç­”**ï¼šæˆ‘ä»¬å¯ä»¥åœ¨nginxä¸­ï¼Œæ ¹æ®è¯·æ±‚å¤´ä¸­çš„uaåŒºåˆ†æ˜¯ç§»åŠ¨ç«¯è®¾å¤‡è¿˜æ˜¯ç”µè„‘ç«¯è®¾å¤‡ã€‚
é—®ï¼šé‚£å…·ä½“è¯¥æ€ä¹ˆé…ç½®å‘¢?

#### å…·ä½“é…ç½® ####

```nginx
server {
    listen 9999;

    root /www/data/source;

    # é»˜è®¤å…¥å£æ˜¯pc
    set $index_file /index-pc.html; 
    if ($http_user_agent ~* "(android|iphone|ipad|ipod|mobile)") {
         # æ‰‹æœºç«¯å…¥å£
         set $index_file /index-mobile.html; 
    }

    if ($arg_isMobile != "") {
        # ç‰¹æ®Šéœ€è¦ å¦‚æœè·¯å¾„ä¸Šå¸¦isMobileä¹ŸåŠ è½½æ‰‹æœºç«¯å…¥å£é¡µé¢
        set $index_file /index-mobile.html; 
    }


   location / {
       # é¡ºåºåŒ¹é… é»˜è®¤åŒ¹é…è·¯å¾„  å¦åˆ™è¿”å›pcæˆ–mobileå…¥å£html
       try_files $uri $index_file;
    }
}
```

#### è§£å†³ ####

é€šè¿‡uaçš„åˆ¤æ–­ï¼Œé’ˆå¯¹ç›¸åŒçš„è¯·æ±‚URLåŠ è½½å¯¹åº”è®¾å¤‡çš„å…¥å£htmlæ–‡ä»¶ã€‚

#### æ³¨æ„ç‚¹ ####

è¿™ä¸ªè§£å†³æ–¹æ¡ˆæœ‰ä¸€ä¸ªè¦æ±‚æ˜¯ä¸¤ä¸ªç«¯æ„å»ºåçš„èµ„æºéœ€è¦ä¸Šä¼ åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹é¢ï¼Œå¹¶ä¸”è¦ä¿®æ”¹å…¥å£htmlåç§°åŒºåˆ†ä¸åŒç«¯çš„å…¥å£ã€‚æ‹…å¿ƒé™æ€èµ„æº(js,css,img)æ··ä¹±çš„è¯ï¼Œå¯ä»¥åœ¨æ„å»ºçš„æ—¶å€™,æŠŠé™æ€èµ„æºä¹Ÿç”¨ç›®å½•åŒºåˆ†å¼€ï¼Œæ¯”å¦‚ç”µè„‘ç«¯é™æ€èµ„æºæ„å»ºåˆ° `pc` ç›®å½•ä¸‹ï¼Œæ‰‹æœºç«¯çš„èµ„æºæ„å»ºåˆ° `mobile` ç›®å½•ä¸‹ã€‚

### ç»“è¯­ ###

æ²¡æœ‰æœ€å¥½çš„æ–¹æ¡ˆï¼Œåªæœ‰æœ€é€‚åˆä¸šåŠ¡éœ€æ±‚çš„æ–¹æ¡ˆã€‚

> ä½ åœ¨ç»™æŸè¿é”å¥èº«æˆ¿åšã€Œä¼šå‘˜æ‰«ç ç­¾åˆ°ã€ç³»ç»Ÿã€‚

éœ€æ±‚å¾ˆæ˜ç¡®ï¼š

- å‰å°è´´ä¸€å¼ äºŒç»´ç ï¼Œæ•™ç»ƒå’Œä¼šå‘˜éƒ½æ‰«å®ƒï¼›
- æ•™ç»ƒç”¨ PC åå°ç®¡ç†ï¼Œè¦æ‰“å¼€ Web ç®¡ç†ç³»ç»Ÿï¼ˆReactï¼‰ï¼›
- ä¼šå‘˜ç”¨æ‰‹æœºæ‰«ç ï¼Œè¦è·³è½¬ H5 è½»åº”ç”¨ï¼ˆVueï¼‰ï¼›

ç»“æœç¬¬ä¸€ç‰ˆä¸Šçº¿ï¼Œä¼šå‘˜æ‰«å®Œç›´æ¥è¿›äº†åå°é¦–é¡µï¼Œä¸€è„¸æ‡µï¼šâ€œè¿™è¡¨æ ¼æ˜¯å¹²å•¥çš„ï¼Ÿâ€

ä½ ç«‹åˆ»æ„è¯†åˆ°ï¼šåŒä¸€ä¸ªé“¾æ¥ï¼Œå¿…é¡»æ™ºèƒ½åˆ†æµã€‚

## è§£å†³æ–¹æ¡ˆï¼šä¸‰å±‚è¯†åˆ« + æ¸è¿›å¼åŠ è½½ ##

### è¡¨é¢ç”¨æ³•ï¼šç”¨ `User-Agent` åšç¬¬ä¸€é“ç­›å­ ###

```js:router.js
const PC_UA = /Windows|Macintosh|Linux/;
const MOBILE_UA = /Android|iPhone|iPad|iPod/;

function getDeviceType() {
  const ua = navigator.userAgent;
  if (PC_UA.test(ua)) return 'pc';
  if (MOBILE_UA.test(ua)) return 'mobile';
  // ğŸ” é™çº§ï¼šçœ‹å±å¹•å®½åº¦
  return window.innerWidth < 768 ? 'mobile' : 'pc';
}
```

```js:entry.js
async function main() {
  const type = getDeviceType();
  if (type === 'pc') {
    await import('./web-app.js');      // ğŸ” åŠ¨æ€åŠ è½½ PC ç‰ˆ
  } else {
    location.href = 'https://m.corp.com/app'; // ğŸ” è·³ H5
  }
}
main();
```

**å…³é”®ç‚¹**ï¼š

- PC ç«¯ç›´æ¥åŠ è½½ SPAï¼Œä¸è·³è½¬ï¼Œä½“éªŒæ— ç¼ï¼›
- æ‰‹æœºç«¯è·³è½¬åˆ°ç‹¬ç«‹ H5 åŸŸåï¼Œä¾¿äºç‹¬ç«‹è¿­ä»£å’Œ SEOã€‚

### åº•å±‚æœºåˆ¶ï¼šä¸ºä»€ä¹ˆä¸èƒ½åªé  UAï¼Ÿ ###

| **è¯†åˆ«æ–¹å¼**        |      **å‡†ç¡®ç‡**      |      **é£é™©**      |      **é€‚ç”¨åœºæ™¯**      |
| :------------- | :-----------: | :------------- | :-----------: |
|    User-Agent     |      90%      |    å¯ä¼ªé€ ï¼Œéƒ¨åˆ†å¹³æ¿ UA æ¨¡ç³Š     |      å¿«é€Ÿåˆ†æµ    |
|    å±å¹•å°ºå¯¸     |      85%      |    æŠ˜å å±ã€æ¨ªå± iPad æ˜“è¯¯åˆ¤     |      é™çº§å…œåº•    |
|    è§¦æ‘¸æ”¯æŒ     |      95%      |    `maxTouchPoints > 1` æ›´å‡†     |      è¾…åŠ©åˆ¤æ–­    |

æœ€ç»ˆç”¨ **ç»„åˆåˆ¤æ–­** æå‡å‡†ç¡®ç‡ï¼š

```js
function isMobile() {
  const ua = navigator.userAgent;
  if (/Android|iPhone/.test(ua)) return true;
  if (/iPad|Macintosh/.test(ua) && 'ontouchend' in document) return true; // ğŸ” iPadOS
  return window.innerWidth <= 768 && navigator.maxTouchPoints > 1;
}
```

### è®¾è®¡å“²å­¦ï¼šæŠŠâ€œåˆ†æµâ€åšæˆä¸­é—´å±‚æœåŠ¡ ###

ä¸å…¶åœ¨æ¯ä¸ªé¡¹ç›®é‡Œé‡å¤å†™åˆ¤æ–­é€»è¾‘ï¼Œä¸å¦‚æŠ½æˆä¸€ä¸ª *è½»é‡çº§ç½‘å…³å±‚*ï¼š

```js
// gateway.js (Node.js)
app.get('/entry', (req, res) => {
  const { userAgent, 'x-forwarded-for': ip } = req.headers;
  const isMobile = /Android|iPhone|Mobile/.test(userAgent);
  
  if (isMobile) {
    res.redirect('https://m.corp.com/app?from=' + ip); // ğŸ” å¸¦æ¥æºä¿¡æ¯
  } else {
    res.sendFile(path.join(__dirname, 'web/index.html')); // ğŸ” ç›´æ¥å PC é¡µé¢
  }
});
```

è¿™æ ·å‰ç«¯åªç»´æŠ¤ä¸€ä¸ªå…¥å£é¡µï¼Œé€»è¾‘å…¨åœ¨æœåŠ¡ç«¯ï¼Œä¾¿äº**ç°åº¦ã€åŸ‹ç‚¹ã€æ‹¦æˆªçˆ¬è™«**ã€‚

## åº”ç”¨æ‰©å±•ï¼šå¯å¤ç”¨çš„é…ç½®ç‰‡æ®µ ##

### é™æ€é¡µåˆ†æµæ¨¡æ¿ï¼ˆé›¶åç«¯ä¾èµ–ï¼‰ ###

```html
<!-- index.html -->
<script>
  (function() {
    const mobileRegex = /Android|iPhone|iPad|iPod|Mobile/;
    if (mobileRegex.test(navigator.userAgent)) {
      location.replace('https://m.corp.com/app');
    }
    // å¦åˆ™ç»§ç»­åŠ è½½ React/Vue è„šæœ¬
  })();
</script>
```

### ç¯å¢ƒé€‚é…è¯´æ˜ ###

|   åœºæ™¯   |      æ³¨æ„ç‚¹      |
| ------------- | :----------- |
|   å¾®ä¿¡å†…ç½®æµè§ˆå™¨    | UA å« MicroMessengerï¼Œä½†ä»æ˜¯ mobileï¼Œæ­£å¸¸è·³ H5 |
|   iPadOS    | é»˜è®¤ UA åƒ Macï¼Œéœ€æ£€æµ‹ `ontouchend` æˆ– `maxTouchPoints` |
|   PWA å®‰è£…å    | `window.matchMedia('(display-mode: standalone)')` å¯è¯†åˆ«ï¼Œä½†åˆ†æµä¸ä¾èµ–å®ƒ |

## ä¸¾ä¸€åä¸‰ï¼š3 ä¸ªå˜ä½“åœºæ™¯ ##

### App å†…åµŒ H5 æ™ºèƒ½è·³è½¬ ###

åœ¨ UA é‡ŒåŠ è‡ªå®šä¹‰å­—æ®µ `MyApp/1.0`ï¼Œè¯†åˆ«åˆ°åè·³ `myapp://page/signin` å”¤èµ·åŸç”Ÿé¡µã€‚

### PC å¹³æ¿æ··åˆè®¾å¤‡ï¼ˆSurfaceï¼‰ ###

å…ˆæŒ‰ PC åŠ è½½ï¼Œä½†ç›‘å¬é¡µé¢ `touchstart` äº‹ä»¶ï¼Œ3 ç§’å†…æœ‰è§¦æ‘¸åˆ™æç¤ºï¼šâ€œæ£€æµ‹åˆ°è§¦å±ï¼Œæ˜¯å¦åˆ‡æ¢å¹³æ¿æ¨¡å¼ï¼Ÿâ€

### AB æµ‹è¯•åˆ†æµ ###

åœ¨ gateway å±‚åŠ é€»è¾‘ï¼š`Math.random() < 0.1` çš„ mobile ç”¨æˆ·å¼ºåˆ¶çœ‹ PC ç‰ˆï¼Œæ”¶é›†ä½“éªŒåé¦ˆã€‚

## å°ç»“ ##

åˆ«è®©è®¾å¤‡ç±»å‹å†³å®šä»£ç ï¼Œè€Œè¦è®©ä»£ç èªæ˜åœ°è®¤è¯†è®¾å¤‡ã€‚

ç”¨ UA åšå¿«ç­›ï¼Œå°ºå¯¸å’Œè§¦æ‘¸åšå…œåº•ï¼ŒæœåŠ¡ç«¯åšç®¡æ§ï¼Œä¸€ä¸ªé“¾æ¥ä¹Ÿèƒ½èµ°å‡ºä¸¤æ¡è·¯ã€‚
