---
lastUpdated: true
commentabled: true
recommended: true
title: APIæ¥å£å®‰å…¨è®¾è®¡
description: APIæ¥å£å®‰å…¨è®¾è®¡
date: 2026-02-02 13:00:00 
pageClass: blog-page-class
cover: /covers/platform.svg
---

## ä¸€ã€ç­¾åæœºåˆ¶æ¦‚è¿° ##

åœ¨Webåº”ç”¨å¼€å‘ä¸­ï¼ŒAPIæ¥å£çš„å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚éšç€å‰åç«¯åˆ†ç¦»æ¶æ„çš„æ™®åŠï¼Œå¦‚ä½•ç¡®ä¿APIè°ƒç”¨çš„åˆæ³•æ€§ã€é˜²æ­¢æ•°æ®ç¯¡æ”¹ã€æŠµå¾¡é‡æ”¾æ”»å‡»ï¼Œæˆä¸ºæ¯ä¸ªå¼€å‘è€…å¿…é¡»é¢å¯¹çš„é—®é¢˜ã€‚é€šå¸¸æƒ…å†µéƒ½æ˜¯ç­¾åæœºåˆ¶ï¼Œä½†å¦‚ä½•è®¾è®¡å’Œå®ç°ç­¾åæœºåˆ¶éœ€è¦ä»”ç»†è€ƒè™‘ï¼Œæ—¢ä¸èƒ½è¿‡äºç¹çï¼Œå¸¦æ¥å¼€å‘è´Ÿæ‹…ï¼Œä¹Ÿä¸èƒ½å¤ªå°‘ï¼Œç¼ºä¹å®‰å…¨æ€§ã€‚

æœ¬æ–‡å°†ä»‹ç»ä¸€å¥—å®Œæ•´çš„*åŠ¨æ€ç›å€¼* + *æ¥å£ç­¾å*å®‰å…¨æ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- å¤šå±‚é˜²æŠ¤ï¼šåŠ¨æ€ç›å€¼ + æ¥å£ç­¾ååŒé‡éªŒè¯
- é˜²é‡æ”¾æ”»å‡»ï¼šåŸºäºæ—¶é—´æˆ³çš„æœ‰æ•ˆæœŸæ§åˆ¶
- é˜²ç¯¡æ”¹ï¼šå‚æ•°ç­¾åç¡®ä¿æ•°æ®å®Œæ•´æ€§
- çµæ´»é…ç½®ï¼šæ”¯æŒå«å‚æ•°/ä¸å«å‚æ•°ä¸¤ç§ç­¾åæ¨¡å¼
- æ˜“äºæ‰©å±•ï¼šæ”¯æŒå¤šç§ç®—æ³•ï¼ˆSHA-256ã€SM3ç­‰ï¼‰

### é€‚ç”¨åœºæ™¯ ###

- å‰åç«¯åˆ†ç¦»çš„Webåº”ç”¨
- H5é¡µé¢ã€å°ç¨‹åºç­‰å¤šç«¯è°ƒç”¨
- éœ€è¦è¾ƒé«˜å®‰å…¨æ€§çš„ä¸šåŠ¡æ¥å£ï¼ˆæ”¯ä»˜ã€äº¤æ˜“ã€æ•æ„Ÿæ•°æ®æ“ä½œç­‰ï¼‰
- éœ€è¦é˜²æ­¢æ¥å£è¢«æ¶æ„è°ƒç”¨æˆ–åˆ·é‡

### ä¸¤ç§ç­¾åæ¨¡å¼ ###

æ ¹æ®è°ƒç”¨æ–¹æ˜¯å¦èƒ½å®‰å…¨å­˜å‚¨å¯†é’¥ï¼Œæœ¬æ–¹æ¡ˆæ”¯æŒä¸¤ç§ç­¾åæ¨¡å¼ï¼š

#### æ¨¡å¼1ï¼šå‰ç«¯ç­¾åï¼ˆéœ€è¦åŠ¨æ€ç›å€¼ï¼‰ ####

**é€‚ç”¨åœºæ™¯**ï¼š å‰ç«¯ï¼ˆH5ã€å°ç¨‹åºã€ç§»åŠ¨Appï¼‰è°ƒç”¨åç«¯æ¥å£

**æ ¸å¿ƒé—®é¢˜**ï¼š å‰ç«¯æ— æ³•å®‰å…¨å­˜å‚¨å¯†é’¥ï¼ˆsecretKeyï¼‰ï¼Œå¯†é’¥ä¸€æ—¦æš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å–å¹¶ä¼ªé€ ç­¾åã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š ä½¿ç”¨*åŠ¨æ€ç›å€¼*ä½œä¸ºä¸­é—´å±‚ä¿æŠ¤

- å‰ç«¯è¯·æ±‚åŠ¨æ€ç›å€¼ç”Ÿæˆæ¥å£ï¼ˆå…¬å¼€æ¥å£ï¼Œæ— éœ€å¯†é’¥ï¼‰
- æœåŠ¡ç«¯ç”ŸæˆåŠ¨æ€ç›å€¼å¹¶è¿”å›
- å‰ç«¯æºå¸¦åŠ¨æ€ç›å€¼è¯·æ±‚ç­¾åç”Ÿæˆæ¥å£
- æœåŠ¡ç«¯éªŒè¯åŠ¨æ€ç›å€¼åï¼Œä½¿ç”¨å¯†é’¥ç”Ÿæˆç­¾åå¹¶è¿”å›
- å‰ç«¯æºå¸¦ç­¾åè°ƒç”¨ä¸šåŠ¡æ¥å£

**å…³é”®ç‚¹**ï¼š å¯†é’¥å§‹ç»ˆå­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œå‰ç«¯åªèƒ½é€šè¿‡åŠ¨æ€ç›å€¼æ¢å–ç­¾åï¼Œæ— æ³•ç›´æ¥è·å–å¯†é’¥ã€‚

#### æ¨¡å¼2ï¼šåç«¯ç­¾åï¼ˆæ— éœ€åŠ¨æ€ç›å€¼ï¼‰ ####

**é€‚ç”¨åœºæ™¯**ï¼š åç«¯æœåŠ¡ï¼ˆå¾®æœåŠ¡ã€å®šæ—¶ä»»åŠ¡ã€å†…éƒ¨ç³»ç»Ÿï¼‰è°ƒç”¨åç«¯æ¥å£

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š åç«¯å¯ä»¥å®‰å…¨å­˜å‚¨å¯†é’¥ï¼ˆç¯å¢ƒå˜é‡ã€é…ç½®ä¸­å¿ƒã€å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼‰ï¼Œæ— éœ€æ‹…å¿ƒå¯†é’¥æ³„éœ²ã€‚

**ç®€åŒ–æµç¨‹**ï¼š

- åç«¯ç›´æ¥ä½¿ç”¨å¯†é’¥ç”Ÿæˆç­¾åï¼š`SHA256(appCode + secretKey + apiPath + timestamp)`
- åç«¯æºå¸¦ç­¾åè°ƒç”¨ä¸šåŠ¡æ¥å£
- ä¸šåŠ¡æ¥å£éªŒè¯ç­¾å

**å…³é”®ç‚¹**ï¼š è·³è¿‡åŠ¨æ€ç›å€¼æ­¥éª¤ï¼Œç›´æ¥ä½¿ç”¨å¯†é’¥ç­¾åï¼Œæµç¨‹æ›´ç®€æ´é«˜æ•ˆã€‚

### ä¸¤ç§æ¨¡å¼å¯¹æ¯” ###


|  å¯¹æ¯”é¡¹  |  å‰ç«¯ç­¾åï¼ˆéœ€è¦åŠ¨æ€ç›å€¼ï¼‰ |   åç«¯ç­¾åï¼ˆæ— éœ€åŠ¨æ€ç›å€¼ï¼‰  |
| :-----------: | :----: | :----: |
| å¯†é’¥å­˜å‚¨ |  âŒ å‰ç«¯æ— æ³•å®‰å…¨å­˜å‚¨  |  âœ… åç«¯å¯ä»¥å®‰å…¨å­˜å‚¨ |
| åŠ¨æ€ç›å€¼ |  âœ… å¿…é¡»ä½¿ç”¨  |  âŒ ä¸éœ€è¦ |
| è¯·æ±‚æ¬¡æ•° |  3æ¬¡ï¼ˆç›å€¼+ç­¾å+ä¸šåŠ¡ï¼‰  |  1æ¬¡ï¼ˆä¸šåŠ¡æ¥å£ï¼‰ |
| å®‰å…¨æ€§ |  é«˜ï¼ˆå¯†é’¥ä¸æš´éœ²ï¼‰  |  é«˜ï¼ˆå¯†é’¥å®‰å…¨å­˜å‚¨ï¼‰ |
| æµç¨‹å¤æ‚åº¦ |  è¾ƒå¤æ‚  |  ç®€å• |
| å…¸å‹åœºæ™¯ |  H5ã€å°ç¨‹åºã€App  |  å¾®æœåŠ¡ã€å®šæ—¶ä»»åŠ¡ã€å†…éƒ¨ç³»ç»Ÿ |

> é‡è¦æç¤ºï¼š æœ¬æ–‡ä¸»è¦ä»‹ç»"å‰ç«¯ç­¾å"æ¨¡å¼ï¼Œå¦‚æœä½ çš„åœºæ™¯æ˜¯åç«¯æœåŠ¡è°ƒç”¨ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ç¬¬å››ç« ï¼Œä»…ä½¿ç”¨"ä¸å«å‚æ•°ç­¾åç®—æ³•"æˆ–"å«å‚æ•°ç­¾åç®—æ³•"å³å¯ï¼Œæ— éœ€å®ç°åŠ¨æ€ç›å€¼ç›¸å…³é€»è¾‘ã€‚

### æ ¸å¿ƒç»„ä»¶ ###

æœ¬æ–¹æ¡ˆåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

|  ç»„ä»¶  |  è¯´æ˜  |
| :-----------: | :----: |
| APIè°ƒç”¨è€…è¡¨ (api_users) |  å­˜å‚¨è°ƒç”¨æ–¹èº«ä»½æ ‡è¯†ï¼ˆappCodeï¼‰å’Œå¯†é’¥ï¼ˆsecretKeyï¼‰  |
| APIæ¥å£ä¿¡æ¯è¡¨ (api_info) |  å­˜å‚¨æ¥å£è·¯å¾„ã€æ¥å£å›ºå®šç›å€¼ã€é™æµç­–ç•¥ç­‰  |
| APIæƒé™è¡¨ (api_auth) |  æ§åˆ¶è°ƒç”¨æ–¹å¯¹å…·ä½“æ¥å£çš„è®¿é—®æƒé™  |
| åŠ¨æ€ç›å€¼ç”Ÿæˆæ¥å£ |  ä¸ºåç»­è°ƒç”¨ç”Ÿæˆä¸€æ¬¡æ€§åŠ¨æ€ç›å€¼  |
| ç­¾åç”Ÿæˆæ¥å£ |  åŸºäºåŠ¨æ€ç›å€¼å’Œå¯†é’¥ç”Ÿæˆæ¥å£è°ƒç”¨ç­¾å  |
| ä¸šåŠ¡æ¥å£æ‹¦æˆªå™¨ |  åœ¨ä¸šåŠ¡æ¥å£è°ƒç”¨å‰éªŒè¯ç­¾åçš„åˆæ³•æ€§  |

## äºŒã€ç­¾åæœºåˆ¶åŸç† ##

### æ•´ä½“æµç¨‹ ###

ç­¾åæœºåˆ¶çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šé€šè¿‡å¤šæ¬¡æ¡æ‰‹ç¡®ä¿è°ƒç”¨æ–¹èº«ä»½å¯ä¿¡ï¼Œå¹¶ä¸ºæ¯æ¬¡ä¸šåŠ¡è¯·æ±‚ç”Ÿæˆå”¯ä¸€ç­¾åã€‚

å®Œæ•´çš„è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š

```mermaid
sequenceDiagram
    participant H5 as H5å‰ç«¯é¡µé¢
    participant DynamicSaltGenerate as åŠ¨æ€ç›å€¼ç”Ÿæˆæ¥å£
    participant SignGenerate as ç­¾åç”Ÿæˆæ¥å£
    participant SubmitInterface as æŸæäº¤æ¥å£

    Note over H5,DynamicSaltGenerate: 1. è¯·æ±‚ç”ŸæˆåŠ¨æ€ç›å€¼ï¼ˆæ ¹æ®è°ƒç”¨æ–¹å’Œæäº¤æ¥å£ï¼‰
    H5->>DynamicSaltGenerate: è¯·æ±‚ç”Ÿæˆæäº¤æ¥å£çš„åŠ¨æ€ç›å€¼&#x3C;br/>ï¼ˆä¼ å‚è°ƒç”¨æ–¹å’Œæäº¤æ¥å£è·¯å¾„ï¼‰
    DynamicSaltGenerate->>DynamicSaltGenerate: æ ¹æ®è°ƒç”¨æ–¹å’Œæäº¤æ¥å£ç”ŸæˆåŠ¨æ€ç›å€¼&#x3C;br/>hash(è°ƒç”¨æ–¹ + æäº¤æ¥å£è·¯å¾„ + æäº¤æ¥å£ç›å€¼ + å½“å‰æ—¶é—´æˆ³)
    DynamicSaltGenerate-->>H5: è¿”å›åŠ¨æ€ç›å€¼ä¿¡æ¯&#x3C;br/>(æäº¤æ¥å£åŠ¨æ€ç›å€¼ã€åŠ¨æ€ç›å€¼ç”Ÿæˆæ—¶é—´æˆ³ã€æäº¤æ¥å£è·¯å¾„)

    Note over H5, SignGenerate: 2. è¯·æ±‚ç”Ÿæˆæ¥å£è°ƒç”¨ç­¾åï¼ˆæ ¹æ®æ¥å£åŠ¨æ€ç›å€¼å’Œæ¥å£è·¯å¾„ï¼‰
    H5->>H5: è§£æå‚æ•°(æ¥å£åŠ¨æ€ç›å€¼ã€åŠ¨æ€ç›å€¼ç”Ÿæˆæ—¶é—´æˆ³ã€æäº¤æ¥å£è·¯å¾„)
    H5->>SignGenerate: è¯·æ±‚ç­¾å&#x3C;br/>(è°ƒç”¨æ–¹ã€æ¥å£åŠ¨æ€ç›å€¼ã€æäº¤æ¥å£è·¯å¾„ã€ç›å€¼ç”Ÿæˆæ—¶é—´æˆ³)

    Note over SignGenerate: 3. ç”Ÿæˆå¹¶è¿”å›æ¥å£è°ƒç”¨ç­¾åï¼ˆæ ¹æ®è°ƒç”¨æ–¹å’Œç§˜é’¥ä»¥åŠæ¥å£è·¯å¾„ï¼‰
    SignGenerate->>SignGenerate: æƒé™æ ¡éªŒ(æ—¶æ•ˆæ€§ã€æœ¬ç­¾åæ¥å£æƒé™ã€æäº¤æ¥å£æƒé™)
    SignGenerate->>SignGenerate: åŠ¨æ€ç›å€¼æ ¡éªŒï¼ˆç®—æ³•éœ€ä¸ç”Ÿæˆæ—¶ä¸€è‡´ï¼‰&#x3C;br>check(è°ƒç”¨æ–¹ + æäº¤æ¥å£è·¯å¾„ + æäº¤æ¥å£ç›å€¼ + ç›å€¼ç”Ÿæˆæ—¶é—´æˆ³)
    SignGenerate->>SignGenerate: ç”Ÿæˆæ¥å£è°ƒç”¨ç­¾å&#x3C;br/>hash(è°ƒç”¨æ–¹ + ç§˜é’¥ + å½“å‰æ—¶é—´æˆ³ + æäº¤æ¥å£è·¯å¾„æˆ–å‚æ•°) &#x3C;br/>æ³¨æ„ï¼šç­¾åä¸æ ¡éªŒç®—æ³•éœ€ä¿æŒä¸€è‡´ï¼Œå¦‚æœåªhash(è°ƒç”¨æ–¹ + ç§˜é’¥ + å½“å‰æ—¶é—´æˆ³)ä¹Ÿå¯ä»¥ã€‚
    SignGenerate-->>H5: è¿”å›ç­¾åç»“æœ&#x3C;br/>(æäº¤æ¥å£è·¯å¾„ã€ç­¾åã€ç­¾åæ—¶é—´æˆ³)

    Note over H5, SubmitInterface: 4. è°ƒç”¨æŸæäº¤æ¥å£ï¼ˆæºå¸¦ç­¾åï¼‰
    H5->>SubmitInterface: æäº¤æ•°æ®ï¼Œæºå¸¦ç­¾åä¿¡æ¯&#x3C;br/>(è°ƒç”¨æ–¹+æ¥å£è·¯å¾„+ç­¾å+ç­¾åæ—¶é—´æˆ³)

    Note over SubmitInterface: 5. æ¥å£ç­¾åæ ¡éªŒï¼ˆä¿å­˜å‰æ£€æŸ¥ï¼‰
    SubmitInterface->>SubmitInterface: æƒé™æ ¡éªŒ(æ—¶æ•ˆæ€§ã€æœ¬æäº¤æ¥å£æƒé™)
    SubmitInterface->>SubmitInterface: ç­¾åæ ¡éªŒ(æ ¡éªŒç®—æ³•ä¸å‰é¢ç­¾åéœ€ä¿æŒä¸€è‡´)&#x3C;br/>check(è°ƒç”¨æ–¹ + ç§˜é’¥ + ç­¾åæ—¶é—´æˆ³ + æ¥å£è·¯å¾„æˆ–å‚æ•°)
    SubmitInterface-->>H5: è¿”å›å¤„ç†ç»“æœ
```

### ä¸ºä»€ä¹ˆéœ€è¦"åŠ¨æ€ç›å€¼"ï¼Ÿ ###

ä½ å¯èƒ½ä¼šé—®ï¼š*ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”Ÿæˆç­¾åï¼Œè€Œè¦å…ˆç”ŸæˆåŠ¨æ€ç›å€¼ï¼Ÿ*

> æ ¸å¿ƒåŸå› ï¼šå‰ç«¯æ— æ³•å®‰å…¨å­˜å‚¨å¯†é’¥ã€‚

åœ¨å‰ç«¯ç­¾ååœºæ™¯ä¸­ï¼Œå¦‚æœå‰ç«¯ç›´æ¥æŒæœ‰ `secretKey` å¹¶ç”Ÿæˆç­¾åï¼Œå¯†é’¥ä¼šè¢«æš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­ï¼ˆJavaScriptã€ç§»åŠ¨Appçš„é…ç½®æ–‡ä»¶ç­‰ï¼‰ï¼Œä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡æµè§ˆå™¨å¼€å‘è€…å·¥å…·æˆ–åç¼–è¯‘è·å–å¯†é’¥ï¼Œä»è€Œä¼ªé€ ç­¾åã€‚

**åŠ¨æ€ç›å€¼çš„ä½œç”¨**ï¼š

åŠ¨æ€ç›å€¼æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**æ¢ç­¾å‡­è¯**ï¼Œå®ƒè§£å†³äº†å‰ç«¯æ— æ³•æŒæœ‰å¯†é’¥çš„é—®é¢˜ï¼š

- å¯†é’¥éš”ç¦»ï¼šå¯†é’¥ï¼ˆsecretKeyï¼‰å§‹ç»ˆä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œå‰ç«¯æ°¸è¿œæ— æ³•è·å–
- æ—¶æ•ˆä¿æŠ¤ï¼šåŠ¨æ€ç›å€¼ä½œä¸º"ä¸€æ¬¡æ€§ä»¤ç‰Œ"ï¼Œæœ‰ç‹¬ç«‹çš„è¿‡æœŸæ—¶é—´ï¼ˆå¦‚24å°æ—¶ï¼‰
- æ¥å£éš”ç¦»ï¼šæ¯ä¸ªæ¥å£æœ‰ç‹¬ç«‹çš„å›ºå®šç›å€¼ï¼ŒåŠ¨æ€ç›å€¼åŸºäºå›ºå®šç›å€¼ç”Ÿæˆï¼Œç¡®ä¿ä¸åŒæ¥å£çš„ç­¾åäº’ä¸å½±å“
- åŒé‡æ—¶æ•ˆæ§åˆ¶ï¼šåŠ¨æ€ç›å€¼æœ‰æ•ˆæœŸï¼ˆé•¿ï¼Œå¦‚24hï¼‰ + ç­¾åæœ‰æ•ˆæœŸï¼ˆçŸ­ï¼Œå¦‚10minï¼‰ï¼Œå½¢æˆåŒå±‚é˜²æŠ¤

**å¯¹æ¯”ç¤ºæ„**ï¼š

```txt
âŒ ä¸å®‰å…¨æ–¹å¼ï¼ˆå‰ç«¯ç›´æ¥æŒæœ‰å¯†é’¥ï¼‰ï¼š
å‰ç«¯ä»£ç ï¼šconst secretKey = "abc123";  // å¯†é’¥æš´éœ²
å‰ç«¯ç”Ÿæˆç­¾åï¼šsign = SHA256(appCode + secretKey + path + time);

âœ… å®‰å…¨æ–¹å¼ï¼ˆåŠ¨æ€ç›å€¼ï¼‰ï¼š
å‰ç«¯è·å–åŠ¨æ€ç›å€¼ï¼šdynamicSalt = è¯·æ±‚æœåŠ¡ç«¯;  // æ— éœ€å¯†é’¥
å‰ç«¯æ¢å–ç­¾åï¼šsign = è¯·æ±‚æœåŠ¡ç«¯(dynamicSalt);  // æœåŠ¡ç«¯éªŒè¯åè¿”å›ç­¾å
å‰ç«¯è°ƒç”¨ä¸šåŠ¡æ¥å£ï¼šæºå¸¦ sign
```

**é‡è¦è¯´æ˜**ï¼š å¦‚æœæ˜¯*åç«¯ç­¾ååœºæ™¯*ï¼ˆå¦‚å¾®æœåŠ¡è°ƒç”¨ã€å®šæ—¶ä»»åŠ¡ï¼‰ï¼Œåç«¯å¯ä»¥å®‰å…¨å­˜å‚¨å¯†é’¥ï¼Œæ— éœ€ä½¿ç”¨åŠ¨æ€ç›å€¼ï¼Œç›´æ¥ä½¿ç”¨å¯†é’¥ç”Ÿæˆç­¾åå³å¯ã€‚

### å…³é”®è®¾è®¡æ€æƒ³ ###

|  è®¾è®¡ç‚¹  |  è¯´æ˜  |
| :-----------: | :----: |
| åŒé‡æ—¶é—´æˆ³ |  åŠ¨æ€ç›å€¼æ—¶é—´æˆ³ï¼ˆé•¿æ•ˆï¼Œå¦‚24hï¼‰ + ç­¾åæ—¶é—´æˆ³ï¼ˆçŸ­æ•ˆï¼Œå¦‚10minï¼‰  |
| åˆ†å±‚éªŒè¯ |  å…ˆéªŒè¯åŠ¨æ€ç›å€¼æœ‰æ•ˆæ€§ï¼Œå†éªŒè¯ç­¾åæœ‰æ•ˆæ€§  |
| æƒé™åˆ†ç¦» |  APIè°ƒç”¨è€…æƒé™ã€æ¥å£æƒé™ã€è°ƒç”¨è€…-æ¥å£æ˜ å°„æƒé™ä¸‰å±‚ç®¡ç†  |
| ç®—æ³•çµæ´» |  æ”¯æŒ SHA-256ã€SM3 ç­‰å¤šç§å“ˆå¸Œç®—æ³•  |

## ä¸‰ã€åŠ¨æ€ç›å€¼æœºåˆ¶ ##

> é€‚ç”¨åœºæ™¯è¯´æ˜ï¼š æœ¬ç« èŠ‚ä»‹ç»çš„åŠ¨æ€ç›å€¼æœºåˆ¶é€‚ç”¨äº*å‰ç«¯ç­¾ååœºæ™¯*ã€‚å¦‚æœä½ çš„åœºæ™¯æ˜¯åç«¯æœåŠ¡è°ƒç”¨ï¼ˆå¯†é’¥å¯å®‰å…¨å­˜å‚¨ï¼‰ï¼Œå¯ä»¥è·³è¿‡æœ¬ç« ï¼Œç›´æ¥é˜…è¯»ç¬¬å››ç« çš„ç­¾åç®—æ³•ã€‚

### åŠ¨æ€ç›å€¼çš„ç”Ÿæˆ ###

åŠ¨æ€ç›å€¼ç”Ÿæˆç®—æ³•å¦‚ä¸‹ï¼š

```java
// ä¼ªä»£ç 
String dynamicSalt = SHA256(appCode + apiPath + interfaceSalt + saltTimestamp);
```

å‚æ•°è¯´æ˜ï¼š

- `appCode`ï¼šè°ƒç”¨æ–¹æ ‡è¯†ï¼ˆå¦‚ "h5"ã€"miniapp"ï¼‰
- `apiPath`ï¼šç›®æ ‡æ¥å£è·¯å¾„ï¼ˆå¦‚ "/api/order/submit"ï¼‰
- `interfaceSalt`ï¼šæ¥å£å›ºå®šç›å€¼ï¼ˆä» api_info è¡¨è¯»å–ï¼‰
- `saltTimestamp`ï¼šåŠ¨æ€ç›å€¼ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰

å®é™…ä»£ç å®ç°ï¼š

```java
public DynamicSalt generateDynamicSalt(String appCode, String apiPath,
                                       String interfaceSalt, Long saltTimestamp) {
    // æ‹¼æ¥åŸå§‹å­—ç¬¦ä¸²
    String saltSource = appCode + apiPath + interfaceSalt + saltTimestamp;

    // ä½¿ç”¨ SHA-256 è®¡ç®—åŠ¨æ€ç›å€¼
    String dynamicSaltValue = sha256(saltSource);

    // è®¡ç®—è¿‡æœŸæ—¶é—´
    Long ttl = signConfig.getDynamicSaltTtl(); // é»˜è®¤ 24 å°æ—¶
    LocalDateTime expireTime = Instant.ofEpochMilli(saltTimestamp + ttl)
            .atZone(ZoneId.systemDefault())
            .toLocalDateTime();

    return new DynamicSalt(appCode, apiPath, dynamicSaltValue, expireTime, saltTimestamp);
}
```

### åŠ¨æ€ç›å€¼çš„æ ¡éªŒ ###

åœ¨ç­¾åç”Ÿæˆæ¥å£ä¸­ï¼Œéœ€è¦å…ˆæ ¡éªŒå‰ç«¯ä¼ æ¥çš„åŠ¨æ€ç›å€¼æ˜¯å¦åˆæ³•ï¼š

```java
// ä¼ªä»£ç 
boolean validateDynamicSalt(String appCode, String apiPath, String interfaceSalt,
                           String dynamicSalt, Long saltTimestamp) {
    // é‡æ–°è®¡ç®—åŠ¨æ€ç›å€¼
    String expectedSalt = SHA256(appCode + apiPath + interfaceSalt + saltTimestamp);

    // æ¯”å¯¹æ˜¯å¦ä¸€è‡´
    return expectedSalt.equals(dynamicSalt);
}
```

æ ¡éªŒé€»è¾‘ï¼š

- ä½¿ç”¨ç›¸åŒçš„å‚æ•°é‡æ–°è®¡ç®—åŠ¨æ€ç›å€¼
- å°†è®¡ç®—ç»“æœä¸å®¢æˆ·ç«¯ä¼ æ¥çš„åŠ¨æ€ç›å€¼æ¯”å¯¹
- æ ¡éªŒæ—¶é—´æˆ³æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ï¼ˆé€šè¿‡ `saltTimestamp + ttl` åˆ¤æ–­ï¼‰

## ä¸¤ç§æ ¡éªŒæ¨¡å¼ ##

åŠ¨æ€ç›å€¼æ”¯æŒä¸¤ç§æ ¡éªŒæ¨¡å¼ï¼š


|  æ¨¡å¼  |  è¯´æ˜ |   é€‚ç”¨åœºæ™¯  |
| :-----------: | :----: | :----: |
| ç®—æ³•æ ¡éªŒ |  ä¸å­˜å‚¨åŠ¨æ€ç›å€¼ï¼Œæ¯æ¬¡é€šè¿‡ç®—æ³•é‡æ–°è®¡ç®—å¹¶æ¯”å¯¹ |  é»˜è®¤æ¨¡å¼ï¼Œæ€§èƒ½é«˜ï¼Œæ— éœ€é¢å¤–å­˜å‚¨ |
| æ•°æ®åº“æ ¡éªŒ |  å°†åŠ¨æ€ç›å€¼å­˜å…¥ `api_dynamic_salt_log` è¡¨ï¼Œæ ¡éªŒæ—¶æŸ¥è¯¢æ•°æ®åº“ |  éœ€è¦ä¸¥æ ¼æ§åˆ¶ä¸€æ¬¡æ€§ä½¿ç”¨ï¼ˆé˜²æ­¢é‡å¤ä½¿ç”¨ï¼‰ |

é…ç½®æ–¹å¼ï¼ˆ`application.yml`ï¼‰ï¼š

```yaml
sign:
  dynamic-salt:
    ttl: 86400000  # 24å°æ—¶
    validate-from-database: false  # true è¡¨ç¤ºä½¿ç”¨æ•°æ®åº“æ ¡éªŒ
```

## å››ã€ç­¾åç®—æ³•ï¼ˆå«å‚æ•°ä¸ä¸å«å‚æ•°ï¼‰ ##

### ä¸å«å‚æ•°çš„ç­¾åç®—æ³• ###

**ä½¿ç”¨åœºæ™¯**ï¼š GETè¯·æ±‚ã€æ— éœ€æ ¡éªŒå‚æ•°å®Œæ•´æ€§çš„åœºæ™¯

**ç”Ÿæˆç®—æ³•**ï¼š

```java
// ä¼ªä»£ç 
String signature = SHA256(appCode + secretKey + apiPath + timestamp);
```

**å®é™…ä»£ç å®ç°**ï¼š

```java
public Sign generateSign(String appCode, String secretKey, String path) {
    // è·å–å½“å‰æ—¶é—´æˆ³
    long timestamp = System.currentTimeMillis();

    // æ„å»ºç­¾åæºå­—ç¬¦ä¸²
    String signSource = appCode + secretKey + path + timestamp;

    // ä½¿ç”¨ SHA-256 è®¡ç®—ç­¾å
    String signValue = sha256(signSource);

    // è®¡ç®—è¿‡æœŸæ—¶é—´
    long expireTimestamp = timestamp + signConfig.getSignatureTtl(); // é»˜è®¤ 10 åˆ†é’Ÿ

    return new Sign(appCode, path, signValue, timestamp, expireTime);
}
```

**æ ¡éªŒç®—æ³•**ï¼š

```java
// ä¼ªä»£ç 
boolean validateSign(String appCode, String secretKey, String path,
                    String signValue, Long timestamp) {
    // é‡æ–°è®¡ç®—ç­¾å
    String expectedSign = SHA256(appCode + secretKey + path + timestamp);

    // æ¯”å¯¹æ˜¯å¦ä¸€è‡´
    return expectedSign.equals(signValue);
}
```

### å«å‚æ•°çš„ç­¾åç®—æ³• ###

**ä½¿ç”¨åœºæ™¯**ï¼š POSTè¯·æ±‚ã€éœ€è¦é˜²æ­¢å‚æ•°ç¯¡æ”¹çš„åœºæ™¯

**ç”Ÿæˆç®—æ³•**ï¼š

```java
// ä¼ªä»£ç 
String paramsString = buildSignatureSource(params); // å‚æ•°æŒ‰ ASCII æ’åºåæ‹¼æ¥
String signature = SM3(paramsString + appCode + secretKey + apiPath + timestamp);
```

**å®é™…ä»£ç å®ç°**ï¼š

```java
public Sign generateSignWithParams(String appCode, String secretKey, String path,
                                   Map<String, Object> params) {
    // è·å–å½“å‰æ—¶é—´æˆ³
    long timestamp = System.currentTimeMillis();

    // æ„å»ºå‚æ•°å­—ç¬¦ä¸²ï¼ˆæŒ‰ ASCII æ’åºï¼‰
    String paramsSource = SignatureUtil.buildSignatureSource(params);

    // æ„å»ºç­¾åæºå­—ç¬¦ä¸²
    String signSource = paramsSource + appCode + secretKey + path + timestamp;

    // ä½¿ç”¨ SM3 ç®—æ³•è®¡ç®—ç­¾å
    String signValue = SmUtil.sm3(signSource);

    return new Sign(appCode, path, signValue, timestamp, expireTime);
}
```

### å‚æ•°ç­¾åçš„å…³é”®ï¼šå‚æ•°æ’åº ###

ä¸ºç¡®ä¿å‰åç«¯å‚æ•°æ‹¼æ¥é¡ºåºä¸€è‡´ï¼Œéœ€è¦å¯¹å‚æ•°è¿›è¡Œ*ASCIIå­—å…¸åº*æ’åºï¼š

```java
public static String buildSignatureSource(Map<String, Object> parameters) {
    if (parameters.isEmpty()) {
        return "";
    }

    // 1. æŒ‰å­—å…¸åºæ’åºå‚æ•°é”®
    List<String> sortedKeys = new ArrayList<>(parameters.keySet());
    Collections.sort(sortedKeys);

    StringBuilder signatureBuilder = new StringBuilder();
    boolean first = true;

    for (String key : sortedKeys) {
        Object paramValue = parameters.get(key);

        // 2. è·³è¿‡ null å’Œå¤æ‚ç±»å‹
        if (paramValue == null || isComplexType(paramValue)) {
            continue;
        }

        String valueStr = paramValue.toString();
        // 3. è·³è¿‡ç©ºä¸²
        if (valueStr.isEmpty()) {
            continue;
        }

        if (!first) {
            signatureBuilder.append("&");
        }
        first = false;
        signatureBuilder.append(key).append("=").append(valueStr);
    }

    return signatureBuilder.toString();
}
```

**ç¤ºä¾‹**ï¼š

å‡è®¾è¯·æ±‚å‚æ•°ä¸ºï¼š

```json
{
  "userName": "å¼ ä¸‰",
  "mobile": "19212341234",
  "userId": "321123",
  "emptyParam": null,
  "emptyNo": ""
}
```

ç»è¿‡æ’åºå’Œè¿‡æ»¤åï¼Œå‚æ•°å­—ç¬¦ä¸²ä¸ºï¼š

```txt
mobile=19212341234&userId=321123&userName=å¼ ä¸‰
```

æ³¨æ„ï¼š`null` å’Œç©ºå­—ç¬¦ä¸²ä¼šè¢«è·³è¿‡ã€‚

### ä¸¤ç§ç®—æ³•çš„å¯¹æ¯” ###

|  å¯¹æ¯”é¡¹  |  ä¸å«å‚æ•°ç­¾å  |   å«å‚æ•°ç­¾å  |
| :-----------: | :----: | :----: |
| ç®—æ³• |  SHA-256  |  SM3ï¼ˆå›½å¯†ç®—æ³•ï¼‰ |
| ç­¾åå†…å®¹ |  appCode + secretKey + path + timestamp  |  params + appCode + secretKey + path + timestamp |
| å®‰å…¨æ€§ |  ä¸­ç­‰ï¼Œä»…é˜²æ­¢è·¯å¾„ç¯¡æ”¹  |  é«˜ï¼Œé˜²æ­¢å‚æ•°ç¯¡æ”¹ |
| æ€§èƒ½ |  è¾ƒå¿«  |  ç¨æ…¢ï¼ˆéœ€è§£æå‚æ•°ï¼‰ |
| é€‚ç”¨åœºæ™¯ |  GETã€æ— æ•æ„Ÿå‚æ•°çš„æ¥å£  |  POSTã€æ”¯ä»˜ã€äº¤æ˜“ç­‰æ•æ„Ÿæ¥å£ |

## äº”ã€ç­¾åæœºåˆ¶çš„ä½œç”¨ ##

### æ ¸å¿ƒå®‰å…¨ä½œç”¨ ###

|  ä½œç”¨  |  è¯´æ˜  |   å®ç°æ–¹å¼  |
| :-----------: | :----: | :----: |
| èº«ä»½éªŒè¯ |  éªŒè¯è°ƒç”¨æ–¹èº«ä»½æ˜¯å¦åˆæ³•  |  é€šè¿‡ appCode + secretKey éªŒè¯ |
| é˜²é‡æ”¾æ”»å‡» |  é˜²æ­¢æ”»å‡»è€…æˆªè·è¯·æ±‚åé‡å¤å‘é€  |  é€šè¿‡æ—¶é—´æˆ³ + TTL é™åˆ¶ç­¾åæœ‰æ•ˆæœŸ |
| é˜²ç¯¡æ”¹ |  é˜²æ­¢è¯·æ±‚å‚æ•°æˆ–è·¯å¾„è¢«ç¯¡æ”¹  |  é€šè¿‡ç­¾åæ ¡éªŒç¡®ä¿æ•°æ®å®Œæ•´æ€§ |
| æƒé™æ§åˆ¶ |  æ§åˆ¶ä¸åŒè°ƒç”¨æ–¹å¯¹ä¸åŒæ¥å£çš„è®¿é—®æƒé™  |  é€šè¿‡ api_auth è¡¨ç®¡ç†æƒé™ |
| é™æµé˜²åˆ· |  é˜²æ­¢æ¥å£è¢«æ¶æ„åˆ·é‡  |  é€šè¿‡ api_info è¡¨é…ç½®é™æµç­–ç•¥ |

### å…·ä½“é˜²æŠ¤åœºæ™¯ ###

#### åœºæ™¯1ï¼šé˜²æ­¢è¯·æ±‚é‡æ”¾ ####

æ”»å‡»è€…æˆªè·äº†ä¸€æ¬¡åˆæ³•è¯·æ±‚ï¼š

```txt
POST /api/order/submit

Headers:
  Sign-appCode: h5
  Sign-sign: abc123...
  Sign-time: 1672531200000
```

å½“æ”»å‡»è€…å°è¯•é‡æ”¾è¯¥è¯·æ±‚æ—¶ï¼š

- å¦‚æœå½“å‰æ—¶é—´è¶…è¿‡ `Sign-time + TTL`ï¼ˆå¦‚10åˆ†é’Ÿï¼‰ï¼Œç­¾åå·²è¿‡æœŸï¼ŒéªŒè¯å¤±è´¥
- å³ä½¿åœ¨æœ‰æ•ˆæœŸå†…ï¼Œç”±äºåŠ¨æ€ç›å€¼å·²è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰ï¼Œæ— æ³•é€šè¿‡åŠ¨æ€ç›å€¼éªŒè¯

#### åœºæ™¯2ï¼šé˜²æ­¢å‚æ•°ç¯¡æ”¹ ####

æ­£å¸¸è¯·æ±‚ï¼š

```json
{
  "amount": 100,
  "productId": "12345"
}
```

æ”»å‡»è€…ç¯¡æ”¹å‚æ•°ï¼š

```json
{
  "amount": 1,  // ç¯¡æ”¹
  "productId": "12345"
}
```

ç”±äºå‚æ•°å˜åŒ–ï¼Œé‡æ–°è®¡ç®—çš„ç­¾åä¸åŸç­¾åä¸åŒ¹é…ï¼ŒéªŒè¯å¤±è´¥ã€‚

#### åœºæ™¯3ï¼šé˜²æ­¢è¶Šæƒè®¿é—® ####

è°ƒç”¨æ–¹ `"h5"` å°è¯•è®¿é—®æœªæˆæƒçš„æ¥å£ `"/api/admin/delete"`ï¼š

- åœ¨ api_auth è¡¨ä¸­æŸ¥ä¸åˆ° `("h5", "/api/admin/delete")` çš„æˆæƒè®°å½•
- æ‹¦æˆªå™¨æ‹’ç»è®¿é—®ï¼Œè¿”å› 401

## å…­ã€å¦‚ä½•å–èˆï¼Ÿæ—¢ä¸è¿‡åº¦å¢åŠ å¼€å‘è´Ÿæ‹…ï¼Œåˆèƒ½ä¿è¯å®‰å…¨å¯é  ##

### å››ç§å®‰å…¨çº§åˆ«æ–¹æ¡ˆ ###

æ ¹æ®ä¸šåŠ¡åœºæ™¯å’Œè°ƒç”¨æ–¹ç±»å‹ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„å®‰å…¨çº§åˆ«ï¼š

#### æ–¹æ¡ˆ0ï¼šåç«¯ç›´æ¥ç­¾åï¼ˆæ¨èåç«¯æœåŠ¡ä½¿ç”¨ï¼‰â­ ####

- é€‚ç”¨åœºæ™¯ï¼š åç«¯æœåŠ¡è°ƒç”¨åç«¯æ¥å£ï¼ˆå¾®æœåŠ¡ã€å®šæ—¶ä»»åŠ¡ã€å†…éƒ¨ç³»ç»Ÿï¼‰

- æ ¸å¿ƒä¼˜åŠ¿ï¼š åç«¯å¯ä»¥å®‰å…¨å­˜å‚¨å¯†é’¥ï¼Œæ— éœ€åŠ¨æ€ç›å€¼ï¼Œæµç¨‹æœ€ç®€æ´

- å®ç°æ­¥éª¤ï¼š

  - åç«¯æœåŠ¡è¯»å–å¯†é’¥ï¼ˆä»ç¯å¢ƒå˜é‡ã€é…ç½®ä¸­å¿ƒç­‰ï¼‰
  - åç«¯ç›´æ¥ç”Ÿæˆç­¾åï¼š`SHA256(appCode + secretKey + apiPath + timestamp)`
  - åç«¯æºå¸¦ç­¾åè°ƒç”¨ä¸šåŠ¡æ¥å£ï¼ˆHeader: Sign-appCode, Sign-sign, Sign-time, Sign-pathï¼‰
  - ä¸šåŠ¡æ¥å£éªŒè¯ç­¾å

- ç¤ºä¾‹ä»£ç ï¼ˆJavaï¼‰ï¼š

```java
// åç«¯æœåŠ¡ä¸­çš„ç­¾åç”Ÿæˆ
public String generateSignForBackend(String appCode, String secretKey, String apiPath) {
    long timestamp = System.currentTimeMillis();
    String signSource = appCode + secretKey + apiPath + timestamp;
    String signature = DigestUtils.sha256Hex(signSource);

    // è®¾ç½®åˆ°è¯·æ±‚ Header
    httpRequest.setHeader("Sign-appCode", appCode);
    httpRequest.setHeader("Sign-sign", signature);
    httpRequest.setHeader("Sign-time", String.valueOf(timestamp));
    httpRequest.setHeader("Sign-path", apiPath);

    return signature;
}
```

**ä¼˜ç‚¹**ï¼š

- æµç¨‹æœ€ç®€å•ï¼Œåªéœ€1æ¬¡è¯·æ±‚
- æ€§èƒ½æœ€é«˜ï¼Œæ— éœ€é¢å¤–çš„åŠ¨æ€ç›å€¼è¯·æ±‚
- å¯†é’¥å®‰å…¨å­˜å‚¨åœ¨åç«¯

**ç¼ºç‚¹**ï¼š 

- æ— 

é…ç½®ç¤ºä¾‹ï¼ˆapplication.ymlï¼‰ï¼š

```yaml
sign:
  signature:
    ttl: 600000  # 10åˆ†é’Ÿ
    default-with-params: false  # å¦‚éœ€é˜²å‚æ•°ç¯¡æ”¹ï¼Œè®¾ä¸º true
  # æ— éœ€é…ç½® dynamic-salt
```

**é‡è¦æç¤º**ï¼š åç«¯æœåŠ¡è°ƒç”¨æ—¶ï¼Œå¯†é’¥åº”é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒç®¡ç†ï¼Œä¸è¦ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ã€‚

#### æ–¹æ¡ˆ1ï¼šåŸºç¡€ç­¾åï¼ˆä½å®‰å…¨æ€§ï¼Œå‰ç«¯åœºæ™¯ï¼‰ ####

**é€‚ç”¨åœºæ™¯**ï¼š å‰ç«¯è°ƒç”¨ï¼Œå†…éƒ¨ç³»ç»Ÿã€ä½æ•æ„Ÿåº¦æ¥å£ã€ä¿¡ä»»ç¯å¢ƒ

**é…ç½®**ï¼š

- ä»…ä½¿ç”¨"ä¸å«å‚æ•°ç­¾å"
- ä¸å¯ç”¨åŠ¨æ€ç›å€¼ï¼ˆâš ï¸ æ³¨æ„ï¼šå‰ç«¯éœ€è°ƒç”¨ç­¾åç”Ÿæˆæ¥å£ï¼Œè€Œéç›´æ¥æŒæœ‰å¯†é’¥ï¼‰
- ç­¾åæœ‰æ•ˆæœŸè¾ƒé•¿ï¼ˆå¦‚30åˆ†é’Ÿæˆ–2å°æ—¶ï¼‰

**å®ç°æ­¥éª¤**ï¼š

- å‰ç«¯ç›´æ¥è°ƒç”¨ç­¾åç”Ÿæˆæ¥å£ï¼ˆä¸éœ€è¦å…ˆè·å–åŠ¨æ€ç›å€¼ï¼‰,æˆ–è¿›å…¥é¡µé¢åç”±åç«¯ç”Ÿæˆç­¾åè¿”å›ç»™å‰ç«¯
- åç«¯ç”Ÿæˆç­¾åï¼š`SHA256(appCode + secretKey + path + timestamp)`
- å‰ç«¯æºå¸¦ç­¾åè°ƒç”¨ä¸šåŠ¡æ¥å£

**ä¼˜ç‚¹**ï¼š å¼€å‘ç®€å•ï¼Œæ€§èƒ½é«˜

**ç¼ºç‚¹**ï¼š å®‰å…¨æ€§è¾ƒä½ï¼Œä¸é˜²å‚æ•°ç¯¡æ”¹ï¼Œå‰ç«¯ä»éœ€é¢å¤–è¯·æ±‚ç­¾å

#### æ–¹æ¡ˆ2ï¼šæ ‡å‡†ç­¾åï¼ˆä¸­å®‰å…¨æ€§ï¼Œå‰ç«¯åœºæ™¯ï¼‰â­ å‰ç«¯æ¨è ####

**é€‚ç”¨åœºæ™¯**ï¼š å‰ç«¯è°ƒç”¨ï¼Œå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ã€å‰åç«¯åˆ†ç¦»åº”ç”¨

**é…ç½®**ï¼š

- ä½¿ç”¨"ä¸å«å‚æ•°ç­¾å"
- å¯ç”¨åŠ¨æ€ç›å€¼ï¼ˆç®—æ³•æ ¡éªŒæ¨¡å¼ï¼‰
- åŠ¨æ€ç›å€¼æœ‰æ•ˆæœŸï¼š24å°æ—¶
- ç­¾åæœ‰æ•ˆæœŸï¼š10åˆ†é’Ÿ

**å®ç°æ­¥éª¤**ï¼š

- å‰ç«¯è¯·æ±‚åŠ¨æ€ç›å€¼ç”Ÿæˆæ¥å£
- å‰ç«¯æºå¸¦åŠ¨æ€ç›å€¼è¯·æ±‚ç­¾åç”Ÿæˆæ¥å£
- åç«¯éªŒè¯åŠ¨æ€ç›å€¼ â†’ ç”Ÿæˆç­¾å
- å‰ç«¯æºå¸¦ç­¾åè°ƒç”¨ä¸šåŠ¡æ¥å£
- åç«¯éªŒè¯ç­¾å

**ä¼˜ç‚¹**ï¼š å®‰å…¨æ€§å¥½ï¼Œå¼€å‘è´Ÿæ‹…é€‚ä¸­

**ç¼ºç‚¹**ï¼š éœ€è¦å¤šä¸€æ¬¡åŠ¨æ€ç›å€¼è¯·æ±‚

**é…ç½®ç¤ºä¾‹ï¼ˆapplication.ymlï¼‰**ï¼š

```yaml
sign:
  dynamic-salt:
    ttl: 86400000  # 24å°æ—¶
    validate-from-database: false  # ç®—æ³•æ ¡éªŒ
  signature:
    ttl: 600000  # 10åˆ†é’Ÿ
    default-with-params: false  # ä¸å«å‚æ•°
```

#### æ–¹æ¡ˆ3ï¼šé«˜å®‰å…¨ç­¾åï¼ˆé«˜å®‰å…¨æ€§ï¼Œå‰ç«¯åœºæ™¯ï¼‰ ####

**é€‚ç”¨åœºæ™¯**ï¼š å‰ç«¯è°ƒç”¨ï¼Œæ”¯ä»˜ã€äº¤æ˜“ã€æ•æ„Ÿæ•°æ®æ“ä½œ

**é…ç½®**ï¼š

- ä½¿ç”¨"å«å‚æ•°ç­¾å"ï¼ˆSM3ç®—æ³•ï¼‰
- å¯ç”¨åŠ¨æ€ç›å€¼ï¼ˆæ•°æ®åº“æ ¡éªŒæ¨¡å¼ï¼‰
- åŠ¨æ€ç›å€¼ä¸€æ¬¡æ€§ä½¿ç”¨ï¼ˆused å­—æ®µæ ‡è®°ï¼‰
- ç­¾åæœ‰æ•ˆæœŸï¼š10åˆ†é’Ÿ

**å®ç°æ­¥éª¤**ï¼š

- å‰ç«¯è¯·æ±‚åŠ¨æ€ç›å€¼ç”Ÿæˆæ¥å£
- åç«¯ç”ŸæˆåŠ¨æ€ç›å€¼å¹¶å­˜å…¥æ•°æ®åº“ï¼ˆapi_dynamic_salt_logè¡¨ï¼‰
- å‰ç«¯æºå¸¦åŠ¨æ€ç›å€¼è¯·æ±‚ç­¾åç”Ÿæˆæ¥å£
- åç«¯ä»æ•°æ®åº“æŸ¥è¯¢åŠ¨æ€ç›å€¼ï¼Œæ ¡éªŒåæ ‡è®°ä¸ºå·²ä½¿ç”¨
- åç«¯ç”Ÿæˆå«å‚æ•°ç­¾å
- å‰ç«¯æºå¸¦ç­¾åå’Œå‚æ•°è°ƒç”¨ä¸šåŠ¡æ¥å£
- åç«¯æå–å‚æ•°ï¼ŒéªŒè¯ç­¾åï¼ˆåŒ…å«å‚æ•°ï¼‰

**ä¼˜ç‚¹**ï¼š å®‰å…¨æ€§æœ€é«˜ï¼Œé˜²å‚æ•°ç¯¡æ”¹ï¼Œé˜²åŠ¨æ€ç›å€¼é‡æ”¾

**ç¼ºç‚¹**ï¼š å¼€å‘å¤æ‚åº¦é«˜ï¼Œæ€§èƒ½ç¨ä½ï¼ˆéœ€è¯»å†™æ•°æ®åº“ï¼‰

**é…ç½®ç¤ºä¾‹ï¼ˆapplication.ymlï¼‰**ï¼š

```yaml
sign:
  dynamic-salt:
    ttl: 86400000
    validate-from-database: true  # æ•°æ®åº“æ ¡éªŒ
  signature:
    ttl: 300000  # 5åˆ†é’Ÿ
    default-with-params: true  # å«å‚æ•°
```

### æ–¹æ¡ˆå¯¹æ¯” ###

|  å¯¹æ¯”é¡¹  |  åç«¯ç›´æ¥ç­¾åâ­  |  åŸºç¡€ç­¾åï¼ˆå‰ç«¯ï¼‰ |  æ ‡å‡†ç­¾åï¼ˆå‰ç«¯ï¼‰â­  |  é«˜å®‰å…¨ç­¾åï¼ˆå‰ç«¯ï¼‰  |
| :-----------: | :----: | :----: | :----: | :----: |
| è°ƒç”¨æ–¹ |  åç«¯æœåŠ¡  |  å‰ç«¯ |  å‰ç«¯ |  å‰ç«¯ |
| å¯†é’¥å­˜å‚¨ |  âœ… åç«¯å®‰å…¨å­˜å‚¨  |  âŒ å‰ç«¯æ— æ³•æŒæœ‰ |  âŒ å‰ç«¯æ— æ³•æŒæœ‰ |  âŒ å‰ç«¯æ— æ³•æŒæœ‰ |
| åŠ¨æ€ç›å€¼ |  âŒ ä¸éœ€è¦  |  âŒ ä¸ä½¿ç”¨ |  âœ… ç®—æ³•æ ¡éªŒ |  âœ… æ•°æ®åº“æ ¡éªŒ |
| å‚æ•°ç­¾å |  å¯é€‰  |  âŒ ä¸å«å‚æ•° |  âŒ ä¸å«å‚æ•° |  âœ… å«å‚æ•°ï¼ˆSM3æˆ–SHA256ï¼‰ |
| è¯·æ±‚æ¬¡æ•° |  1æ¬¡ï¼ˆç›´æ¥è°ƒç”¨ï¼‰  |  2æ¬¡ï¼ˆæ¢ç­¾+ä¸šåŠ¡ï¼‰ |  3æ¬¡ï¼ˆç›å€¼+ç­¾å+ä¸šåŠ¡ï¼‰ |  3æ¬¡ï¼ˆç›å€¼+ç­¾å+ä¸šåŠ¡ï¼‰ |
| å®‰å…¨çº§åˆ« |  â­â­â­â­  |  â­â­ |  â­â­â­â­ |  â­â­â­â­â­ |
| å¼€å‘å¤æ‚åº¦ |  æä½  |  ä½ |  ä¸­ |  é«˜ |
| æ€§èƒ½ |  æœ€é«˜  |  é«˜ |  ä¸­ |  ä¸­ä½ |
| å…¸å‹åœºæ™¯ |  å¾®æœåŠ¡ã€å®šæ—¶ä»»åŠ¡  |  å†…éƒ¨å‰ç«¯ç³»ç»Ÿ |  ä¸€èˆ¬å‰ç«¯åº”ç”¨ |  æ”¯ä»˜ã€äº¤æ˜“å‰ç«¯ |

**é€‰æ‹©å»ºè®®**ï¼š

- åç«¯æœåŠ¡è°ƒç”¨ â†’ *æ–¹æ¡ˆ0ï¼šåç«¯ç›´æ¥ç­¾å*
- å‰ç«¯ä¸€èˆ¬åº”ç”¨ â†’ *æ–¹æ¡ˆ2ï¼šæ ‡å‡†ç­¾å*
- å‰ç«¯æ”¯ä»˜äº¤æ˜“ â†’ *æ–¹æ¡ˆ3ï¼šé«˜å®‰å…¨ç­¾å*

### å®æ–½å»ºè®® ###

#### åŒºåˆ†è°ƒç”¨æ–¹ç±»å‹ ####

é¦–å…ˆæ˜ç¡®è°ƒç”¨æ–¹æ˜¯å‰ç«¯è¿˜æ˜¯åç«¯ï¼š

```java
// åç«¯æœåŠ¡è°ƒç”¨ - ç›´æ¥ä½¿ç”¨å¯†é’¥ç­¾åï¼Œæ— éœ€åŠ¨æ€ç›å€¼
@Service
public class BackendServiceClient {
    @Value("${api.app-code}")
    private String appCode;

    @Value("${api.secret-key}")
    private String secretKey;

    public void callRemoteApi(String apiPath, Map<String, Object> params) {
        // ç›´æ¥ç”Ÿæˆç­¾å
        long timestamp = System.currentTimeMillis();
        String signSource = appCode + secretKey + apiPath + timestamp;
        String signature = DigestUtils.sha256Hex(signSource);

        // å‘é€è¯·æ±‚
        HttpHeaders headers = new HttpHeaders();
        headers.set("Sign-appCode", appCode);
        headers.set("Sign-sign", signature);
        headers.set("Sign-time", String.valueOf(timestamp));
        headers.set("Sign-path", apiPath);

        // ... å‘é€ HTTP è¯·æ±‚
    }
}
```

#### æŒ‰æ¥å£åˆ†çº§ä¿æŠ¤ ####

å¯ä»¥ä¸ºä¸åŒæ¥å£è®¾ç½®ä¸åŒçš„å®‰å…¨çº§åˆ«ï¼š

```java
// æŸ¥è¯¢æ¥å£ - ä¸å«å‚æ•°ç­¾å
@RequireSign(withParams = WithParams.FALSE)
public ApiResponse getUserInfo() { ... }

// æäº¤æ¥å£ - ä¸å«å‚æ•°ç­¾å
@RequireSign(withParams = WithParams.FALSE)
public ApiResponse submitOrder() { ... }

// æ”¯ä»˜æ¥å£ - å«å‚æ•°ç­¾åï¼ˆé«˜å®‰å…¨ï¼‰
@RequireSign(withParams = WithParams.TRUE)
public ApiResponse payment() { ... }
```

#### æ¸è¿›å¼å‡çº§ ####

- ç¬¬ä¸€é˜¶æ®µï¼šåç«¯æœåŠ¡ä½¿ç”¨æ–¹æ¡ˆ0ï¼ˆç›´æ¥ç­¾åï¼‰
- ç¬¬äºŒé˜¶æ®µï¼šå‰ç«¯ä½¿ç”¨æ–¹æ¡ˆ2ï¼ˆåŠ¨æ€ç›å€¼ + ä¸å«å‚æ•°ç­¾åï¼‰
- ç¬¬ä¸‰é˜¶æ®µï¼šä¸ºæ•æ„Ÿæ¥å£å‡çº§åˆ°æ–¹æ¡ˆ3ï¼ˆå«å‚æ•°ç­¾åï¼‰

#### ç›‘æ§ä¸å‘Šè­¦ ####

è®°å½•ç­¾åéªŒè¯å¤±è´¥çš„æ—¥å¿—ï¼Œè®¾ç½®å‘Šè­¦ï¼š

```java
if (!isValid) {
    log.warn("ç­¾åéªŒè¯å¤±è´¥ - appCode={}, path={}, sign={}",
             appCode, serverPath, sign);
    // è§¦å‘å‘Šè­¦ï¼ˆå¦‚é’‰é’‰ã€é‚®ä»¶ï¼‰
}
```

#### ç™½åå•æœºåˆ¶ ####

ä¸ºç‰¹å®šè°ƒç”¨æ–¹ï¼ˆå¦‚è¿ç»´å·¥å…·ï¼‰è®¾ç½®ç™½åå•ï¼Œè·³è¿‡ç­¾åéªŒè¯ï¼š

```java
@IgnoreSignHeader  // è·³è¿‡ç­¾åéªŒè¯
public ApiResponse healthCheck() { ... }
```

## ä¸ƒã€ä»£ç ç¤ºä¾‹ ##

### å‰ç«¯ç¤ºä¾‹ä»£ç ï¼ˆJavaScriptï¼‰ ###

```javascript
// 1. è·å–åŠ¨æ€ç›å€¼
async function getDynamicSalt(appCode, apiPath) {
  const saltTimestamp = Date.now();
  const response = await fetch('/api/sign/dynamic-salt/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ appCode, apiPath, saltTimestamp })
  });
  return await response.json(); // { dynamicSalt, saltTimestamp, apiPath }
}

// 2. è·å–ç­¾å
async function getSignature(appCode, apiPath, dynamicSalt, dynamicSaltTime) {
  const response = await fetch('/api/sign/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ appCode, apiPath, dynamicSalt, dynamicSaltTime })
  });
  return await response.json(); // { signValue, timestamp, apiPath }
}

// 3. è°ƒç”¨ä¸šåŠ¡æ¥å£
async function submitOrder(orderData) {
  // 3.1 è·å–åŠ¨æ€ç›å€¼
  const { dynamicSalt, saltTimestamp } = await getDynamicSalt('h5', '/api/order/submit');

  // 3.2 è·å–ç­¾å
  const { signValue, timestamp } = await getSignature('h5', '/api/order/submit',
                                                       dynamicSalt, saltTimestamp);

  // 3.3 è°ƒç”¨ä¸šåŠ¡æ¥å£
  const response = await fetch('/api/order/submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Sign-appCode': 'h5',
      'Sign-sign': signValue,
      'Sign-time': timestamp.toString(),
      'Sign-path': '/api/order/submit'
    },
    body: JSON.stringify(orderData)
  });

  return await response.json();
}
```

## å…«ã€æ€»ç»“ ##

æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†ä¸€å¥—å®Œæ•´çš„APIæ¥å£å®‰å…¨æ–¹æ¡ˆï¼Œé€šè¿‡åŠ¨æ€ç›å€¼ + æ¥å£ç­¾åçš„åŒé‡éªŒè¯æœºåˆ¶ï¼Œæœ‰æ•ˆé˜²æ­¢äº†é‡æ”¾æ”»å‡»ã€å‚æ•°ç¯¡æ”¹å’Œè¶Šæƒè®¿é—®ã€‚

**æ ¸å¿ƒè¦ç‚¹**ï¼š

- åŒºåˆ†è°ƒç”¨æ–¹ç±»å‹

  - åç«¯æœåŠ¡è°ƒç”¨ï¼šå¯†é’¥å¯å®‰å…¨å­˜å‚¨ï¼Œç›´æ¥ä½¿ç”¨å¯†é’¥ç­¾åï¼Œæ— éœ€åŠ¨æ€ç›å€¼
  - å‰ç«¯è°ƒç”¨ï¼šå¯†é’¥æ— æ³•å®‰å…¨å­˜å‚¨ï¼Œå¿…é¡»ä½¿ç”¨åŠ¨æ€ç›å€¼ä½œä¸º"æ¢ç­¾å‡­è¯"

- åŠ¨æ€ç›å€¼çš„ä½œç”¨

  - è§£å†³å‰ç«¯æ— æ³•æŒæœ‰å¯†é’¥çš„æ ¸å¿ƒé—®é¢˜
  - ä½œä¸º"ä¸€æ¬¡æ€§ä»¤ç‰Œ"ï¼Œå¢å¼ºå®‰å…¨æ€§
  - ä»…é€‚ç”¨äºå‰ç«¯ç­¾ååœºæ™¯

- çµæ´»çš„ç­¾åæ¨¡å¼

  - æ”¯æŒ"å«å‚æ•°/ä¸å«å‚æ•°"ä¸¤ç§ç­¾åæ¨¡å¼
  - æ”¯æŒå¤šç§å“ˆå¸Œç®—æ³•ï¼ˆSHA-256ã€SM3ç­‰ï¼‰
  - é€šè¿‡æ³¨è§£çµæ´»æ§åˆ¶æ¥å£çº§åˆ«çš„ç­¾åç­–ç•¥

- å››ç§å®‰å…¨æ–¹æ¡ˆ

  - æ–¹æ¡ˆ0ï¼šåç«¯ç›´æ¥ç­¾åï¼ˆåç«¯æœåŠ¡æ¨èï¼‰
  - æ–¹æ¡ˆ1ï¼šåŸºç¡€ç­¾åï¼ˆå‰ç«¯ä½å®‰å…¨åœºæ™¯ï¼‰
  - æ–¹æ¡ˆ2ï¼šæ ‡å‡†ç­¾åï¼ˆå‰ç«¯ä¸€èˆ¬åœºæ™¯æ¨èï¼‰
  - æ–¹æ¡ˆ3ï¼šé«˜å®‰å…¨ç­¾åï¼ˆå‰ç«¯æ”¯ä»˜äº¤æ˜“åœºæ™¯ï¼‰

**å®æ–½å»ºè®®**ï¼š

- åç«¯æœåŠ¡è°ƒç”¨ â†’ ä½¿ç”¨æ–¹æ¡ˆ0ï¼Œç›´æ¥æŒæœ‰å¯†é’¥ç­¾åï¼Œæ€§èƒ½æœ€ä¼˜
- å‰ç«¯ä¸€èˆ¬åº”ç”¨ â†’ ä½¿ç”¨æ–¹æ¡ˆ2ï¼ˆåŠ¨æ€ç›å€¼ + ä¸å«å‚æ•°ç­¾åï¼‰
- å‰ç«¯æ”¯ä»˜äº¤æ˜“ â†’ ä½¿ç”¨æ–¹æ¡ˆ3ï¼ˆåŠ¨æ€ç›å€¼ + å«å‚æ•°ç­¾åï¼‰
- æŒ‰æ¥å£åˆ†çº§ä¿æŠ¤ï¼Œçµæ´»ç»„åˆä¸åŒæ–¹æ¡ˆ

**å…³é”®æé†’**ï¼š

- âš ï¸ å‰ç«¯æ°¸è¿œä¸è¦æŒæœ‰å¯†é’¥ï¼ˆsecretKeyï¼‰ï¼Œå¿…é¡»é€šè¿‡åŠ¨æ€ç›å€¼æ¢å–ç­¾å
- âœ… åç«¯å¯ä»¥å®‰å…¨æŒæœ‰å¯†é’¥ï¼Œæ— éœ€ä½¿ç”¨åŠ¨æ€ç›å€¼ï¼Œç®€åŒ–æµç¨‹
- ğŸ”’ å¯†é’¥åº”é€šè¿‡ç¯å¢ƒå˜é‡ã€é…ç½®ä¸­å¿ƒç­‰å®‰å…¨æ–¹å¼ç®¡ç†

> å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©ä½ åœ¨å®é™…é¡¹ç›®ä¸­å¿«é€Ÿè½åœ°APIæ¥å£å®‰å…¨æ–¹æ¡ˆï¼å¦‚æœ‰ä»»ä½•ç–‘é—®æˆ–å»ºè®®ï¼Œæ¬¢è¿ç•™è¨€æ¢è®¨ã€‚
