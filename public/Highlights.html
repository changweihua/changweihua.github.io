<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSS Highlights API - è¯­æ³•é«˜äº®æ¼”ç¤º</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 1rem;
        font-size: 2.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .info {
        background: rgba(255, 255, 255, 0.95);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .info h2 {
        color: #667eea;
        margin-bottom: 0.5rem;
      }

      .info p {
        color: #4a5568;
        line-height: 1.6;
      }

      .demo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      @media (max-width: 768px) {
        .demo-grid {
          grid-template-columns: 1fr;
        }
      }

      .demo-section {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .demo-header {
        background: #2d3748;
        color: white;
        padding: 1rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .demo-header .badge {
        background: #48bb78;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.875rem;
      }

      .demo-header .badge-warning {
        background: #f59e0b;
      }

      .code-container {
        background: #1e1e1e;
        padding: 1.5rem;
        overflow-x: auto;
        min-height: 400px;
      }

      .code-block {
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 14px;
        line-height: 1.6;
        color: #d4d4d4;
        white-space: pre;
      }

      /* CSS Highlights API Styles */
      ::highlight(keyword) {
        color: #569cd6;
        font-weight: bold;
      }

      ::highlight(string) {
        color: #ce9178;
      }

      ::highlight(comment) {
        color: #6a9955;
        font-style: italic;
      }

      ::highlight(function) {
        color: #dcdcaa;
      }

      ::highlight(number) {
        color: #b5cea8;
      }

      ::highlight(operator) {
        color: #d4d4d4;
      }

      ::highlight(punctuation) {
        color: #d4d4d4;
      }

      ::highlight(identifier) {
        color: #9cdcfe;
      }

      /* Traditional span-based highlighting */
      .token-keyword {
        color: #569cd6;
        font-weight: bold;
      }

      .token-string {
        color: #ce9178;
      }

      .token-comment {
        color: #6a9955;
        font-style: italic;
      }

      .token-function {
        color: #dcdcaa;
      }

      .token-number {
        color: #b5cea8;
      }

      .token-operator {
        color: #d4d4d4;
      }

      .token-punctuation {
        color: #d4d4d4;
      }

      .token-identifier {
        color: #9cdcfe;
      }

      .stats {
        background: rgba(255, 255, 255, 0.95);
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stats h3 {
        color: #667eea;
        margin-bottom: 1rem;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .stat-item {
        background: #f7fafc;
        padding: 1rem;
        border-radius: 6px;
        border-left: 4px solid #667eea;
      }

      .stat-label {
        color: #718096;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }

      .stat-value {
        color: #2d3748;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .warning {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
      }

      .warning p {
        color: #92400e;
      }

      .hidden {
        display: none;
      }

      .controls {
        background: rgba(255, 255, 255, 0.95);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        margin: 0 0.5rem;
        transition: background 0.3s;
      }

      button:hover {
        background: #5568d3;
      }

      button:active {
        transform: translateY(1px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¨ CSS Highlights API æ¼”ç¤º</h1>

      <div class="info">
        <h2>å…³äºæ­¤æ¼”ç¤º</h2>
        <p>
          æ­¤æ¼”ç¤ºå¯¹æ¯”äº†ä¸¤ç§è¯­æ³•é«˜äº®æ–¹æ³•ï¼šç°ä»£çš„
          <strong>CSS Highlights API</strong>ï¼ˆå·¦ä¾§ï¼‰ä¸ä¼ ç»Ÿçš„
          <strong>åŸºäº DOM çš„é«˜äº®</strong>ï¼ˆå³ä¾§ï¼‰ã€‚CSS Highlights API
          æä¾›é«˜æ€§èƒ½çš„è¯­æ³•é«˜äº®ï¼Œ æ— éœ€æ“ä½œ
          DOMï¼Œå°†æ–‡æœ¬ä¿æŒåœ¨å•ä¸ªæ–‡æœ¬èŠ‚ç‚¹ä¸­ï¼Œä»¥è·å¾—æœ€ä½³æ¸²æŸ“æ€§èƒ½ã€‚
        </p>
      </div>

      <div class="controls">
        <button type="button" onclick="remeasure()">ğŸ”„ é‡æ–°æµ‹é‡æ€§èƒ½</button>
        <button type="button" onclick="changeCode()">ğŸ² åˆ‡æ¢ä»£ç ç¤ºä¾‹</button>
      </div>

      <div class="demo-grid">
        <div class="demo-section">
          <div class="demo-header">
            <span>CSS Highlights API</span>
            <span class="badge">ç°ä»£æ–¹æ¡ˆ</span>
          </div>
          <div class="code-container">
            <pre class="code-block" id="highlights-demo"></pre>
          </div>
        </div>

        <div class="demo-section">
          <div class="demo-header">
            <span>ä¼ ç»Ÿ DOM Span æ–¹æ¡ˆ</span>
            <span class="badge badge-warning">ä¼ ç»Ÿæ–¹æ¡ˆ</span>
          </div>
          <div class="code-container">
            <pre class="code-block" id="traditional-demo"></pre>
          </div>
        </div>
      </div>

      <div class="stats">
        <h3>ğŸ“Š æ€§èƒ½å¯¹æ¯”</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">CSS Highlights - DOM èŠ‚ç‚¹æ•°</div>
            <div class="stat-value" id="highlights-nodes">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ä¼ ç»Ÿæ–¹æ¡ˆ - DOM èŠ‚ç‚¹æ•°</div>
            <div class="stat-value" id="traditional-nodes">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">CSS Highlights - æ¸²æŸ“æ—¶é—´</div>
            <div class="stat-value" id="highlights-time">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ä¼ ç»Ÿæ–¹æ¡ˆ - æ¸²æŸ“æ—¶é—´</div>
            <div class="stat-value" id="traditional-time">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">æ€§èƒ½æå‡</div>
            <div class="stat-value" id="improvement">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å†…å­˜èŠ‚çœ</div>
            <div class="stat-value" id="memory-saved">-</div>
          </div>
        </div>
        <div class="warning hidden" id="browser-warning">
          <p>
            <strong>âš ï¸ æµè§ˆå™¨å…¼å®¹æ€§ï¼š</strong>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ CSS Highlights
            APIã€‚åªæœ‰ä¼ ç»Ÿçš„é«˜äº®æ–¹æ³•èƒ½æ­£å¸¸å·¥ä½œã€‚
          </p>
        </div>
      </div>
    </div>

    <script>
      // ä»£ç ç¤ºä¾‹
      const codeSamples = [
        `// JavaScript ç¤ºä¾‹
function fibonacci(n) {
    // è®¡ç®—æ–æ³¢é‚£å¥‘æ•°
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

const result = fibonacci(10);
console.log("ç»“æœ:", result);

// æ•°ç»„æ“ä½œ
const numbers = [1, 2, 3, 4, 5];
const doubled = numbers.map(x => x * 2);`,

        `// React ç»„ä»¶
function UserProfile({ name, age }) {
    const [isActive, setActive] = useState(false);

    // å¤„ç†ç‚¹å‡»äº‹ä»¶
    const handleClick = () => {
        setActive(!isActive);
        console.log("çŠ¶æ€å·²æ”¹å˜");
    };

    return (
        <div className="profile">
            <h1>{name}</h1>
            <p>å¹´é¾„: {age}</p>
        </div>
    );
}`,

        `// TypeScript æ¥å£
interface User {
    id: number;
    name: string;
    email: string;
}

function getUserData(userId: number): Promise<User> {
    // è·å–ç”¨æˆ·æ•°æ®
    return fetch(\`/api/users/\${userId}\`)
        .then(response => response.json())
        .catch(error => {
            console.error("é”™è¯¯:", error);
            throw error;
        });
}`,
      ];

      let currentCodeIndex = 0;

      /**
       * è¯æ³•åˆ†æå™¨ - å°†ä»£ç æ–‡æœ¬è§£ææˆ token åˆ—è¡¨
       * @param {string} code - è¦åˆ†æçš„æºä»£ç 
       * @returns {Array} - token æ•°ç»„ï¼Œæ¯ä¸ª token åŒ…å« type, start, end, value
       */
      function tokenize(code) {
        const tokens = [];

        // å®šä¹‰åŒ¹é…è§„åˆ™ï¼Œé¡ºåºå¾ˆé‡è¦ï¼š
        // 1. comment å’Œ string æ”¾åœ¨æœ€å‰é¢ï¼Œç¡®ä¿å®ƒä»¬å†…éƒ¨çš„å†…å®¹ä¸ä¼šè¢«å…¶ä»–è§„åˆ™åŒ¹é…
        // 2. åç»­è§„åˆ™æŒ‰ç…§ä¼˜å…ˆçº§æ’åˆ—
        const patterns = [
          { type: "comment", regex: /\/\/[^\n]*/g }, // å•è¡Œæ³¨é‡Š
          { type: "string", regex: /(["'`])(?:(?=(\\?))\2.)*?\1/g }, // å­—ç¬¦ä¸²ï¼ˆæ”¯æŒå•å¼•å·ã€åŒå¼•å·ã€æ¨¡æ¿å­—ç¬¦ä¸²ï¼‰
          {
            type: "keyword",
            regex:
              /\b(function|const|let|var|if|else|return|class|interface|async|await|import|export|from|new|typeof|instanceof)\b/g,
          }, // JavaScript å…³é”®å­—
          { type: "number", regex: /\b\d+\.?\d*\b/g }, // æ•°å­—ï¼ˆæ•´æ•°å’Œå°æ•°ï¼‰
          { type: "function", regex: /\b[a-zA-Z_$][a-zA-Z0-9_$]*(?=\()/g }, // å‡½æ•°åï¼ˆåé¢è·Ÿç€å·¦æ‹¬å·ï¼‰
          { type: "operator", regex: /[+\-*/%=<>!&|^~?:]/g }, // è¿ç®—ç¬¦
          { type: "punctuation", regex: /[{}[\]();,\.]/g }, // æ ‡ç‚¹ç¬¦å·
        ];

        // éå†æ‰€æœ‰è§„åˆ™ï¼Œæ”¶é›†åŒ¹é…çš„ token
        for (const { type, regex } of patterns) {
          let match;
          while ((match = regex.exec(code)) !== null) {
            tokens.push({
              type,
              start: match.index,
              end: match.index + match[0].length,
              value: match[0],
            });
          }
        }

        // æŒ‰èµ·å§‹ä½ç½®æ’åº
        tokens.sort((a, b) => a.start - b.start);

        // å»é™¤é‡å çš„ tokenï¼ˆä¿ç•™å…ˆåŒ¹é…åˆ°çš„ï¼‰
        // ä¾‹å¦‚ï¼šæ³¨é‡Šä¸­çš„å†’å·ä¸åº”è¯¥è¢« operator è§„åˆ™å†æ¬¡åŒ¹é…
        const filteredTokens = [];
        let lastEnd = 0;

        for (const token of tokens) {
          if (token.start >= lastEnd) {
            filteredTokens.push(token);
            lastEnd = token.end;
          }
        }

        return filteredTokens;
      }

      /**
       * åº”ç”¨ CSS Highlights API è¿›è¡Œè¯­æ³•é«˜äº®
       * æ ¸å¿ƒæ€æƒ³ï¼šä¸åˆ›å»ºé¢å¤–çš„ DOM èŠ‚ç‚¹ï¼Œé€šè¿‡ Range å¯¹è±¡æ ‡è®°æ–‡æœ¬ä½ç½®
       * @param {HTMLElement} element - ç›®æ ‡å…ƒç´ 
       * @param {string} code - æºä»£ç 
       * @returns {Object} - åŒ…å«æ€§èƒ½æ•°æ®å’Œæ¸…ç†å‡½æ•°
       */
      function applyHighlights(element, code) {
        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ CSS Highlights API
        if (!CSS.highlights) {
          document.getElementById("browser-warning").classList.remove("hidden");
          return { time: 0, nodes: 0, cleanup: () => {} };
        }

        const startTime = performance.now();

        // æ¸…é™¤ä¹‹å‰çš„æ‰€æœ‰é«˜äº®
        CSS.highlights.clear();

        // å°†ä»£ç è®¾ç½®ä¸ºçº¯æ–‡æœ¬å†…å®¹ï¼ˆåªæœ‰ä¸€ä¸ª text nodeï¼‰
        element.textContent = code;

        const textNode = element.firstChild;
        if (!textNode) return { time: 0, nodes: 0, cleanup: () => {} };

        // è·å–æ‰€æœ‰ token
        const tokens = tokenize(code);

        // æŒ‰ token ç±»å‹åˆ†ç»„ï¼Œæ¯ç§ç±»å‹å¯¹åº”ä¸€ä¸ª Highlight å¯¹è±¡
        const tokensByType = new Map();
        for (const token of tokens) {
          if (!tokensByType.has(token.type)) {
            tokensByType.set(token.type, []);
          }

          // åˆ›å»º Range å¯¹è±¡æ ‡è®° token åœ¨æ–‡æœ¬ä¸­çš„ä½ç½®
          // å…³é”®ï¼šRange åªæ˜¯æ ‡è®°ä½ç½®ï¼Œä¸ä¿®æ”¹ DOM ç»“æ„
          const range = new Range();
          range.setStart(textNode, token.start);
          range.setEnd(textNode, token.end);
          tokensByType.get(token.type).push(range);
        }

        // ä¸ºæ¯ç§ token ç±»å‹æ³¨å†Œ Highlight
        // CSS ä¸­çš„ ::highlight(keyword)ã€::highlight(string) ç­‰ä¼šåŒ¹é…è¿™é‡Œæ³¨å†Œçš„åç§°
        for (const [type, ranges] of tokensByType) {
          const highlight = new Highlight(...ranges);
          CSS.highlights.set(type, highlight);
        }

        const endTime = performance.now();

        return {
          time: (endTime - startTime).toFixed(2),
          nodes: countNodes(element),
          cleanup: () => CSS.highlights.clear(),
        };
      }

      /**
       * åº”ç”¨ä¼ ç»Ÿçš„åŸºäº DOM çš„è¯­æ³•é«˜äº®
       * ä¼ ç»Ÿæ–¹æ³•ï¼šä¸ºæ¯ä¸ª token åˆ›å»ºä¸€ä¸ª <span> å…ƒç´ 
       * @param {HTMLElement} element - ç›®æ ‡å…ƒç´ 
       * @param {string} code - æºä»£ç 
       * @returns {Object} - åŒ…å«æ€§èƒ½æ•°æ®
       */
      function applyTraditional(element, code) {
        const startTime = performance.now();

        const tokens = tokenize(code);
        let html = "";
        let lastIndex = 0;

        // éå†æ‰€æœ‰ tokenï¼Œæ„å»º HTML å­—ç¬¦ä¸²
        for (const token of tokens) {
          // æ·»åŠ  token ä¹‹å‰çš„æ™®é€šæ–‡æœ¬
          html += escapeHtml(code.substring(lastIndex, token.start));

          // ä¸º token åŒ…è£¹ span æ ‡ç­¾ï¼Œæ·»åŠ å¯¹åº”çš„ class
          // ç¼ºç‚¹ï¼šæ¯ä¸ª token éƒ½åˆ›å»ºä¸€ä¸ª DOM èŠ‚ç‚¹ï¼Œå¤§é‡ä»£ç ä¼šäº§ç”Ÿæ•°ç™¾ä¸ªèŠ‚ç‚¹
          html += `<span class="token-${token.type}">${escapeHtml(
            token.value
          )}</span>`;
          lastIndex = token.end;
        }

        // æ·»åŠ æœ€åçš„å‰©ä½™æ–‡æœ¬
        html += escapeHtml(code.substring(lastIndex));

        // å°† HTML å­—ç¬¦ä¸²æ’å…¥ DOMï¼ˆè§¦å‘æµè§ˆå™¨è§£æå’Œæ¸²æŸ“ï¼‰
        element.innerHTML = html;

        const endTime = performance.now();

        return {
          time: (endTime - startTime).toFixed(2),
          nodes: countNodes(element),
        };
      }

      /**
       * HTML è½¬ä¹‰å‡½æ•° - é˜²æ­¢ XSS æ”»å‡»
       */
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      /**
       * ç»Ÿè®¡ DOM èŠ‚ç‚¹æ•°é‡
       * ç”¨äºå¯¹æ¯”ä¸¤ç§æ–¹æ³•çš„å†…å­˜å ç”¨å·®å¼‚
       */
      function countNodes(element) {
        let count = 0;
        const walker = document.createTreeWalker(element, NodeFilter.SHOW_ALL);
        while (walker.nextNode()) count++;
        return count;
      }

      /**
       * æ›´æ–°æ€§èƒ½ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
       */
      function updateStats(highlightsResult, traditionalResult) {
        document.getElementById("highlights-nodes").textContent =
          highlightsResult.nodes;
        document.getElementById("traditional-nodes").textContent =
          traditionalResult.nodes;
        document.getElementById("highlights-time").textContent =
          highlightsResult.time + " ms";
        document.getElementById("traditional-time").textContent =
          traditionalResult.time + " ms";

        // è®¡ç®—æ€§èƒ½æå‡ç™¾åˆ†æ¯”
        const improvement = (
          ((traditionalResult.time - highlightsResult.time) /
            traditionalResult.time) *
          100
        ).toFixed(1);
        document.getElementById("improvement").textContent = improvement + "%";

        // è®¡ç®—å†…å­˜èŠ‚çœç™¾åˆ†æ¯”
        const memorySaved = (
          ((traditionalResult.nodes - highlightsResult.nodes) /
            traditionalResult.nodes) *
          100
        ).toFixed(1);
        document.getElementById("memory-saved").textContent = memorySaved + "%";
      }

      /**
       * æ¸²æŸ“ä»£ç å¹¶åº”ç”¨ä¸¤ç§é«˜äº®æ–¹æ³•
       */
      function renderCode() {
        const code = codeSamples[currentCodeIndex];
        const highlightsElement = document.getElementById("highlights-demo");
        const traditionalElement = document.getElementById("traditional-demo");

        // åˆ†åˆ«åº”ç”¨ä¸¤ç§æ–¹æ³•ï¼Œå¯¹æ¯”æ€§èƒ½å·®å¼‚
        const highlightsResult = applyHighlights(highlightsElement, code);
        const traditionalResult = applyTraditional(traditionalElement, code);

        updateStats(highlightsResult, traditionalResult);
      }

      /**
       * åˆ‡æ¢ä»£ç ç¤ºä¾‹
       */
      function changeCode() {
        currentCodeIndex = (currentCodeIndex + 1) % codeSamples.length;
        renderCode();
      }

      /**
       * é‡æ–°æµ‹é‡æ€§èƒ½
       */
      function remeasure() {
        renderCode();
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.addEventListener("DOMContentLoaded", renderCode);
    </script>
  </body>
</html>
